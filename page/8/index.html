<!DOCTYPE html>
<html lang="zh-cn">
<head>

<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<meta name="format-detection" content="telephone=no" />
<meta name="author" content="leek" />


    
     
        <meta name="google-site-verification" content="Vl02j4hnvtN2AJ3EfPjyvrHb191mbrnVtUlHgPUKBp0" />
    


<meta property="og:type" content="website">
<meta property="og:title" content="leek 自留地">
<meta property="og:url" content="https://imlike.cc/page/8/index.html">
<meta property="og:site_name" content="leek 自留地">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="leek">
<meta name="twitter:card" content="summary">

<link rel="apple-touch-icon" href= "/apple-touch-icon.png">


    <link rel="alternate" href="/atom.xml" title="leek 自留地" type="application/atom+xml">



    <link rel="shortcut icon" href="pics/g.jpg">



    <link href="//lf6-cdn-tos.bytecdntp.com/cdn/animate.css/3.5.1/animate.min.css" rel="stylesheet">



    <link href="//lf6-cdn-tos.bytecdntp.com/cdn/fancybox/2.1.5/jquery.fancybox.min.css" rel="stylesheet">



    <script src="//lf6-cdn-tos.bytecdntp.com/cdn/pace/1.0.2/pace.min.js"></script>
    <link href="//lf6-cdn-tos.bytecdntp.com/cdn/pace/1.0.2/themes/blue/pace-theme-minimal.css" rel="stylesheet">



<link rel="stylesheet" href="/css/style.css">



    <!-- 注释 -->
    <!-- <style> .article { opacity: 0;} </style> -->


<link href="//lf6-cdn-tos.bytecdntp.com/cdn/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet">


<title>leek 自留地</title>

<script src="//lf6-cdn-tos.bytecdntp.com/cdn/jquery/2.2.4/jquery.min.js"></script>
<script src="//lf6-cdn-tos.bytecdntp.com/cdn/clipboard.js/1.5.10/clipboard.min.js"></script>

<script>
    var yiliaConfig = {
        fancybox: true,
        animate: true,
        isHome: true,
        isPost: false,
        isArchive: false,
        isTag: false,
        isCategory: false,
        fancybox_js: "//lf6-cdn-tos.bytecdntp.com/cdn/fancybox/2.1.5/jquery.fancybox.min.js",
        scrollreveal: "//lf6-cdn-tos.bytecdntp.com/cdn/scrollReveal.js/3.1.4/scrollreveal.min.js",
        search: true
    }
</script>


    <script> yiliaConfig.jquery_ui = [false]; </script>



    <script> yiliaConfig.rootUrl = "\/";</script>






<meta name="generator" content="Hexo 5.2.0"></head>
<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
    <header id="header" class="inner">
        <a href="/" class="profilepic">
            <img src="https://pic.superbed.cn/item/5c9f2d213a213b04176522d4" class="animated zoomIn">
        </a>
        <hgroup>
          <h1 class="header-author"><a href="/"></a></h1>
        </hgroup>

        

        
            <form id="search-form">
            <input type="text" id="local-search-input" name="q" placeholder="search..." class="search form-control" autocomplete="off" autocorrect="off" searchonload="true" />
            <i class="fa fa-times" onclick="resetSearch()"></i>
            </form>
            <div id="local-search-result"></div>
            <p class='no-result'>No results found <i class='fa fa-spinner fa-pulse'></i></p>
        


        
            <div id="switch-btn" class="switch-btn">
                <div class="icon">
                    <div class="icon-ctn">
                        <div class="icon-wrap icon-house" data-idx="0">
                            <div class="birdhouse"></div>
                            <div class="birdhouse_holes"></div>
                        </div>
                        <div class="icon-wrap icon-ribbon hide" data-idx="1">
                            <div class="ribbon"></div>
                        </div>
                        
                        <div class="icon-wrap icon-link hide" data-idx="2">
                            <div class="loopback_l"></div>
                            <div class="loopback_r"></div>
                        </div>
                        
                        
                        <div class="icon-wrap icon-me hide" data-idx="3">
                            <div class="user"></div>
                            <div class="shoulder"></div>
                        </div>
                        
                    </div>
                    
                </div>
                <div class="tips-box hide">
                    <div class="tips-arrow"></div>
                    <ul class="tips-inner">
                        <li>菜单</li>
                        <li>标签</li>
                        
                        <li>友情链接</li>
                        
                        
                        <li>关于我</li>
                        
                    </ul>
                </div>
            </div>
        

        <div id="switch-area" class="switch-area">
            <div class="switch-wrap">
                <section class="switch-part switch-part1">
                    <nav class="header-menu">
                        <ul>
                        
                            <li><a href="/">主页</a></li>
                        
                            <li><a href="/archives/">所有文章</a></li>
                        
                            <li><a href="/tags/">标签云</a></li>
                        
                            <li><a href="/about/">关于我</a></li>
                        
                        </ul>
                    </nav>
                    <nav class="header-nav">
                        <ul class="social">
                            
                                <a class="fa Email" href="mailto:s@yandex.com" title="Email"></a>
                            
                                <a class="fa GitHub" target="_blank" rel="noopener" href="https://github.com/bigleek" title="GitHub"></a>
                            
                                <a class="fa RSS" href="/atom.xml" title="RSS"></a>
                            
                                <a class="fa Google" target="_blank" rel="noopener" href="https://plus.google.com/bigleekcode" title="Google"></a>
                            
                        </ul>
                    </nav>
                </section>
                
                
                <section class="switch-part switch-part2">
                    <div class="widget tagcloud" id="js-tagcloud">
                        <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Java/" rel="tag">Java</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Linux/" rel="tag">Linux</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Yelee/" rel="tag">Yelee</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Yilia/" rel="tag">Yilia</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/activiti/" rel="tag">activiti</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/alist/" rel="tag">alist</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/axios/" rel="tag">axios</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/binary/" rel="tag">binary</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ceph/" rel="tag">ceph</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/clickhouse/" rel="tag">clickhouse</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/cloud/" rel="tag">cloud</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/container/" rel="tag">container</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/deepin/" rel="tag">deepin</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/docker/" rel="tag">docker</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/elasticsearch/" rel="tag">elasticsearch</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/elasticsraech/" rel="tag">elasticsraech</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/es6/" rel="tag">es6</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/flyio/" rel="tag">flyio</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/gdal/" rel="tag">gdal</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/git/" rel="tag">git</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/github/" rel="tag">github</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/gitlab/" rel="tag">gitlab</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/gnome/" rel="tag">gnome</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/hexo/" rel="tag">hexo</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/hexo%E4%B8%BB%E9%A2%98/" rel="tag">hexo主题</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/intellj/" rel="tag">intellj</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/java/" rel="tag">java</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/jdk/" rel="tag">jdk</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/jenkins/" rel="tag">jenkins</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/k8s/" rel="tag">k8s</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/kibana/" rel="tag">kibana</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/kubernetes/" rel="tag">kubernetes</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/kuboard/" rel="tag">kuboard</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/linux/" rel="tag">linux</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mail/" rel="tag">mail</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/maven/" rel="tag">maven</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/nas/" rel="tag">nas</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/nginx/" rel="tag">nginx</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/no-ad/" rel="tag">no_ad</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/npm/" rel="tag">npm</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/onedrive/" rel="tag">onedrive</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/orientDb/" rel="tag">orientDb</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/php/" rel="tag">php</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/post/" rel="tag">post</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/postgres/" rel="tag">postgres</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/put/" rel="tag">put</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/repost/" rel="tag">repost</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/spotify/" rel="tag">spotify</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/spring/" rel="tag">spring</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/springboot/" rel="tag">springboot</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/springcloud/" rel="tag">springcloud</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/sublime/" rel="tag">sublime</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/thunderbolt/" rel="tag">thunderbolt</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ubuntu/" rel="tag">ubuntu</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/vmware/" rel="tag">vmware</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/vpn/" rel="tag">vpn</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/vscode/" rel="tag">vscode</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/vue/" rel="tag">vue</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/vue-cli/" rel="tag">vue-cli</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/webdav/" rel="tag">webdav</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/windows/" rel="tag">windows</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/wine/" rel="tag">wine</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/yandex/" rel="tag">yandex</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/zsh/" rel="tag">zsh</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E4%BA%91%E6%92%AD/" rel="tag">云播</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%86%85%E7%BD%91%E7%A9%BF%E9%80%8F/" rel="tag">内网穿透</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%8A%A0%E9%80%9F/" rel="tag">加速</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%9D%9A%E6%9E%9C%E4%BA%91/" rel="tag">坚果云</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%9F%9F%E5%90%8D/" rel="tag">域名</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%A4%A9%E7%BF%BC%E4%BA%91/" rel="tag">天翼云</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%BC%80%E5%8F%91/" rel="tag">开发</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%8E%A8%E8%8D%90/" rel="tag">推荐</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%90%9C%E7%8B%97%E8%BE%93%E5%85%A5%E6%B3%95/" rel="tag">搜狗输入法</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%90%AC%E5%AE%B6/" rel="tag">搬家</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%A0%91%E8%8E%93%E6%B4%BE/" rel="tag">树莓派</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%9F%A5%E8%AF%86%E7%AE%A1%E7%90%86/" rel="tag">知识管理</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%BD%91%E7%AB%99/" rel="tag">网站</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%85%BE%E8%AE%AF%E4%BA%91/" rel="tag">腾讯云</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%A7%86%E9%A2%91%E6%B5%81/" rel="tag">视频流</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%B5%84%E6%BA%90/" rel="tag">资源</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%BD%AC%E8%BD%BD/" rel="tag">转载</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%BD%AF%E4%BB%B6/" rel="tag">软件</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%BD%AF%E4%BB%B6%E9%85%8D%E7%BD%AE/" rel="tag">软件配置</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%82%AE%E4%BB%B6%E6%9C%8D%E5%8A%A1/" rel="tag">邮件服务</a></li></ul>
                    </div>
                </section>
                
                
                
                <section class="switch-part switch-part3">
                    <div id="js-friends">
                    
                      <a class="main-nav-link switch-friends-link" href="https://imlike.cc/page.html">镜像网站导航</a>
                    
                      <a class="main-nav-link switch-friends-link" target="_blank" rel="noopener" href="https://imcyc.cn/">Morty</a>
                    
                    </div>
                </section>
                

                
                
                <section class="switch-part switch-part4">
                
                    <div id="js-aboutme">平时零散的知识</div>
                </section>
                
            </div>
        </div>
    </header>                
</div>
    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
      <div class="overlay">
          <div class="slider-trigger"></div>
          <h1 class="header-author js-mobile-header hide"><a href="/" title="回到主页"></a></h1>
      </div>
    <div class="intrude-less">
        <header id="header" class="inner">
            <a href="/" class="profilepic">
                <img src="https://pic.superbed.cn/item/5c9f2d213a213b04176522d4" class="animated zoomIn">
            </a>
            <hgroup>
              <h1 class="header-author"><a href="/" title="回到主页"></a></h1>
            </hgroup>
            
            <nav class="header-menu">
                <ul>
                
                    <li><a href="/">主页</a></li>
                
                    <li><a href="/archives/">所有文章</a></li>
                
                    <li><a href="/tags/">标签云</a></li>
                
                    <li><a href="/about/">关于我</a></li>
                
                <div class="clearfix"></div>
                </ul>
            </nav>
            <nav class="header-nav">
                        <ul class="social">
                            
                                <a class="fa Email" target="_blank" href="mailto:s@yandex.com" title="Email"></a>
                            
                                <a class="fa GitHub" target="_blank" href="https://github.com/bigleek" title="GitHub"></a>
                            
                                <a class="fa RSS" target="_blank" href="/atom.xml" title="RSS"></a>
                            
                                <a class="fa Google" target="_blank" href="https://plus.google.com/bigleekcode" title="Google"></a>
                            
                        </ul>
            </nav>
        </header>                
    </div>
    <link class="menu-list" tags="标签" friends="友情链接" about="关于我"/>
</nav>
      <div class="body-wrap">
  
    <article id="post-jvm概念梳理" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/e430a961.html" class="article-date">
      <time datetime="2022-12-09T04:22:00.000Z" itemprop="datePublished">2022-12-09</time>
</a>


    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/e430a961.html">jvm概念梳理</a>
    </h1>
  

      </header>
      
    
        <div class="article-entry" itemprop="articleBody">
          
                
                            
                                  
                                  
                                  
                                  
                                  
                                  
                                  
                                  
                                  
                                  
                            
                                
                                <p><p>class文件 动态代理 静态代理</p>
<p>javac 编译 .java文件 为 class文件,后面.class文件转换为 机器指令</p>
<h2 id="现代CPU下程序运行"><a href="#现代CPU下程序运行" class="headerlink" title="现代CPU下程序运行"></a>现代CPU下程序运行</h2><p>多CPU –&gt;CPU寄存器 –&gt; 高速缓存cache –&gt; 内存RAM </p>
<p>
                              
                          
                    
              <!-- 
              
              <p>class文件 动态代理 静态代理</p>
<p>javac 编译 .java文件 为 class文件,后面.class文件转换为 机器指令</p>
<h2 id="现代CPU下程序运行"><a href="#现代CPU下程序运行" class="headerlink" title="现代CPU下程序运行"></a>现代CPU下程序运行</h2><p>多CPU –&gt;CPU寄存器 –&gt; 高速缓存cache –&gt; 内存RAM </p>
<p><img src="../img/v2-1a7b7bb752799b6c067a0eaca0a1a9b2_r.jpg" alt="img"></p>
<h3 id="缓存一致性"><a href="#缓存一致性" class="headerlink" title="缓存一致性"></a>缓存一致性</h3><p>多个线程可能不在一个CPU中运行,那么对于的变量可能不太一致,需要同步 volatile</p>
<h3 id="指令重排序"><a href="#指令重排序" class="headerlink" title="指令重排序"></a>指令重排序</h3><p>对编译的时候对代码进行重排序,优化执行的效率,但是是一个变量,多个线程去执行的时候也行会导致,执行的变量的问题,不是说这个重排序是错的比如说不相干的变量查询,可能在CPU执行过程中可能有先后顺序的差异.</p>
<h3 id="逃逸分析"><a href="#逃逸分析" class="headerlink" title="逃逸分析"></a>逃逸分析</h3><p>相当于 你方法内的变量 需要传递出去,给别人用,不是基础类型</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> StringBuffer <span class="title">craeteStringBuffer</span><span class="params">(String s1, String s2)</span> </span>&#123;</span><br><span class="line">    StringBuffer sb = <span class="keyword">new</span> StringBuffer();</span><br><span class="line">    sb.append(s1);</span><br><span class="line">    sb.append(s2);</span><br><span class="line">    <span class="keyword">return</span> sb;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">createStringBuffer</span><span class="params">(String s1, String s2)</span> </span>&#123;</span><br><span class="line">    StringBuffer sb = <span class="keyword">new</span> StringBuffer();</span><br><span class="line">    sb.append(s1);</span><br><span class="line">    sb.append(s2);</span><br><span class="line">    <span class="keyword">return</span> sb.toString();</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>





<p>第一段代码中的<code>sb</code>就逃逸了，而第二段代码中的<code>sb</code>就没有逃逸。</p>
<p>使用逃逸分析，编译器可以对代码做如下优化：</p>
<p>一、同步省略。如果一个对象被发现只能从一个线程被访问到，那么对于这个对象的操作可以不考虑同步。</p>
<p>二、将堆分配转化为栈分配。如果一个对象在子程序中被分配，要使指向该对象的指针永远不会逃逸，对象可能是栈分配的候选，而不是堆分配。</p>
<p>三、分离对象或标量替换。有的对象可能不需要作为一个连续的内存结构存在也可以被访问到，那么对象的部分（或全部）可以不存储在内存，而是存储在CPU寄存器中。</p>
<p>作者：HollisChuang<br>链接：<a target="_blank" rel="noopener" href="https://juejin.cn/post/6844903639308304397">https://juejin.cn/post/6844903639308304397</a><br>来源：稀土掘金<br>著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。</p>
<h2 id="逃逸分析优化"><a href="#逃逸分析优化" class="headerlink" title="逃逸分析优化"></a>逃逸分析优化</h2><p>针对上面第三点，当一个对象没有逃逸时，可以得到以下几个虚拟机的优化。</p>
<p><strong>1) 锁消除</strong></p>
<p>我们知道线程同步锁是非常牺牲性能的，当编译器确定当前对象只有当前线程使用，那么就会移除该对象的同步锁。</p>
<p>例如，StringBuffer 和 Vector 都是用 synchronized 修饰线程安全的，但大部分情况下，它们都只是在当前线程中用到，这样编译器就会优化移除掉这些锁操作。</p>
<p>锁消除的 JVM 参数如下：</p>
<ul>
<li>开启锁消除：-XX:+EliminateLocks</li>
<li>关闭锁消除：-XX:-EliminateLocks</li>
</ul>
<p>锁消除在 JDK8 中都是默认开启的，并且锁消除都要建立在逃逸分析的基础上。</p>
<p><strong>2) 标量替换</strong></p>
<p>首先要明白标量和聚合量，基础类型和对象的引用可以理解为标量，它们不能被进一步分解。而能被进一步分解的量就是聚合量，比如：对象。</p>
<p>对象是聚合量，它又可以被进一步分解成标量，将其成员变量分解为分散的变量，这就叫做标量替换。</p>
<p>这样，如果一个对象没有发生逃逸，那压根就不用创建它，只会在栈或者寄存器上创建它用到的成员标量，节省了内存空间，也提升了应用程序性能。</p>
<p>标量替换的 JVM 参数如下：</p>
<ul>
<li>开启标量替换：-XX:+EliminateAllocations</li>
<li>关闭标量替换：-XX:-EliminateAllocations</li>
<li>显示标量替换详情：-XX:+PrintEliminateAllocations</li>
</ul>
<p>标量替换同样在 JDK8 中都是默认开启的，并且都要建立在逃逸分析的基础上。</p>
<p><strong>3) 栈上分配</strong></p>
<p>当对象没有发生逃逸时，该对象就可以通过标量替换分解成成员标量分配在栈内存中，和方法的生命周期一致，随着栈帧出栈时销毁，减少了 GC 压力，提高了应用程序性能。</p>
<h2 id="happen-before原则"><a href="#happen-before原则" class="headerlink" title="happen-before原则"></a>happen-before原则</h2><ul>
<li><p>程序顺序规则：一个线程中的每个操作，happens-before于该线程中的任意后续操作。</p>
</li>
<li><p>监视器锁规则：对一个锁的解锁，happens-before于随后对这个锁的加锁。</p>
</li>
<li><p>volatile变量规则：对一个volatile域的写，happens-before于任意后续对这个volatile域的读。</p>
</li>
<li><p>传递性：如果A happens-before B，且B happens-before C，那么A happens-before C。</p>
</li>
</ul>
<h2 id="GC垃圾回收"><a href="#GC垃圾回收" class="headerlink" title="GC垃圾回收"></a>GC垃圾回收</h2><h3 id="定义垃圾"><a href="#定义垃圾" class="headerlink" title="定义垃圾"></a>定义垃圾</h3><ol>
<li>引用计数算法</li>
<li>可达性分析算法</li>
</ol>
<h3 id="内存中的分配"><a href="#内存中的分配" class="headerlink" title="内存中的分配"></a>内存中的分配</h3><p>主要是手机heap(堆内存)主要是堆内存最大,同时是零碎的不像 stack(栈内存)是在方法调用完或者方法的引用完后就自动回收的.</p>
<p>目前堆内存中主要是初始化好的对象实例,和对象实例的类里面的变量,</p>
<ul>
<li><p>虚拟机栈（栈帧中的本地变量表）中引用的对象</p>
</li>
<li><p>方法区中类静态属性引用的对象</p>
</li>
<li><p>方法区中常量引用的对象</p>
</li>
<li><p>本地方法栈中 JNI（即一般说的 Native 方法）引用的对象</p>
</li>
</ul>
<p>Java 堆(Java Heap)是JVM所管理的内存</p>
<p><img src="../img/image-20221209125328758.png" alt="image-20221209125328758"></p>
<h3 id="清除方式"><a href="#清除方式" class="headerlink" title="清除方式"></a>清除方式</h3><p>1.标记清除算法</p>
<p>…</p>
<p>2.复制算法</p>
<p>…</p>
<p>3.标记整理算法</p>
<p>…</p>
<p>参考链接: </p>
<ul>
<li><p><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/aA1eDYIUHuIfigTw2ffouw">咱们从头到尾说一次 Java 垃圾回收</a>  </p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/29881777">Java内存模型（JMM）总结 - 知乎</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://juejin.cn/post/6844903639308304397">深入理解Java中的逃逸分析 - 掘金</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/69136675">面试问我 Java 逃逸分析，瞬间被秒杀了。。 - 知乎</a></p>
</li>
</ul>

               -->
        </div>
        
    
    <div class="article-info article-info-index">
      
      

      <!--  -->


      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-java内存和系统内存以及栈和堆" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/a87a9ae1.html" class="article-date">
      <time datetime="2022-12-09T01:56:56.000Z" itemprop="datePublished">2022-12-09</time>
</a>


    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/a87a9ae1.html">java内存和系统内存以及栈和堆</a>
    </h1>
  

      </header>
      
    
        <div class="article-entry" itemprop="articleBody">
          
                
                            
                                  
                                  
                                  
                                  
                                  
                                  
                                  
                                  
                                  
                                  
                            
                                
                                <p><p>参考链接: <a target="_blank" rel="noopener" href="https://kylenxu.github.io/2019/06/17/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E7%9A%84%E5%A0%86%E3%80%81%E6%A0%88%E5%92%8C%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E7%9A%84%E5%A0%86%E5%86%85%E5%AD%98%E3%80%81%E6%A0%88%E5%86%85%E5%AD%98%E7%9A%84%E5%8C%BA%E5%88%AB/">数据结构的堆、栈和操作系统的堆内存、栈内存的区别 - Kylen的博客 | Kylen Blog</a></p>
<p>CPU 处理数据需要 寄存器但是仅仅是寄存器是不够的还需要外部的内存支持 这个时候就需要 </p>
<p>RAM的支持 stack 栈 ,支持push ,pop</p>
<p>
                              
                          
                    
              <!-- 
              
              <p>参考链接: <a target="_blank" rel="noopener" href="https://kylenxu.github.io/2019/06/17/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E7%9A%84%E5%A0%86%E3%80%81%E6%A0%88%E5%92%8C%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E7%9A%84%E5%A0%86%E5%86%85%E5%AD%98%E3%80%81%E6%A0%88%E5%86%85%E5%AD%98%E7%9A%84%E5%8C%BA%E5%88%AB/">数据结构的堆、栈和操作系统的堆内存、栈内存的区别 - Kylen的博客 | Kylen Blog</a></p>
<p>CPU 处理数据需要 寄存器但是仅仅是寄存器是不够的还需要外部的内存支持 这个时候就需要 </p>
<p>RAM的支持 stack 栈 ,支持push ,pop</p>
<p>类似于这个结构</p>
<p><img src="../img/image-20221209113726223.png" alt="image-20221209113726223"></p>
<p><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/79923/what-and-where-are-the-stack-and-heap#:~:text=Stack%3A,for%20memory%20leaks">stack over flow </a></p>
<h2 id="栈"><a href="#栈" class="headerlink" title="栈"></a>栈</h2><ul>
<li>就像堆一样存储在计算机 RAM 中。</li>
<li>在堆栈上创建的变量将超出范围并自动释放。</li>
<li>与堆上的变量相比，分配速度要快得多。</li>
<li>使用实际的堆栈数据结构实现。</li>
<li>存放本地数据，返回地址，用于参数传递。</li>
<li>当使用太多堆栈时可能会发生堆栈溢出（主要来自无限或太深的递归，非常大的分配）。</li>
<li>在堆栈上创建的数据可以在没有指针的情况下使用。</li>
<li>如果您确切地知道在编译之前需要分配多少数据并且它不是太大，那么您将使用堆栈。</li>
<li>通常在程序启动时已经确定了最大大小。</li>
</ul>
<h2 id="堆："><a href="#堆：" class="headerlink" title="堆："></a>堆：</h2><ul>
<li>就像堆栈一样存储在计算机 RAM 中。</li>
<li>在 C++ 中，堆上的变量必须手动销毁并且永远不会超出范围。 使用 delete、delete[] 或 free 释- 放数据。<br>与堆栈上的变量相比，分配速度较慢。</li>
<li>按需用于分配数据块供程序使用。</li>
<li>当有很多分配和释放时，可能会产生碎片。</li>
<li>在 C++ 或 C 中，在堆上创建的数据将通过指针指向并分别使用 new 或 malloc 进行分配。</li>
<li>如果请求分配的缓冲区太大，可能会出现分配失败。</li>
<li>如果您不确切知道在运行时需要多少数据或者需要分配大量数据，则可以使用堆。</li>
<li>负责内存泄漏。</li>
</ul>

               -->
        </div>
        
    
    <div class="article-info article-info-index">
      
      

      <!--  -->


      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-认证和权限" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/d573592c.html" class="article-date">
      <time datetime="2022-12-09T01:52:33.000Z" itemprop="datePublished">2022-12-09</time>
</a>


    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/d573592c.html">认证和权限</a>
    </h1>
  

      </header>
      
    
        <div class="article-entry" itemprop="articleBody">
          
                
                            
                                  
                                  
                                  
                                  
                                  
                                  
                                  
                                  
                                  
                                  
                            
                                
                                <p><p>参考文档:  <a target="_blank" rel="noopener" href="https://www.raosong.cc/2019/11/26/32.%E8%B0%88%E8%B0%88%E5%8D%95%E7%82%B9%E7%99%BB%E5%BD%95/">谈谈单点登录｜R_song’s blog</a></p>
<p><img src="../img/image-20221210173435164.png" alt="image-20221210173435164"></p>
<p>SAML</p>
<p>
                              
                          
                    
              <!-- 
              
              <p>参考文档:  <a target="_blank" rel="noopener" href="https://www.raosong.cc/2019/11/26/32.%E8%B0%88%E8%B0%88%E5%8D%95%E7%82%B9%E7%99%BB%E5%BD%95/">谈谈单点登录｜R_song’s blog</a></p>
<p><img src="../img/image-20221210173435164.png" alt="image-20221210173435164"></p>
<p>SAML</p>
<p><img src="../img/124011" alt="SAML 2.0 Flow"></p>
<p>OAuth2</p>
<p><img src="../img/1240" alt="image.png"></p>

               -->
        </div>
        
    
    <div class="article-info article-info-index">
      
      

      <!--  -->


      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-理解java的BIO-NIO-AIO" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/ff3a358d.html" class="article-date">
      <time datetime="2022-12-08T12:54:46.000Z" itemprop="datePublished">2022-12-08</time>
</a>


    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/ff3a358d.html">理解java的BIO/NIO/AIO</a>
    </h1>
  

      </header>
      
    
        <div class="article-entry" itemprop="articleBody">
          
                
                            
                                  
                                  
                                  
                                  
                                  
                                  
                                  
                                  
                                  
                                  
                            
                                
                                <p><p>在理解Java的BIO/NIO/AIO之前我们先梳理下linux的相关io概念,下面是参考的连接</p>
<p>我在网络上搜索相关io 有句话很熟悉  </p>
<p><strong>BIO 下的连接对应一个线程</strong>  , <strong>NIO 下的请求对应一个线程</strong> ,  <strong>AIO下的有效请求对应一个线程</strong></p>
<p>
                              
                          
                    
              <!-- 
              
              <p>在理解Java的BIO/NIO/AIO之前我们先梳理下linux的相关io概念,下面是参考的连接</p>
<p>我在网络上搜索相关io 有句话很熟悉  </p>
<p><strong>BIO 下的连接对应一个线程</strong>  , <strong>NIO 下的请求对应一个线程</strong> ,  <strong>AIO下的有效请求对应一个线程</strong></p>
<ul>
<li>BIO：线程发起 IO 请求，不管内核是否准备好 IO 操作，从发起请求起，线程一直阻塞，直到操作完成。</li>
<li>NIO：客户端发送的连接请求都会注册到多路复用器上，多路复用器轮询到连接有 I/O 请求时才启动一个线程进行处理。</li>
<li>AIO：线程发起 IO 请求，立即返回；内存做好 IO 操作的准备之后，做 IO 操作，直到操作完成或者失败，通过调用注册的回调函数通知线程做 IO 操作完成或者失败。</li>
</ul>
<p>请求可以是读写都会创建对应线程处理,而有效请求着是 处理完对应io操作后才会调用对应的线程去操作</p>
<p>netty介绍<br><a target="_blank" rel="noopener" href="http://thoreauz.com/2019/01/19/rpc1-netty-reactor/">RPC一-线程模型 · 造舟野渡</a></p>
<p><a target="_blank" rel="noopener" href="http://thoreauz.com/2019/01/19/rpc2-netty-handler/">RPC二-NettyHandler处理消息 · 造舟野渡</a><br><a target="_blank" rel="noopener" href="http://thoreauz.com/2019/01/19/rpc3-protocol-e-decode/">RPC三-rpc协议和编解码 · 造舟野渡</a><br><a target="_blank" rel="noopener" href="http://thoreauz.com/2019/01/19/rpc4-netty-chain-of-responsibility-pattern/">RPC四-netty异步双向责任链 · 造舟野渡</a><br><a target="_blank" rel="noopener" href="http://thoreauz.com/2019/01/19/rpc5-reliability/">RPC五-可靠性设计 · 造舟野渡</a><br><a target="_blank" rel="noopener" href="http://thoreauz.com/2019/01/19/rpc6-dynamic-proxy/">RPC六-动态代理 · 造舟野渡</a></p>
<p>Java io相关内容 </p>
<p><a target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000037714804">java - 理解什么是BIO/NIO/AIO_个人文章 - SegmentFault 思否</a></p>
<p><a target="_blank" rel="noopener" href="https://alibaba-cloud.medium.com/essential-technologies-for-java-developers-i-o-and-netty-ec765676fd21">Java Development: BIO, NIO, AIO and Netty | Medium</a></p>
<p>linux io的相关链接</p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/jmcui/p/14145488.html">套接字 socket 和 tcp 连接过程 - JMCui - 博客园</a></p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/jmcui/p/14132849.html">网络 IO 模型简单介绍 - JMCui - 博客园</a></p>

               -->
        </div>
        
    
    <div class="article-info article-info-index">
      
      

      <!--  -->


      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-github-gitlab相关的操作" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/f1f7a0f1.html" class="article-date">
      <time datetime="2022-12-04T06:08:17.000Z" itemprop="datePublished">2022-12-04</time>
</a>


    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/f1f7a0f1.html">github，gitlab相关的操作</a>
    </h1>
  

      </header>
      
    
        <div class="article-entry" itemprop="articleBody">
          
                
                            
                                  
                                  
                                  
                                  
                                  
                                  
                                  
                                  
                                  
                                  
                            
                                
                                <p><p><a target="_blank" rel="noopener" href="https://www.7ed.net/start/raw-cdn.html">Github RAW 加速服务 | 7ED</a></p>
<p><a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/1807308">提高国内访问 GitHub 的速度的 9 种方案 - 腾讯云开发者社区-腾讯云</a></p>
<blockquote>
<p>
                              
                          
                    
              <!-- 
              
              <p><a target="_blank" rel="noopener" href="https://www.7ed.net/start/raw-cdn.html">Github RAW 加速服务 | 7ED</a></p>
<p><a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/1807308">提高国内访问 GitHub 的速度的 9 种方案 - 腾讯云开发者社区-腾讯云</a></p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://raw.githubusercontent.com/SpotX-CLI/SpotX-Win/main/Install.ps1">https://raw.githubusercontent.com/SpotX-CLI/SpotX-Win/main/Install.ps1</a></p>
<p>在githubusercontent 后面添加个大写的   <strong>S</strong> -&gt;    <a target="_blank" rel="noopener" href="https://raw.githubusercontents.com/SpotX-CLI/SpotX-Win/main/Install.ps1">https://raw.githubusercontentS.com/SpotX-CLI/SpotX-Win/main/Install.ps1</a></p>
</blockquote>
<p><a target="_blank" rel="noopener" href="https://blog.frytea.com/archives/504/">无需代理直接加速各种 GitHub 资源拉取 | 国内镜像赋能 | 助力开发 - Frytea’s Blog</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/fastgh/fgit">fastgh/fgit: 加速100～3000倍的github.com</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/hunshcn/gh-proxy">hunshcn/gh-proxy: github release、archive以及项目文件的加速项目</a></p>
<p>举个例子现在需要clone某个GitHub的仓库或者是用某个shell脚本搭建某种服务</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git clone --single-branch --branch v1.4.9 https:&#x2F;&#x2F;github.com&#x2F;rook&#x2F;rook.git</span><br></pre></td></tr></table></figure>

<p>时常会返回下列错误</p>
<blockquote>
<p>正克隆到 ‘rook’…<br>error: RPC failed; result=35, HTTP code = 0<br>fatal: The remote end hung up unexpectedly</p>
</blockquote>
<p>亦或者是ssh连接失败访问失败连接超时这种，如果你手动去找GitHub镜像站费时间而且有些git clone是写在二进制文件里面不方便去一个一个修改，之前有用过修改linux服务器的hosts来实现加速访问但是速度时好时坏，稳定性太差。</p>
<p>参考上面博主的文章我有了新想法，定义使用 fgit然后软连接 <strong>/usr/bin/git</strong></p>
<p>第二种就是</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git config --global url.&quot;https:&#x2F;&#x2F;gitclone.com&#x2F;github.com&quot;.insteadOf https:&#x2F;&#x2F;ghproxy.seekme.workers.dev</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://ghproxy.seekme.workers.dev/">https://ghproxy.seekme.workers.dev/</a> 这个是我参考上面的介绍搭建的加速站，目前下载文件没啥问题就是加clone加速还是有问题</p>
<p><a target="_blank" rel="noopener" href="https://hub.fastgit.xyz/rook/rook.git">https://hub.fastgit.xyz/rook/rook.git</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com.cnpmjs.org/rook/rook.git">https://github.com.cnpmjs.org/rook/rook.git</a></p>
<p><a target="_blank" rel="noopener" href="https://gitclone.com/github.com/rook/rook.git">https://gitclone.com/github.com/rook/rook.git</a></p>
<p><a target="_blank" rel="noopener" href="https://hub.fastgit.xyz/rook/rook.git">https://hub.fastgit.xyz/rook/rook.git</a> 速度最快</p>
<p>替换步骤</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># 方法二：配置git自动替换</span><br><span class="line">$ git config --global url.&quot;https:&#x2F;&#x2F;hub.fastgit.xyz&quot;.insteadOf https:&#x2F;&#x2F;github.com</span><br><span class="line"># 测试</span><br><span class="line">$ git clone --single-branch --branch v1.4.9 https:&#x2F;&#x2F;github.com&#x2F;rook&#x2F;rook.git</span><br><span class="line"># 查看git配置信息</span><br><span class="line">$ git config --global --list</span><br><span class="line"># 取消设置</span><br><span class="line">$ git config --global --unset url.https:&#x2F;&#x2F;github.com&#x2F;.insteadof</span><br></pre></td></tr></table></figure>



<p><img src="../img/image-20220216151406670.png" alt="image-20220216151406670"></p>
<h2 id="gitlab引用仓库里的图片"><a href="#gitlab引用仓库里的图片" class="headerlink" title="gitlab引用仓库里的图片"></a>gitlab引用仓库里的图片</h2><p>一起在typora上使用的引用相对位置的图片是</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">![image-20220127150651513](C:&#x2F;Program%20Files&#x2F;img&#x2F;image-20220127150651513.png)</span><br></pre></td></tr></table></figure>



<p>但是在gitlab不会去找相对位置的图片，很多人反馈在github这样写是可以在仓库readme上显示，但是在gitlab应该没优化，这边在StackOverflow上找到的解决方案是用&lt;&gt;括一下，确实可以实现，而且在语法是兼容的。</p>
<p><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/27016052/how-can-i-reference-an-image-in-gitlab-markdown-in-the-current-directory-with-th#:~:text=My%20images%20where,Mind%20the%20%3C%3E">StackOverflow的建议</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">![image-20220215103753937](&lt;C:&#x2F;Users&#x2F;Administrator&#x2F;Desktop&#x2F;img&#x2F;image-20220215103753937.png&gt;)</span><br></pre></td></tr></table></figure>


               -->
        </div>
        
    
    <div class="article-info article-info-index">
      
      

      <!-- 
    <div class="article-tag tagcloud">
        <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/git/" rel="tag">git</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/github/" rel="tag">github</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/gitlab/" rel="tag">gitlab</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%8A%A0%E9%80%9F/" rel="tag">加速</a></li></ul>
    </div>
 -->


      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-ananotation-async介绍和使用" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/3766dac5.html" class="article-date">
      <time datetime="2022-11-28T08:28:29.000Z" itemprop="datePublished">2022-11-28</time>
</a>


    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/3766dac5.html">ananotation_async介绍和使用</a>
    </h1>
  

      </header>
      
    
        <div class="article-entry" itemprop="articleBody">
          
                
                            
                                  
                                  
                                  
                                  
                                  
                                  
                            
                          
                    
              <!-- 
              
              <p><a target="_blank" rel="noopener" href="https://developer.aliyun.com/article/768513">Spring中异步注解@Async的使用、原理及使用时可能导致的问题-阿里云开发者社区</a></p>

               -->
        </div>
        
    
    <div class="article-info article-info-index">
      
      

      <!--  -->


      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-mysql-json函数使用" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/7c7b32f9.html" class="article-date">
      <time datetime="2022-11-23T12:07:46.000Z" itemprop="datePublished">2022-11-23</time>
</a>


    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/7c7b32f9.html">mysql_json函数使用</a>
    </h1>
  

      </header>
      
    
        <div class="article-entry" itemprop="articleBody">
          
                
                            
                                  
                                  
                                  
                                  
                                  
                                  
                                  
                                  
                                  
                                  
                            
                                
                                <p><p><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/57904266/how-to-use-mysql-json-contains-with-jpa-specification">How to use mysql “json_contains” with JPA Specification - Stack Overflow</a></p>
<p><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/36249828/how-to-search-json-array-in-mysql">How to search JSON array in MySQL? - Stack Overflow</a></p>
<p><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/66576018/mysql-json-extract-value-of-property-based-on-criteria">json - MySQL JSON_EXTRACT value of property based on criteria - Stack Overflow</a></p>
<p>
                              
                          
                    
              <!-- 
              
              <p><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/57904266/how-to-use-mysql-json-contains-with-jpa-specification">How to use mysql “json_contains” with JPA Specification - Stack Overflow</a></p>
<p><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/36249828/how-to-search-json-array-in-mysql">How to search JSON array in MySQL? - Stack Overflow</a></p>
<p><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/66576018/mysql-json-extract-value-of-property-based-on-criteria">json - MySQL JSON_EXTRACT value of property based on criteria - Stack Overflow</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/fenglailea/article/details/124687284">spring jpa function(函数) JSON_EXTRACT 复杂查询，jpa josn查询_风.foxwho的博客-CSDN博客_jpa json查询</a></p>
<p><a target="_blank" rel="noopener" href="https://www.docs4dev.com/docs/zh/mysql/5.7/reference/json-search-functions.html#function_json-contains">MySql 中文文档 - 12.17.3 搜索 JSON 值的函数 | Docs4dev</a></p>
<p>json字符串搜索模糊匹配等相关的内容</p>
<p>1.JSON_SEARCH 直接使用这个来查询还可以模糊匹配</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">	SELECT</span><br><span class="line">	JSON_SEARCH(</span><br><span class="line">&#39;[&#123;&quot;id&quot;:10002444,&quot;qrCode&quot;:&quot;44444417&quot;,&quot;sticker&quot;:&quot;44444416&quot;,&quot;deckId&quot;:&quot;N3MWSF52666&quot;,&quot;vehicleType&quot;:&quot;SCOOTER&quot;&#125;,&#123;&quot;id&quot;:10002444,&quot;qrCode&quot;:&quot;44444416&quot;,&quot;sticker&quot;:&quot;44444416&quot;,&quot;deckId&quot;:&quot;N3MWSF52666&quot;,&quot;vehicleType&quot;:&quot;SCOOTER&quot;&#125;]&#39;,</span><br><span class="line">		&#39;all&#39;,</span><br><span class="line">		&#39;%44444%&#39;,</span><br><span class="line">	NULL,</span><br><span class="line">	&#39;$**.sticker&#39;)</span><br></pre></td></tr></table></figure>




<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">SELECT * FROM incident_report WHERE (JSON_SEARCH(users,&#39;one&#39;,&#39;39717&#39;,null,&#39;$**.id&#39;) is not null)</span><br><span class="line">SELECT users FROM incident_report LIMIT 10  15890    qrCode  44444403</span><br><span class="line">SELECT JSON_SEARCH(users,&#39;one&#39;,&#39;%51230%&#39;,null,&#39;$**.qrCode&#39;) FROM incident_report LIMIT 10</span><br></pre></td></tr></table></figure>

<p> 2.JSON_EXTRACT(解析json数据),使用JSON_CONTAIN来查询 解析后的JSON信息</p>
<p>对对于是数组里面的特定对象字段譬如 下面这种,这需要进一步抽取</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[&#123;&quot;id&quot;:10002444,&quot;qrCode&quot;:&quot;44444417&quot;,&quot;sticker&quot;:&quot;44444416&quot;,&quot;deckId&quot;:&quot;N3MWSF52666&quot;,&quot;vehicleType&quot;:&quot;SCOOTER&quot;&#125;,&#123;&quot;id&quot;:10002444,&quot;qrCode&quot;:&quot;44444416&quot;,&quot;sticker&quot;:&quot;44444416&quot;,&quot;deckId&quot;:&quot;N3MWSF52666&quot;,&quot;vehicleType&quot;:&quot;SCOOTER&quot;&#125;]</span><br></pre></td></tr></table></figure>



<blockquote>
<p>JSON_CONTAINS(JSON_EXTRACT(json_field, ‘$[*].id’), 11, ‘$’)    </p>
</blockquote>
<pre><code>SELECT JSON_EXTRACT(users,&#39;$.id&#39;) FROM incident_report LIMIT 10
SELECT JSON_EXTRACT(users, &#39;$[*].userTrips[*].id&#39;) FROM incident_report LIMIT 10
SELECT users,JSON_CONTAINS(JSON_EXTRACT(users, &#39;$[*].userTrips[*].id&#39;), &#39;12689&#39;, &#39;$&#39;) FROM incident_report LIMIT 10</code></pre>
<p><a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/5.7/en/json-search-functions.html">https://dev.mysql.com/doc/refman/5.7/en/json-search-functions.html</a>)</p>

               -->
        </div>
        
    
    <div class="article-info article-info-index">
      
      

      <!--  -->


      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-spring缓存管理Redis-本地" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/a0b38034.html" class="article-date">
      <time datetime="2022-11-22T06:27:34.000Z" itemprop="datePublished">2022-11-22</time>
</a>


    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/a0b38034.html">spring缓存管理Redis+本地</a>
    </h1>
  

      </header>
      
    
        <div class="article-entry" itemprop="articleBody">
          
                
                            
                                  
                                  
                                  
                                  
                                  
                                  
                                  
                                  
                                  
                                  
                            
                                
                                <p><p><a target="_blank" rel="noopener" href="https://www.baeldung.com/spring-multiple-cache-managers">Using Multiple Cache Managers in Spring | Baeldung</a></p>
<p>caffice+redis</p>
<p>```java</p>
<p>
                              
                          
                    
              <!-- 
              
              <p><a target="_blank" rel="noopener" href="https://www.baeldung.com/spring-multiple-cache-managers">Using Multiple Cache Managers in Spring | Baeldung</a></p>
<p>caffice+redis</p>
<p>```java</p>

               -->
        </div>
        
    
    <div class="article-info article-info-index">
      
      

      <!--  -->


      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-transactionl介绍" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/f3616705.html" class="article-date">
      <time datetime="2022-11-21T06:03:48.000Z" itemprop="datePublished">2022-11-21</time>
</a>


    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/f3616705.html">transactionl介绍(转载)</a>
    </h1>
  

      </header>
      
    
        <div class="article-entry" itemprop="articleBody">
          
                
                            
                                  
                                  
                                  
                                  
                                  
                                  
                                  
                                  
                                  
                                  
                            
                                
                                <p><blockquote>
<p>🔗 原文链接： <a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/rvcb6xzBODqbCE03bwsKag">https://mp.weixin.qq.com/s/rvcb6xzB…</a></p>
</blockquote>
<p>
                              
                          
                    
              <!-- 
              
              <blockquote>
<p>🔗 原文链接： <a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/rvcb6xzBODqbCE03bwsKag">https://mp.weixin.qq.com/s/rvcb6xzB…</a></p>
</blockquote>
<blockquote>
<p>⏰ 剪存时间：2022-11-21 11:52:31 (UTC+8)</p>
</blockquote>
<blockquote>
<p>✂️ 本文档由 <a target="_blank" rel="noopener" href="https://www.feishu.cn/hc/zh-CN/articles/606278856233?from=in_ccm_clip_doc">飞书剪存 </a>一键生成</p>
</blockquote>
<p>veezean 石杉的架构笔记 <em>2022-11-16 07:50 发表于 江苏</em></p>
<p>「 关注 “石杉的架构笔记” ，大厂架构经验 倾囊相授 」</p>
<h2 id="文章来源：【公众号：架构悟道-】"><a href="#文章来源：【公众号：架构悟道-】" class="headerlink" title="文章来源：【公众号：架构悟道 】"></a><strong>文章来源：【公众号：架构悟道 】</strong></h2><p>在大部分涉及到数据库操作的项目里面， <strong>事务控制、事务处理都是一个无法回避的问题</strong> 。比如，需要对SQL执行过程进行事务的控制与处理的时候，其整体的处理流程会是如下的示意：</p>
<p><img src="https://jbfhxmeaps.feishu.cn/space/api/box/stream/download/asynccode/?code=MzllYTI1MTQ5ZjU1ODk1YWEwNTQ5MWNjMzljZWYyOTZfZzIzQ1pxaDR6d0ZoTDlxUVVKNnpqa01OamNiam1Kck1fVG9rZW46Ym94Y25hek01d0RUR1IwMDVqTmFNYnoxeUtiXzE2NjkwMTA2NTM6MTY2OTAxNDI1M19WNA" alt="img"></p>
<p>首先是要开启事务、然后执行具体SQL，如果执行异常则回滚事务，否则提交事务，最后关闭事务，完成整个处理过程。按照这个流程的逻辑，写一下对应的实现代码：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">public void testJdbcTransactional(DataSource dataSource) &#123;</span><br><span class="line">    Connection conn = null;</span><br><span class="line">    int result = 0;</span><br><span class="line">    try &#123;</span><br><span class="line">        // 获取链接</span><br><span class="line">        conn = dataSource.getConnection();</span><br><span class="line">        // 禁用自动事务提交，改为手动控制</span><br><span class="line">        conn.setAutoCommit(false);</span><br><span class="line">        // 设置事务隔离级别</span><br><span class="line">        conn.setTransactionIsolation(</span><br><span class="line">            TransactionIoslationLevel.READ_COMMITTED.getLevel()</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        // 执行SQL</span><br><span class="line">        PreparedStatement ps = </span><br><span class="line">            conn.prepareStatement(&quot;insert into user (id, name) values (?, ?)&quot;);</span><br><span class="line">        ps.setString(1, &quot;123456&quot;);</span><br><span class="line">        ps.setString(2, &quot;Tom&quot;);</span><br><span class="line">        result = ps.executeUpdate();</span><br><span class="line"></span><br><span class="line">        // 执行成功，手动提交事务</span><br><span class="line">        conn.commit();</span><br><span class="line">    &#125; catch (Exception e) &#123;</span><br><span class="line">        // 出现异常，手动回滚事务</span><br><span class="line">        if (conn != null) &#123;</span><br><span class="line">            try &#123;</span><br><span class="line">                conn.rollback();</span><br><span class="line">            &#125; catch (Exception e) &#123;</span><br><span class="line">                // write log...</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; finally &#123;</span><br><span class="line">        // 执行结束，最终不管成功还是失败，都要释放资源，断开连接</span><br><span class="line">        try &#123;</span><br><span class="line">            if (conn != null &amp;&amp; !conn.isClosed()) &#123;</span><br><span class="line">                conn.close();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">             // write log...</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>不难发现，上面大段的代码逻辑并不复杂，对于业务而言其实仅仅只是执行了一个insert操作而已。但是杂糅的事务控制代码，显然 <strong>干扰了业务自身的代码处理逻辑的阅读与理解</strong> 。</p>
<p>常规项目的代码中，涉及到DB处理的场景很多，如果每个地方都有这么一段事务控制的逻辑，那么整体代码的可维护性将会比较差，想想都令人窒息。</p>
<p><img src="https://jbfhxmeaps.feishu.cn/space/api/box/stream/download/asynccode/?code=YzYwOGYwNjM2Y2JlMTVmOTJhNjY0ZmY3YjE0M2MyNjVfSWZuQXc2ZFI2UjBzZjZZY0JKZHhiOUtSWU9UcGduU09fVG9rZW46Ym94Y25MMzAxVXhmakMzRjFZUHZQTFZTTkpjXzE2NjkwMTA2NTM6MTY2OTAxNDI1M19WNA" alt="img"></p>
<p>好在，JAVA中很多项目现在都是基于Spring框架进行构建的。得益 于 Spring框架的封装，业务代码中进行事务控制操作起来也很简单，直接加个 @Transactional注解即可，大大简化了对业务代码的 <strong>侵入性</strong> 。那么对 @Transactional事务注解了解的够全面吗？知道有哪些场景可能会导致 @Transactional注解并不会如你预期的方式生效吗？知道应该怎么使用 @Transactional才能保证对性能的影响最小化吗？</p>
<p>下面我们一起探讨下这些问题。</p>
<blockquote>
<p><strong>Spring声明式事务处理机制</strong></p>
</blockquote>
<blockquote>
</blockquote>
<blockquote>
</blockquote>
<blockquote>
</blockquote>
<p>为了简化业务开发场景对事务的处理复杂度，让开发人员可以更关注于业务自身的处理逻辑， <strong>Spring</strong> 提供了声明式事务的能力支持。</p>
<p><strong>Spring</strong> 数据库事务约定处理逻辑流程如下图所示，对比前面示例中基于 <strong><code>JDBC</code></strong> 的事务处理，Spring的事务的处理操作交给了 <strong>Spring框架</strong> 处理，开发人员仅需要实现自己的业务逻辑即可，大大简化了事务方面的处理投入。</p>
<p><img src="https://jbfhxmeaps.feishu.cn/space/api/box/stream/download/asynccode/?code=NzMxMjNhOGRhYTE5ZDU0NjIzM2RiZmYwZDI5Y2VmZDdfcTBjVGhoRFlpSU1HMzhuR2U3dWw0VWt5dDBBYWU0VlBfVG9rZW46Ym94Y25lZGZ3ZzRZWEUwMmlKT3ZuNUpadnRoXzE2NjkwMTA2NTM6MTY2OTAxNDI1M19WNA" alt="img"></p>
<p>基于Spring事务机制，实现上述DB操作事务控制的代码，我们的代码会变得非常的简洁：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">@Transactional</span><br><span class="line">public void insertUser() &#123;</span><br><span class="line">    userDao.insertUser();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>与JDBC事务实现代码相比，基于Spring的方式只需要添加一个 <strong><code>@Transactional</code></strong> 注解即可，代码中只需要实现业务逻辑即可，实现了事务控制机制对业务代码的 <strong>低侵入性</strong> 。</p>
<p>Spring支持的基于 <strong><code>Spring AOP</code></strong> 实现的 <strong>声明式事务</strong> 功能，所谓声明式事务，即使用@Transactional注解进行声明标注，告诉Spring框架在什么地方启用数据库事务控制能力。 <strong><code>@Transactional</code></strong> 注解， <em>可以添加在类或者方法上</em> 。如果其添加在类上时，表明此类中所有的 <em>public非静态方法</em> 都将启用事务控制能力。</p>
<p>既然@Transactional注解承载了Spring框架对于事务处理的相关能力，那么接下来我们就一起看下该注解的一些可选配置以及具体使用场景。</p>
<blockquote>
<p><strong>@Transactional主要可选配置</strong></p>
</blockquote>
<blockquote>
</blockquote>
<blockquote>
</blockquote>
<blockquote>
</blockquote>
<p>只读事务配置</p>
<p>通过 <strong><code>readonly</code></strong> 参数指定当前事务是否为一个只读事务。设置为true标识此事务是个只读事务，默认情况为false。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">@Transactional(readOnly = true)</span><br><span class="line">public DomResponse&lt;CiCdItemDetail&gt; queryCicdItemDetail(String appCode) &#123;</span><br><span class="line">    return null;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里涉及一个概念，叫做 <strong>只读事务</strong> ，其含义描述如下：</p>
<blockquote>
<p>在多条查询语句一起执行的场景里面会涉及到的概念。表示在事务设置的那一刻开始，到整个事务执行结束的过程中，其他事务所提交的写操作数据，对该事务都不可见。</p>
</blockquote>
<p>举个例子：</p>
<blockquote>
<p>现在有一个复合查询操作，包含2条SQL查询操作：先获取用户表count数，再获取用户表中所有数据。 (1) 先执行完获取用户表count数，得到结果10 (2) 在还没开始执行后一条语句的时候，另一个进程操作了DB并往用户表中插入一条新数据 (3) 复合操作的第二条SQL语句，获取用户列表的操作被执行，返回了11条记录</p>
</blockquote>
<p>很明显，复合操作中的两条SQL语句获取的数据结果无法匹配上。原因就是非原子性操作导致，即2条查询操作执行的间隔内，有另一个写操作修改了目标读取的数据，导致了此问题的出现。</p>
<p><img src="https://jbfhxmeaps.feishu.cn/space/api/box/stream/download/asynccode/?code=YzZhNzIwYWNhZWZkY2E1NWViMDE3MWJmYzQyZGY0YTlfV2t0R05OQXV1MmgzYlM4dUJtdnRObWRJckpqOThkQzhfVG9rZW46Ym94Y25zUTA3dkpQdmk5aXRtMXpNRWNVZURoXzE2NjkwMTA2NTM6MTY2OTAxNDI1M19WNA" alt="img"></p>
<p>为了避免此情况的发生，可以给复合查询操作添加上只读事务，这样事务控制范围内，事务外的写操作就不可见，这样就保证了事务内多条查询语句执行结果的一致性。</p>
<p>那为什么要设置为只读事务、而不是常规的事务呢？主要是从执行效率角度的考虑。因为这个里的操作都是一些只读操作，所以设置为只读事务，数据库会为只读事务提供一些优化手段，比如不启动回滚段、不记录回滚log之类的。</p>
<p>回滚条件设定</p>
<p><strong><code>@Transactional</code></strong> 有提供4个不同属性，可以支持传入不同的参数，设定需要回滚的条件：</p>
<table>
<thead>
<tr>
<th><strong>参数</strong></th>
<th><strong>含义说明</strong></th>
</tr>
</thead>
<tbody><tr>
<td>rollbackFor</td>
<td>用于指定需要回滚的特定异常类型，可以指定一个或者多个。当指定 <strong><code>rollbackFor</code></strong> 或者 <strong><code>rollbackForClassName</code></strong> 之后，方法执行逻辑中只有抛出指定的异常类型，才会触发事务回滚</td>
</tr>
<tr>
<td>rollbackForClassName</td>
<td>与 <strong><code>rollbackFor</code></strong> 相同，设置字符串格式的类名</td>
</tr>
<tr>
<td>noRollbackFor</td>
<td>用于指定不需要进行回滚的异常类型，当方法中抛出指定类型的异常时，不进行事务回滚。而其余的类型的异常将会触发事务回滚。</td>
</tr>
<tr>
<td>noRollbackForClassName</td>
<td>与 <strong><code>noRollbackFor</code></strong> 相同，设置字符串格式的类名</td>
</tr>
</tbody></table>
<p>其中，rollbackFor支持指定单个或者多个异常类型，只要抛出指定类型的异常，事务都将被回滚掉：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">// 指定单个异常</span><br><span class="line">@Transactional(rollbackFor = DemoException.class)</span><br><span class="line">public void insertUser() &#123;</span><br><span class="line">    // do something here</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 指定多个异常</span><br><span class="line">@Transactional(rollbackFor = &#123;DemoException.class, DemoException2.class&#125;)</span><br><span class="line">public void insertUser2() &#123;</span><br><span class="line">    // do something here</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong><code>rollbackFor</code></strong> 和 <strong><code>rollbackForClassName</code></strong> 作用相同，只是提供了2个不同的指定方法，允许执行Class类型或者ClassName字符串。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">// 指定异常名称</span><br><span class="line">@Transactional(rollbackForClassName = &#123;&quot;DemoException&quot;&#125;)</span><br><span class="line">public void insertUser() &#123;</span><br><span class="line">    // do something here</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>同理， <strong><code>noRollbackFor</code></strong> 和 <strong><code>noRollbackForClassName</code></strong> 的使用与上面示意的相似，只是其含义功能点是相反的。</p>
<p>事务传播行为</p>
<p><strong><code>propagation</code></strong> 用于指定此事务对应的传播类型。所谓的事务传播类型，即当前已经在一个事务的上下文中时，又需要开始一个事务，这个时候来处理这个将要开启的新事务的处理策略。</p>
<p>主要有7种类型的事务传播类型：</p>
<table>
<thead>
<tr>
<th><strong>传播类型</strong></th>
<th><strong>含义描述</strong></th>
</tr>
</thead>
<tbody><tr>
<td>REQUIRED</td>
<td>如果当前存在事务，则加入该事务；如果当前没有事务，则创建一个新的事务</td>
</tr>
<tr>
<td>SUPPORTS</td>
<td>如果当前存在事务，则加入该事务；如果当前没有事务，则以非事务的方式继续运行</td>
</tr>
<tr>
<td>MANDATORY</td>
<td>如果当前存在事务，则加入该事务；如果当前没有事务，则抛出异常</td>
</tr>
<tr>
<td>REQUIRES_NEW</td>
<td>创建一个新的事务，如果当前存在事务，则把当前事务挂起</td>
</tr>
<tr>
<td>NOT_SUPPORTED</td>
<td>以非事务方式运行，如果当前存在事务，则把当前事务挂起</td>
</tr>
<tr>
<td>NEVER</td>
<td>以非事务方式运行，如果当前存在事务，则抛出异常</td>
</tr>
<tr>
<td>NESTED</td>
<td>如果当前存在事务，则创建一个事务作为当前事务的嵌套事务来运行；如果当前没有事务，则该取值等价于REQUIRED</td>
</tr>
</tbody></table>
<p>事务的传播行为，将会影响到事务控制的结果，比如最终是在同一事务中，一旦遇到异常，所有操作都会被回滚掉，而如果是在多个事务中，则某一个事务的回滚，不影响已提交的其余事务的回滚。</p>
<p><img src="https://jbfhxmeaps.feishu.cn/space/api/box/stream/download/asynccode/?code=NDkyMDQ1OTg4NThmYWYzOGE5YjAxOTM2ODQzMDk0ZTVfRjhQUkNjcWhYUmRwNHlIUEFMNndkb3dxb3BSSnR2Wm1fVG9rZW46Ym94Y25rNTk2YWRHSFRrd2QwMlJJVTV2TlBiXzE2NjkwMTA2NTM6MTY2OTAxNDI1M19WNA" alt="img"></p>
<p>实际编码的时候，可以通过@Transactional注解中的 <strong><code>propagation</code></strong> 参数来指定具体的传播类型，取值由 <strong><code>org.springframework.transaction.annotation.Propagation</code></strong> 枚举类提供。如果不指定，则默认取值为 <strong><code>Propagation.REQUIRED</code></strong> ，也即 <strong>如果当前存在事务，则加入该事务，如果当前没有事务，则创建一个新的事务</strong> 。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * The transaction propagation type.</span><br><span class="line"> * &lt;p&gt;Defaults to &#123;@link Propagation#REQUIRED&#125;.</span><br><span class="line"> * @see org.springframework.transaction.interceptor.TransactionAttribute#getPropagationBehavior()</span><br><span class="line"> */</span><br><span class="line">Propagation propagation() default Propagation.REQUIRED;</span><br></pre></td></tr></table></figure>

<p>事务超时设定</p>
<p>可以使用 <strong><code>timeout</code></strong> 属性来设置事务的超时秒数，默认值为-1，表示永不超时。</p>
<blockquote>
<p><strong>@Transactional失效场景避坑</strong></p>
</blockquote>
<blockquote>
</blockquote>
<blockquote>
</blockquote>
<blockquote>
</blockquote>
<p>同一个类中方法间调用</p>
<p>Spring的事务实现原理是AOP，而AOP的原理是动态代理。</p>
<p><img src="https://jbfhxmeaps.feishu.cn/space/api/box/stream/download/asynccode/?code=NGNhYjZlYjJkOWIyNDFiZTI3ZWFkZjgyZmQ5YzA2NTBfdVRiRDBvQkNlZ00wWGROUmNKNW5jSEFwcldEdmkwNDVfVG9rZW46Ym94Y25HaDd6aUgxVTM2ZE1SWFk4d0F6UUVnXzE2NjkwMTA2NTM6MTY2OTAxNDI1M19WNA" alt="img"></p>
<p>在类内部方法之间相互调用的时候，本质上是类对象自身的调用，而不是使用代理对象去调用，也就不会触发AOP，这样其实Spring也就无法将事务控制的代码逻辑织入到调用代码流程中，所以这里的事务控制就无法生效。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">public void insertUser() &#123;</span><br><span class="line">    writeDataIntoDb();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@Transactional</span><br><span class="line">public void writeDataIntoDb() &#123;</span><br><span class="line">  // ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>所以遇到同一个类中多个方法之间相互调用，且调用的方法需要做事务控制的时候需要特别注意下这个问题。解决方式，可以建2个不同的类，然后将方法放到两个类中，这样跨类调用，Spring事务机制就可以生效。</p>
<p>添加在非public方法上</p>
<p>如果将@Transactional注解添加在protected、private修饰的方法上，虽然代码不会有任何的报错，但是实际上注解是不会生效的。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">@Transactional</span><br><span class="line">private void writeDataIntoDb() &#123;</span><br><span class="line">  // ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>方法内部Try Catch吞掉相关异常</p>
<p>这个其实很容易理解，业务代码中将所有的异常给catch并吞掉了，等同于业务代码认为被捕获的异常不需要去触发回滚。对框架而言，因为异常被捕获了，业务逻辑执行都在正常往下运行，所以也不会触发异常回滚机制。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">// catch了可能的异常，导致DB操作失败的时候事务不会触发回滚</span><br><span class="line">@Transactional</span><br><span class="line">public void insertUser() &#123;</span><br><span class="line">    try &#123;</span><br><span class="line">        UserEntity user = new UserEntity();</span><br><span class="line">        user.setWorkId(&quot;123456&quot;);</span><br><span class="line">        user.setUserName(&quot;王小二&quot;);</span><br><span class="line">        userRepository.save(user);</span><br><span class="line">    &#125; catch (Exception e) &#123;</span><br><span class="line">        log.error(&quot;failed to create user&quot;);</span><br><span class="line"></span><br><span class="line">        // 直接吞掉了异常，这样不会触发事务回滚机制</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在业务处理逻辑中，如果确实需要知晓并捕获相关处理的异常进行一些额外的业务逻辑处理，如果要保证事务回滚机制生效，最后需要往外抛出 <strong><code>RuntimeException</code></strong> 异常，或者是继承RuntimeException实现的 <em>业务自定义异常</em> 。如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">// catch了可能的异常，对外抛出RuntimeException或者其子类,可触发事务回滚</span><br><span class="line">@Transactional</span><br><span class="line">public void insertUser() &#123;</span><br><span class="line">    try &#123;</span><br><span class="line">        UserEntity user = new UserEntity();</span><br><span class="line">        user.setWorkId(&quot;123456&quot;);</span><br><span class="line">        user.setUserName(&quot;王小二&quot;);</span><br><span class="line">        userRepository.save(user);</span><br><span class="line">    &#125; catch (Exception e) &#123;</span><br><span class="line">        log.error(&quot;failed to create user&quot;);</span><br><span class="line"></span><br><span class="line">        // @Transactional没有指定rollbackFor，所以抛出RuntimeException或者其子类，可触发事务回滚机制</span><br><span class="line">        throw new RuntimeException(e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>当然，如果@Transactional注解指定了 <strong><code>rollbackFor</code></strong> 为某个具体的异常类型，则最终需要保证异常时对外抛出相匹配的异常类型，才可以触发事务处理逻辑。如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">// catch了指定异常，对外抛出对应类型的异常,可触发事务回滚</span><br><span class="line">@Transactional(rollbackFor = DemoException.class)</span><br><span class="line">public void insertUser() &#123;</span><br><span class="line">    try &#123;</span><br><span class="line">        UserEntity user = new UserEntity();</span><br><span class="line">        user.setWorkId(&quot;123456&quot;);</span><br><span class="line">        user.setUserName(&quot;王小二&quot;);</span><br><span class="line">        userRepository.save(user);</span><br><span class="line">    &#125; catch (Exception e) &#123;</span><br><span class="line">        log.error(&quot;failed to create user&quot;);</span><br><span class="line">        // @Transactional有指定rollbackFor，抛出异常要与rollbackFor指定异常类型一致</span><br><span class="line">        throw new DemoException();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>对应数据库引擎类型不支持事务</p>
<p>以 <strong>MySQL</strong> 数据库而言，常见的数据库引擎有 <strong><code>InnoDB</code></strong> 和 <strong><code>Myisam</code></strong> 等类型，但是 <strong>MYISAM引擎类型是不支持事务</strong> 的。所以如果建表时设置的引擎类型设置为 <strong><code>MYISAM</code></strong> 的话，即使代码里面添加了@Transactional最终事务也不会生效的。</p>
<blockquote>
<p><strong>@Transactional使用策略</strong></p>
</blockquote>
<blockquote>
</blockquote>
<blockquote>
</blockquote>
<blockquote>
</blockquote>
<p>因为事务处理对性能会有一定的影响，所以事务也不是说任何地方都可以随便添加的。对于一些性能敏感场景，需要注意几点：</p>
<ol>
<li>仅在必要的场合添加事务控制</li>
</ol>
<blockquote>
<p>（1）不含有DB操作相关，无需添加事务控制 （2）单条查询语句，没必要添加事务控制 （3）仅有查询操作的多条SQL执行场景，可以添加只读事务控制 （4）单条 <strong><code>insert/update/delete</code></strong> 语句，其实也不需要添加 <strong><code>@Transactional</code></strong> 事务处理，因为单条语句执行其实数据库有 <strong>隐性事务控制机制</strong> ，如果执行失败，是属于 <strong><code>SQL</code></strong> 报错，数据不会更新成功，自然也无需回滚。</p>
</blockquote>
<ol>
<li>尽可能缩小事务控制的代码段处理范围</li>
</ol>
<blockquote>
<p>主要从性能层面考虑，事务机制，类似于并发场景的加锁处理， <em>范围越大对性能影响越明显</em></p>
</blockquote>
<ol>
<li>事务控制范围内的业务逻辑尽可能简单、避免非事务相关耗时处理逻辑</li>
</ol>
<blockquote>
<p>也是从性能层面考虑，尽量将耗时的逻辑放到事务控制之外执行， <em>事务内仅保留与DB操作切实相关的逻辑</em></p>
</blockquote>
<p><img src="https://jbfhxmeaps.feishu.cn/space/api/box/stream/download/asynccode/?code=NjY0MzY1MzdmZTQzNGEwYTgzN2MyNjk0YWZmZmZiYmJfMHlQbVBNMmdab2VjMUJaU2NNQk51dFZuWjVvbTBqb1ZfVG9rZW46Ym94Y25nT29MU0szV2xLcEhKN28wMEk1S0dmXzE2NjkwMTA2NTM6MTY2OTAxNDI1M19WNA" alt="img"></p>
<p><img src="https://jbfhxmeaps.feishu.cn/space/api/box/stream/download/asynccode/?code=MTM0ZmRmMjFiNmEwYjc1Mzc1M2QzYmI4NjU4NTJiODRfMG1DTFJjZE1YNFJIeHBrZVBacklXcVk5UVVEaEZ0Z0tfVG9rZW46Ym94Y25nc2lqbUNpMDl6Z0tYRURtRFVTMkVkXzE2NjkwMTA2NTM6MTY2OTAxNDI1M19WNA" alt="img"></p>

               -->
        </div>
        
    
    <div class="article-info article-info-index">
      
      

      <!-- 
    <div class="article-tag tagcloud">
        <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/java/" rel="tag">java</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E8%BD%AC%E8%BD%BD/" rel="tag">转载</a></li></ul>
    </div>
 -->


      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-一次单元测试优化的过程总结" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/a6af0ce2.html" class="article-date">
      <time datetime="2022-11-20T09:54:12.000Z" itemprop="datePublished">2022-11-20</time>
</a>


    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/a6af0ce2.html">一次单元测试优化的过程总结(转载)</a>
    </h1>
  

      </header>
      
    
        <div class="article-entry" itemprop="articleBody">
          
                
                            
                                  
                                  
                                  
                                  
                                  
                                  
                                  
                                  
                                  
                                  
                            
                                
                                <p><p>🔗 原文链接： <a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/VdftYMXu">https://mp.weixin.qq.com/s/VdftYMXu</a>…<br>⏰ 剪存时间：2022-11-20 17:54:29 (UTC+8)<br>✂️ 本文档由 飞书剪存 一键生成<br>原创 李一飞（一骞） 大淘宝技术 2022-09-14 16:20 发表于 浙江</p>
<p>[图片]</p>
<p>本文将介绍淘宝用户运营平台团队最近在实践单元测试过程中遇到的一个问题。</p>
<p>
                              
                          
                    
              <!-- 
              
              <p>🔗 原文链接： <a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/VdftYMXu">https://mp.weixin.qq.com/s/VdftYMXu</a>…<br>⏰ 剪存时间：2022-11-20 17:54:29 (UTC+8)<br>✂️ 本文档由 飞书剪存 一键生成<br>原创 李一飞（一骞） 大淘宝技术 2022-09-14 16:20 发表于 浙江</p>
<p>[图片]</p>
<p>本文将介绍淘宝用户运营平台团队最近在实践单元测试过程中遇到的一个问题。</p>
<p>前言</p>
<p>淘宝原用户增长团队（现用户运营平台团队）是比较早践行单测增量覆盖率的团队，坚持了近两年下来，我们积累了数千个test case，在开发新功能、修改原功能的过程中帮助我们发现了许多问题，显著地提升了代码质量、减少线上故障。在这里郑重地向大家推荐，单测是值得认真做的，开头是痛苦的，但是积累一段时间后，量变就会带来质变。</p>
<p>言归正传，接下来谈一谈最近在实践单测过程中遇到的一个问题。在研发协同平台aone（下文简称aone）的发布流水线中，我们针对单元测试设置了增量代码覆盖率85%和test case 100%通过的流程卡点，在每次发布前，要保证test case完全通过才能提交工单。我们遇到了因并发导致的test case失败，调整并发度导致的单测时间过长，但又影响研发效能的问题。最终在并发度和成功率之间找到了一个平衡点，解决了单测流程降低研发效率的问题。</p>
<p>单侧流水线配置</p>
<p> 在单测流程中呢，我们主要用到了JUnit、JaCoCo和Surefire三套工具，通过aone提供的容器自动化运行单元测试，搜集测试报告。下面简单介绍一下这三个工具。</p>
<p>▐ JUnit</p>
<p>java界最大名鼎鼎的单元测试框架，无须多言，会java的应该都知道。</p>
<p>▐ JaCoCo</p>
<p>EclEmma团队开发的开源代码覆盖率统计工具，也是java业内最主流的代码覆盖率统计工具。增量代码覆盖率就是通过该工具进行统计的，全量、增量、按类、包统计都支持，非常灵活。</p>
<p>▐ Maven Surefire Plugin</p>
<p>surefire是maven的一个插件，在maven生命周期的test阶段执行单元测试用例。运行完成后还会生成测试报告，方便用户查看单测情况。</p>
<p>我们利用三种工具，加上aone提供的容器和流水线配置能力，完成了自动化单测的流程和发布卡点校验。</p>
<p>单元实践过程</p>
<p>▐ 两个阶段</p>
<p>积累test case时期</p>
<p>在刚刚开始单测时，大家新增的代码都相对比较独立，随着业务的发展、工作职责的调整，单测会不断变复杂，不同的service之间互相交织、单测的维护、运行成本都会增加。我们在这个阶段遇到了一个比较棘手的问题。日常开发过程中，单测都是以类为粒度在本地跑的，都能通过后再去流水线验证，一旦提交到流水线，就会遇到个别case失败的问题，一开始排查起来完全没有思路，test case的失败可以说是随机的，任何一个类的任何一个用例都有可能失败。</p>
<p>[图片]</p>
<p>经过分析和排查，得出结论是并发导致的，于是我们限制了并发，做了如下配置，确实解决了这个问题。</p>
<ul>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li><plugin>    <groupId>org.apache.maven.plugins</groupId>    <artifactId>maven-surefire-plugin</artifactId>    <version>2.16</version>    <configuration>        <reuseForks>false</reuseForks>        <forkCount>1</forkCount>    </configuration></plugin></li>
</ul>
<p>大家可以留意一下reuseForks和forkCount参数，这时候我们还没有深究两个配置的含义，只是简单的限制了并发，这也为后续的故事埋下了伏笔。</p>
<p>test case达到一定规模时期</p>
<p>在完成了test case的初始积累以后，新的问题又随之而来。因为没有并发，test case又很多，所以每次单测运行时长长达50分钟。也严重影响了大家的研发效率。在分秒必争的发布窗口期，经常会出现大家等着单测跑完提交发布单的情况。</p>
<p>[图片]</p>
<p>▐ 问题</p>
<p>看了上述两个不同阶段反映的问题，本质上就是成功率和实效性的trade off问题，如何能提高并发、提升运行速度的同时保障成功率，这就是我们需要解决的最终命题。</p>
<p>▐ 原理和解决方案 </p>
<p>上文提到了reuseForks和forkCount参数，这些都是maven-surefire-plugin提供的配置项，把surefire插件研究清楚了，应该就能解决如何兼顾速度和实效性的问 题。</p>
<p>Surefire配置详解</p>
<p>parallel<br>jvm内并行执行<br>通 过parallel参数开启，可选为methods，classes，both，suites等<br>其他参数</p>
<ol>
<li><p>useUnlimitedThreads，不限制线程数</p>
</li>
<li><p>threadCount，线程数</p>
</li>
<li><p>perCoreThreadCount，每核（默认true，和threadCount组合使用）</p>
</li>
<li><p>parallelTestsTimeoutInSeconds，timeout时间<br>注</p>
</li>
<li><p>设置了parallel后，useUnlimitedThreads或者threadCount必须设置一个，不然会报错</p>
</li>
<li><p>parallel级别还有suitesAndClasses等更复杂的配置项，本文不多探讨</p>
<p>参数示例如下，代表methods级别并发，10 条线程执行。</p>
</li>
</ol>
<ul>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li><plugins>      <plugin>        <groupId>org.apache.maven.plugins</groupId>        <artifactId>maven-surefire-plugin</artifactId>        <version>3.0.0-M7</version>        <configuration>          <parallel>methods</parallel>          <threadCount>10</threadCount>        </configuration>      </plugin></plugins></li>
</ul>
<p>fork<br>多jvm并行执行</p>
<ol>
<li>forkCount 最多同时生成的JVM个数，特殊语法是nC，代表n倍的CPU核数，2.5C在4核机器上就是10的意思。</li>
<li>reuseForks 是否重复使用fork出的JVM，true代表一个测试类运行完后，进程继续处理下一个，false代表一个类运行完了JVM销毁，重新生成新的JVM</li>
<li>默认配置 forkCount=1/reuseFork=true，forkCount设置为0会被自动替换为1</li>
</ol>
<p>parallel和fork<br>parallel和fork组合后，就可以有更好的并发效率，也会带来更大的冲突可能。</p>
<p>并发导致case失败原因</p>
<p>surefire的文档原文如下，</p>
<p>[图片]</p>
<p>简单说来，就是因为JUnit的实现机制，对于JVM内的线程并发，会出现一些race condition或者其他难以复现的问题；对于forkCount大于1且开启复用的情况，因为测试类是在复用的JVM内，也会因为相同的原因产生并发问题导致测试失败。</p>
<p>结果和建议</p>
<p>在彻底搞清楚surefire的配置原理后，我们回到问题来。经过各种排列组合的尝试，我们得出了比较合适的配置，reuseForks=true/ forkCount=2C，最终效果是每次运行时间在10分钟左右，出错概率较低，通过重跑也能解决。</p>
<p>[图片]</p>
<p>小tip<br>mvn默认是按模块串行的，可开启并行提高整体速度（例：mvn -T 1C clean test)，但是在我们的场景下，2000多个test case有1800个都在一个模块里，所以开启并行的效果不大。<br>其实这个问题没有最优组合，只有最合适的组合。 在优化了这个单测耗时最久的应用后，我们又分析了其他几个应用，有的应用test case不多，单测运行时长不长，就没有必要开启并发，优先保证成功率即可； 有的应用test case直接相互干扰较小，并发度可以调整得更高……<br>总的来说，在弄明白了原理之后，还需要具体情况具体分析，“纸上得来终觉浅，绝知此事要躬行”，大家可以分析一下自己应用的情况，结合surefire的并发机制进行实践，相信测过几次以后就能找到最合适的配置组合。</p>
<p>单元实践过程</p>
<p>在整个过程中，笔者还留有两个想法：</p>
<ol>
<li>有没有办法通过提高单测代码质量来避免或者降低因为并发引起的失败？一些思路是通过suite分组，将可能冲突的类分开跑，这样的做法可能会极大的提高单测开发成本，投入产出比不高。</li>
<li>test case通过率可以不用严格卡100%，设定到99.5%都能显著的提升效率，因为每次失败的test case是不固定的，所以偶发的个别问题不影响整体的回归。</li>
</ol>
<p>在实践卓越工程的过程中，笔者深切的感受到纵观整个软件研发的生命周期，有很多值得研究和切入的点，一些微小的改动，都能有效地提升研发效能和交付质量。在当前的环境下，业务竞争日趋激烈，所谓开源节流，“开源”难，重心就会偏向“节流”，降本增效一定会是下一个阶段的重点。而且对于技术人来说，效率一定是永远的追求。其实提升性能、效率往往不是特别高大上的事情，希望大家能在日常繁重的工作之余，有点时间做些有趣的研究，享受技术带来的快乐！</p>
<p>参考资料</p>
<ol>
<li><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/3365628/junit-tests-pass-in-eclipse-but-fail-in-maven-surefire">https://stackoverflow.com/questions/3365628/junit-tests-pass-in-eclipse-but-fail-in-maven-surefire</a></li>
<li><a target="_blank" rel="noopener" href="https://maven.apache.org/surefire/maven-surefire-plugin/examples/fork-options-and-parallel-execution.html">https://maven.apache.org/surefire/maven-surefire-plugin/examples/fork-options-and-parallel-execution.html</a></li>
<li><a target="_blank" rel="noopener" href="https://www.baeldung.com/maven-junit-parallel-tests">https://www.baeldung.com/maven-junit-parallel-tests</a></li>
</ol>
<p>团队介绍</p>
<p>大淘宝技术-用户平台技术团队<br>用户平台技术团队是一支集研发、数据、算法一体的团队，负责淘宝天猫的用户增长，游戏互动，平台会员和私域运营等消费者核心业务。在对用户争夺进入白热化的时期，团队正承担着捍卫电商主板块增长的重要使命，是阿里核心电商战场的参与者，用持续的技术创新来驱动阿里电商引擎的稳步前行。<br>这是一支年轻开放的团队，在这里你将收获超大规模高并发场景的架构设计能力，洞悉用户增长最前沿的实践方法，在数字化时代收获最核心的竞争力。团队技术氛围浓厚，倡导创新和工程师文化，鼓励用数据和代码发现解决问题。团队研发流程规范，代码质量高，学习成长速度快。</p>
<p>✿  拓展阅读</p>
<p>[图片]</p>
<p>[图片]</p>
<p>作者 | 李一飞（一骞）</p>
<p>编辑| 橙子君<br>[图片]</p>

               -->
        </div>
        
    
    <div class="article-info article-info-index">
      
      

      <!-- 
    <div class="article-tag tagcloud">
        <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/java/" rel="tag">java</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E8%BD%AC%E8%BD%BD/" rel="tag">转载</a></li></ul>
    </div>
 -->


      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
  
    <nav id="page-nav">
      <a class="extend prev" rel="prev" href="/page/7/"> 上一页</a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/6/">6</a><a class="page-number" href="/page/7/">7</a><span class="page-number current">8</span><a class="page-number" href="/page/9/">9</a><a class="page-number" href="/page/10/">10</a><span class="space">&hellip;</span><a class="page-number" href="/page/25/">25</a><a class="extend next" rel="next" href="/page/9/">下一页 </a>
    </nav>
  
</div>
      <footer id="footer">
    <div class="outer">
        <div id="footer-info">
            <div class="footer-left">
                <i class="fa fa-copyright"></i> 
                2016-2025 leek
            </div>
            <div class="footer-right">
                <a href="http://hexo.io/" target="_blank" title="快速、简洁且高效的博客框架">Hexo</a>  Theme <a href="https://github.com/MOxFIVE/hexo-theme-yelee" target="_blank" title="简而不减 Hexo 双栏博客主题  v3.5">Yelee</a> by leek <i class="fa fa-heart animated infinite pulse"></i>
            </div>
        </div>
        
            <div class="visit">
                
                    <span id="busuanzi_container_site_pv" style='display:none'>
                        <span id="site-visit" title="本站到访数"><i class="fa fa-user" aria-hidden="true"></i><span id="busuanzi_value_site_uv"></span>
                        </span>
                    </span>
                
                
                    <span>| </span>
                
                
                    <span id="busuanzi_container_page_pv" style='display:none'>
                        <span id="page-visit"  title="本页阅读量"><i class="fa fa-eye animated infinite pulse" aria-hidden="true"></i><span id="busuanzi_value_page_pv"></span>
                        </span>
                    </span>
                
            </div>
        
    </div>
</footer>
    </div>
    
<script data-main="/js/main.js" src="//lf6-cdn-tos.bytecdntp.com/cdn/require.js/2.2.0/require.min.js"></script>

    <script>
        $(document).ready(function() {
            var iPad = window.navigator.userAgent.indexOf('iPad');
            if (iPad > -1 || $(".left-col").css("display") === "none") {
                var bgColorList = ["#9db3f4", "#414141", "#e5a859", "#f5dfc6", "#c084a0", "#847e72", "#cd8390", "#996731"];
                var bgColor = Math.ceil(Math.random() * (bgColorList.length - 1));
                $("body").css({"background-color": bgColorList[bgColor], "background-size": "cover"});
            }
            else {
                var backgroundnum = 5;
                var backgroundimg = "url(/background/bg-x.jpg)".replace(/x/gi, Math.ceil(Math.random() * backgroundnum));
                $("body").css({"background": backgroundimg, "background-attachment": "fixed", "background-size": "cover"});
            }
        })
    </script>



<!-- Google Analytics -->
<script type="text/javascript">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-144246563-1', 'auto');
ga('send', 'pageview');

</script>
<!-- End Google Analytics -->



<div class="scroll" id="scroll">
    <a href="#" title="返回顶部"><i class="fa fa-arrow-up"></i></a>
    <a href="#comments" onclick="load$hide();" title="查看评论"><i class="fa fa-comments-o"></i></a>
    <a href="#footer" title="转到底部"><i class="fa fa-arrow-down"></i></a>
</div>
<script>
    // Open in New Window
    
        var oOpenInNew = {
            
            
            
             tags: ".article-tag a", 
             categories: ".article-category a, a.tag-list-link", 
            
            
            
            
             friends: "#js-friends a", 
             socail: ".social a" 
        }
        for (var x in oOpenInNew) {
            $(oOpenInNew[x]).attr("target", "_blank");
        }
    
</script>

    <script>
        var originTitle = document.title;
        var titleTime;
        document.addEventListener("visibilitychange", function() {
            if (document.hidden) {
                document.title = "(つェ⊂) 我藏好了哦~ " + originTitle;
                clearTimeout(titleTime);
            }
            else {
                document.title = "(*´∇｀*) 被你发现啦~ " + originTitle;
                titleTime = setTimeout(function() {
                    document.title = originTitle;
                }, 2000);
            }
        })
    </script>

<script async src="https://cdn.jsdelivr.net/gh/xaoxuu/cdn-busuanzi@2.3/js/busuanzi.pure.mini.js">
</script>
  </div>
</body>
</html>