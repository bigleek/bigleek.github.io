<!DOCTYPE html>
<html lang="zh-cn">
<head>

<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<meta name="format-detection" content="telephone=no" />
<meta name="author" content="leek" />


    
     
        <meta name="google-site-verification" content="Vl02j4hnvtN2AJ3EfPjyvrHb191mbrnVtUlHgPUKBp0" />
    


<meta property="og:type" content="website">
<meta property="og:title" content="leek 自留地">
<meta property="og:url" content="https://imlike.cc/page/8/index.html">
<meta property="og:site_name" content="leek 自留地">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="leek">
<meta name="twitter:card" content="summary">

<link rel="apple-touch-icon" href= "/apple-touch-icon.png">


    <link rel="alternate" href="/atom.xml" title="leek 自留地" type="application/atom+xml">



    <link rel="shortcut icon" href="pics/g.jpg">



    <link href="//lf6-cdn-tos.bytecdntp.com/cdn/animate.css/3.5.1/animate.min.css" rel="stylesheet">



    <link href="//lf6-cdn-tos.bytecdntp.com/cdn/fancybox/2.1.5/jquery.fancybox.min.css" rel="stylesheet">



    <script src="//lf6-cdn-tos.bytecdntp.com/cdn/pace/1.0.2/pace.min.js"></script>
    <link href="//lf6-cdn-tos.bytecdntp.com/cdn/pace/1.0.2/themes/blue/pace-theme-minimal.css" rel="stylesheet">



<link rel="stylesheet" href="/css/style.css">



    <!-- 注释 -->
    <!-- <style> .article { opacity: 0;} </style> -->


<link href="//lf6-cdn-tos.bytecdntp.com/cdn/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet">


<title>leek 自留地</title>

<script src="//lf6-cdn-tos.bytecdntp.com/cdn/jquery/2.2.4/jquery.min.js"></script>
<script src="//lf6-cdn-tos.bytecdntp.com/cdn/clipboard.js/1.5.10/clipboard.min.js"></script>

<script>
    var yiliaConfig = {
        fancybox: true,
        animate: true,
        isHome: true,
        isPost: false,
        isArchive: false,
        isTag: false,
        isCategory: false,
        fancybox_js: "//lf6-cdn-tos.bytecdntp.com/cdn/fancybox/2.1.5/jquery.fancybox.min.js",
        scrollreveal: "//lf6-cdn-tos.bytecdntp.com/cdn/scrollReveal.js/3.1.4/scrollreveal.min.js",
        search: true
    }
</script>


    <script> yiliaConfig.jquery_ui = [false]; </script>



    <script> yiliaConfig.rootUrl = "\/";</script>






<meta name="generator" content="Hexo 5.2.0"></head>
<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
    <header id="header" class="inner">
        <a href="/" class="profilepic">
            <img src="https://pic.superbed.cn/item/5c9f2d213a213b04176522d4" class="animated zoomIn">
        </a>
        <hgroup>
          <h1 class="header-author"><a href="/"></a></h1>
        </hgroup>

        

        
            <form id="search-form">
            <input type="text" id="local-search-input" name="q" placeholder="search..." class="search form-control" autocomplete="off" autocorrect="off" searchonload="true" />
            <i class="fa fa-times" onclick="resetSearch()"></i>
            </form>
            <div id="local-search-result"></div>
            <p class='no-result'>No results found <i class='fa fa-spinner fa-pulse'></i></p>
        


        
            <div id="switch-btn" class="switch-btn">
                <div class="icon">
                    <div class="icon-ctn">
                        <div class="icon-wrap icon-house" data-idx="0">
                            <div class="birdhouse"></div>
                            <div class="birdhouse_holes"></div>
                        </div>
                        <div class="icon-wrap icon-ribbon hide" data-idx="1">
                            <div class="ribbon"></div>
                        </div>
                        
                        <div class="icon-wrap icon-link hide" data-idx="2">
                            <div class="loopback_l"></div>
                            <div class="loopback_r"></div>
                        </div>
                        
                        
                        <div class="icon-wrap icon-me hide" data-idx="3">
                            <div class="user"></div>
                            <div class="shoulder"></div>
                        </div>
                        
                    </div>
                    
                </div>
                <div class="tips-box hide">
                    <div class="tips-arrow"></div>
                    <ul class="tips-inner">
                        <li>菜单</li>
                        <li>标签</li>
                        
                        <li>友情链接</li>
                        
                        
                        <li>关于我</li>
                        
                    </ul>
                </div>
            </div>
        

        <div id="switch-area" class="switch-area">
            <div class="switch-wrap">
                <section class="switch-part switch-part1">
                    <nav class="header-menu">
                        <ul>
                        
                            <li><a href="/">主页</a></li>
                        
                            <li><a href="/archives/">所有文章</a></li>
                        
                            <li><a href="/tags/">标签云</a></li>
                        
                            <li><a href="/about/">关于我</a></li>
                        
                        </ul>
                    </nav>
                    <nav class="header-nav">
                        <ul class="social">
                            
                                <a class="fa Email" href="mailto:s@yandex.com" title="Email"></a>
                            
                                <a class="fa GitHub" target="_blank" rel="noopener" href="https://github.com/bigleek" title="GitHub"></a>
                            
                                <a class="fa RSS" href="/atom.xml" title="RSS"></a>
                            
                                <a class="fa Google" target="_blank" rel="noopener" href="https://plus.google.com/bigleekcode" title="Google"></a>
                            
                        </ul>
                    </nav>
                </section>
                
                
                <section class="switch-part switch-part2">
                    <div class="widget tagcloud" id="js-tagcloud">
                        <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Java/" rel="tag">Java</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Linux/" rel="tag">Linux</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Yelee/" rel="tag">Yelee</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Yilia/" rel="tag">Yilia</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/activiti/" rel="tag">activiti</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/alist/" rel="tag">alist</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/axios/" rel="tag">axios</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/binary/" rel="tag">binary</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ceph/" rel="tag">ceph</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/clickhouse/" rel="tag">clickhouse</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/cloud/" rel="tag">cloud</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/container/" rel="tag">container</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/deepin/" rel="tag">deepin</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/docker/" rel="tag">docker</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/elasticsearch/" rel="tag">elasticsearch</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/elasticsraech/" rel="tag">elasticsraech</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/es6/" rel="tag">es6</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/flyio/" rel="tag">flyio</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/gdal/" rel="tag">gdal</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/git/" rel="tag">git</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/github/" rel="tag">github</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/gitlab/" rel="tag">gitlab</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/gnome/" rel="tag">gnome</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/hexo/" rel="tag">hexo</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/hexo%E4%B8%BB%E9%A2%98/" rel="tag">hexo主题</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/intellj/" rel="tag">intellj</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/java/" rel="tag">java</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/jdk/" rel="tag">jdk</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/jenkins/" rel="tag">jenkins</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/k8s/" rel="tag">k8s</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/kibana/" rel="tag">kibana</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/kubernetes/" rel="tag">kubernetes</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/kuboard/" rel="tag">kuboard</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/linux/" rel="tag">linux</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mail/" rel="tag">mail</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/maven/" rel="tag">maven</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/nas/" rel="tag">nas</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/nginx/" rel="tag">nginx</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/no-ad/" rel="tag">no_ad</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/npm/" rel="tag">npm</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/onedrive/" rel="tag">onedrive</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/orientDb/" rel="tag">orientDb</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/php/" rel="tag">php</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/post/" rel="tag">post</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/postgres/" rel="tag">postgres</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/put/" rel="tag">put</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/repost/" rel="tag">repost</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/spotify/" rel="tag">spotify</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/spring/" rel="tag">spring</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/springboot/" rel="tag">springboot</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/springcloud/" rel="tag">springcloud</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/sublime/" rel="tag">sublime</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/thunderbolt/" rel="tag">thunderbolt</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ubuntu/" rel="tag">ubuntu</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/vmware/" rel="tag">vmware</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/vpn/" rel="tag">vpn</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/vscode/" rel="tag">vscode</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/vue/" rel="tag">vue</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/vue-cli/" rel="tag">vue-cli</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/webdav/" rel="tag">webdav</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/windows/" rel="tag">windows</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/wine/" rel="tag">wine</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/yandex/" rel="tag">yandex</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/zsh/" rel="tag">zsh</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E4%BA%91%E6%92%AD/" rel="tag">云播</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%86%85%E7%BD%91%E7%A9%BF%E9%80%8F/" rel="tag">内网穿透</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%8A%A0%E9%80%9F/" rel="tag">加速</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%9D%9A%E6%9E%9C%E4%BA%91/" rel="tag">坚果云</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%9F%9F%E5%90%8D/" rel="tag">域名</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%A4%A9%E7%BF%BC%E4%BA%91/" rel="tag">天翼云</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%BC%80%E5%8F%91/" rel="tag">开发</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%8E%A8%E8%8D%90/" rel="tag">推荐</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%90%9C%E7%8B%97%E8%BE%93%E5%85%A5%E6%B3%95/" rel="tag">搜狗输入法</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%90%AC%E5%AE%B6/" rel="tag">搬家</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%A0%91%E8%8E%93%E6%B4%BE/" rel="tag">树莓派</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%9F%A5%E8%AF%86%E7%AE%A1%E7%90%86/" rel="tag">知识管理</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%BD%91%E7%AB%99/" rel="tag">网站</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%85%BE%E8%AE%AF%E4%BA%91/" rel="tag">腾讯云</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%A7%86%E9%A2%91%E6%B5%81/" rel="tag">视频流</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%B5%84%E6%BA%90/" rel="tag">资源</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%BD%AC%E8%BD%BD/" rel="tag">转载</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%BD%AF%E4%BB%B6/" rel="tag">软件</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%BD%AF%E4%BB%B6%E9%85%8D%E7%BD%AE/" rel="tag">软件配置</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%82%AE%E4%BB%B6%E6%9C%8D%E5%8A%A1/" rel="tag">邮件服务</a></li></ul>
                    </div>
                </section>
                
                
                
                <section class="switch-part switch-part3">
                    <div id="js-friends">
                    
                      <a class="main-nav-link switch-friends-link" href="https://imlike.cc/page.html">镜像网站导航</a>
                    
                      <a class="main-nav-link switch-friends-link" target="_blank" rel="noopener" href="https://imcyc.cn/">Morty</a>
                    
                    </div>
                </section>
                

                
                
                <section class="switch-part switch-part4">
                
                    <div id="js-aboutme">平时零散的知识</div>
                </section>
                
            </div>
        </div>
    </header>                
</div>
    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
      <div class="overlay">
          <div class="slider-trigger"></div>
          <h1 class="header-author js-mobile-header hide"><a href="/" title="回到主页"></a></h1>
      </div>
    <div class="intrude-less">
        <header id="header" class="inner">
            <a href="/" class="profilepic">
                <img src="https://pic.superbed.cn/item/5c9f2d213a213b04176522d4" class="animated zoomIn">
            </a>
            <hgroup>
              <h1 class="header-author"><a href="/" title="回到主页"></a></h1>
            </hgroup>
            
            <nav class="header-menu">
                <ul>
                
                    <li><a href="/">主页</a></li>
                
                    <li><a href="/archives/">所有文章</a></li>
                
                    <li><a href="/tags/">标签云</a></li>
                
                    <li><a href="/about/">关于我</a></li>
                
                <div class="clearfix"></div>
                </ul>
            </nav>
            <nav class="header-nav">
                        <ul class="social">
                            
                                <a class="fa Email" target="_blank" href="mailto:s@yandex.com" title="Email"></a>
                            
                                <a class="fa GitHub" target="_blank" href="https://github.com/bigleek" title="GitHub"></a>
                            
                                <a class="fa RSS" target="_blank" href="/atom.xml" title="RSS"></a>
                            
                                <a class="fa Google" target="_blank" href="https://plus.google.com/bigleekcode" title="Google"></a>
                            
                        </ul>
            </nav>
        </header>                
    </div>
    <link class="menu-list" tags="标签" friends="友情链接" about="关于我"/>
</nav>
      <div class="body-wrap">
  
    <article id="post-transactionl介绍" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/f3616705.html" class="article-date">
      <time datetime="2022-11-21T06:03:48.000Z" itemprop="datePublished">2022-11-21</time>
</a>


    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/f3616705.html">transactionl介绍(转载)</a>
    </h1>
  

      </header>
      
    
        <div class="article-entry" itemprop="articleBody">
          
                
                            
                                  
                                  
                                  
                                  
                                  
                                  
                                  
                                  
                                  
                                  
                            
                                
                                <p><blockquote>
<p>🔗 原文链接： <a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/rvcb6xzBODqbCE03bwsKag">https://mp.weixin.qq.com/s/rvcb6xzB…</a></p>
</blockquote>
<p>
                              
                          
                    
              <!-- 
              
              <blockquote>
<p>🔗 原文链接： <a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/rvcb6xzBODqbCE03bwsKag">https://mp.weixin.qq.com/s/rvcb6xzB…</a></p>
</blockquote>
<blockquote>
<p>⏰ 剪存时间：2022-11-21 11:52:31 (UTC+8)</p>
</blockquote>
<blockquote>
<p>✂️ 本文档由 <a target="_blank" rel="noopener" href="https://www.feishu.cn/hc/zh-CN/articles/606278856233?from=in_ccm_clip_doc">飞书剪存 </a>一键生成</p>
</blockquote>
<p>veezean 石杉的架构笔记 <em>2022-11-16 07:50 发表于 江苏</em></p>
<p>「 关注 “石杉的架构笔记” ，大厂架构经验 倾囊相授 」</p>
<h2 id="文章来源：【公众号：架构悟道-】"><a href="#文章来源：【公众号：架构悟道-】" class="headerlink" title="文章来源：【公众号：架构悟道 】"></a><strong>文章来源：【公众号：架构悟道 】</strong></h2><p>在大部分涉及到数据库操作的项目里面， <strong>事务控制、事务处理都是一个无法回避的问题</strong> 。比如，需要对SQL执行过程进行事务的控制与处理的时候，其整体的处理流程会是如下的示意：</p>
<p><img src="https://jbfhxmeaps.feishu.cn/space/api/box/stream/download/asynccode/?code=MzllYTI1MTQ5ZjU1ODk1YWEwNTQ5MWNjMzljZWYyOTZfZzIzQ1pxaDR6d0ZoTDlxUVVKNnpqa01OamNiam1Kck1fVG9rZW46Ym94Y25hek01d0RUR1IwMDVqTmFNYnoxeUtiXzE2NjkwMTA2NTM6MTY2OTAxNDI1M19WNA" alt="img"></p>
<p>首先是要开启事务、然后执行具体SQL，如果执行异常则回滚事务，否则提交事务，最后关闭事务，完成整个处理过程。按照这个流程的逻辑，写一下对应的实现代码：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">public void testJdbcTransactional(DataSource dataSource) &#123;</span><br><span class="line">    Connection conn = null;</span><br><span class="line">    int result = 0;</span><br><span class="line">    try &#123;</span><br><span class="line">        // 获取链接</span><br><span class="line">        conn = dataSource.getConnection();</span><br><span class="line">        // 禁用自动事务提交，改为手动控制</span><br><span class="line">        conn.setAutoCommit(false);</span><br><span class="line">        // 设置事务隔离级别</span><br><span class="line">        conn.setTransactionIsolation(</span><br><span class="line">            TransactionIoslationLevel.READ_COMMITTED.getLevel()</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        // 执行SQL</span><br><span class="line">        PreparedStatement ps = </span><br><span class="line">            conn.prepareStatement(&quot;insert into user (id, name) values (?, ?)&quot;);</span><br><span class="line">        ps.setString(1, &quot;123456&quot;);</span><br><span class="line">        ps.setString(2, &quot;Tom&quot;);</span><br><span class="line">        result = ps.executeUpdate();</span><br><span class="line"></span><br><span class="line">        // 执行成功，手动提交事务</span><br><span class="line">        conn.commit();</span><br><span class="line">    &#125; catch (Exception e) &#123;</span><br><span class="line">        // 出现异常，手动回滚事务</span><br><span class="line">        if (conn != null) &#123;</span><br><span class="line">            try &#123;</span><br><span class="line">                conn.rollback();</span><br><span class="line">            &#125; catch (Exception e) &#123;</span><br><span class="line">                // write log...</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; finally &#123;</span><br><span class="line">        // 执行结束，最终不管成功还是失败，都要释放资源，断开连接</span><br><span class="line">        try &#123;</span><br><span class="line">            if (conn != null &amp;&amp; !conn.isClosed()) &#123;</span><br><span class="line">                conn.close();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">             // write log...</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>不难发现，上面大段的代码逻辑并不复杂，对于业务而言其实仅仅只是执行了一个insert操作而已。但是杂糅的事务控制代码，显然 <strong>干扰了业务自身的代码处理逻辑的阅读与理解</strong> 。</p>
<p>常规项目的代码中，涉及到DB处理的场景很多，如果每个地方都有这么一段事务控制的逻辑，那么整体代码的可维护性将会比较差，想想都令人窒息。</p>
<p><img src="https://jbfhxmeaps.feishu.cn/space/api/box/stream/download/asynccode/?code=YzYwOGYwNjM2Y2JlMTVmOTJhNjY0ZmY3YjE0M2MyNjVfSWZuQXc2ZFI2UjBzZjZZY0JKZHhiOUtSWU9UcGduU09fVG9rZW46Ym94Y25MMzAxVXhmakMzRjFZUHZQTFZTTkpjXzE2NjkwMTA2NTM6MTY2OTAxNDI1M19WNA" alt="img"></p>
<p>好在，JAVA中很多项目现在都是基于Spring框架进行构建的。得益 于 Spring框架的封装，业务代码中进行事务控制操作起来也很简单，直接加个 @Transactional注解即可，大大简化了对业务代码的 <strong>侵入性</strong> 。那么对 @Transactional事务注解了解的够全面吗？知道有哪些场景可能会导致 @Transactional注解并不会如你预期的方式生效吗？知道应该怎么使用 @Transactional才能保证对性能的影响最小化吗？</p>
<p>下面我们一起探讨下这些问题。</p>
<blockquote>
<p><strong>Spring声明式事务处理机制</strong></p>
</blockquote>
<blockquote>
</blockquote>
<blockquote>
</blockquote>
<blockquote>
</blockquote>
<p>为了简化业务开发场景对事务的处理复杂度，让开发人员可以更关注于业务自身的处理逻辑， <strong>Spring</strong> 提供了声明式事务的能力支持。</p>
<p><strong>Spring</strong> 数据库事务约定处理逻辑流程如下图所示，对比前面示例中基于 <strong><code>JDBC</code></strong> 的事务处理，Spring的事务的处理操作交给了 <strong>Spring框架</strong> 处理，开发人员仅需要实现自己的业务逻辑即可，大大简化了事务方面的处理投入。</p>
<p><img src="https://jbfhxmeaps.feishu.cn/space/api/box/stream/download/asynccode/?code=NzMxMjNhOGRhYTE5ZDU0NjIzM2RiZmYwZDI5Y2VmZDdfcTBjVGhoRFlpSU1HMzhuR2U3dWw0VWt5dDBBYWU0VlBfVG9rZW46Ym94Y25lZGZ3ZzRZWEUwMmlKT3ZuNUpadnRoXzE2NjkwMTA2NTM6MTY2OTAxNDI1M19WNA" alt="img"></p>
<p>基于Spring事务机制，实现上述DB操作事务控制的代码，我们的代码会变得非常的简洁：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">@Transactional</span><br><span class="line">public void insertUser() &#123;</span><br><span class="line">    userDao.insertUser();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>与JDBC事务实现代码相比，基于Spring的方式只需要添加一个 <strong><code>@Transactional</code></strong> 注解即可，代码中只需要实现业务逻辑即可，实现了事务控制机制对业务代码的 <strong>低侵入性</strong> 。</p>
<p>Spring支持的基于 <strong><code>Spring AOP</code></strong> 实现的 <strong>声明式事务</strong> 功能，所谓声明式事务，即使用@Transactional注解进行声明标注，告诉Spring框架在什么地方启用数据库事务控制能力。 <strong><code>@Transactional</code></strong> 注解， <em>可以添加在类或者方法上</em> 。如果其添加在类上时，表明此类中所有的 <em>public非静态方法</em> 都将启用事务控制能力。</p>
<p>既然@Transactional注解承载了Spring框架对于事务处理的相关能力，那么接下来我们就一起看下该注解的一些可选配置以及具体使用场景。</p>
<blockquote>
<p><strong>@Transactional主要可选配置</strong></p>
</blockquote>
<blockquote>
</blockquote>
<blockquote>
</blockquote>
<blockquote>
</blockquote>
<p>只读事务配置</p>
<p>通过 <strong><code>readonly</code></strong> 参数指定当前事务是否为一个只读事务。设置为true标识此事务是个只读事务，默认情况为false。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">@Transactional(readOnly = true)</span><br><span class="line">public DomResponse&lt;CiCdItemDetail&gt; queryCicdItemDetail(String appCode) &#123;</span><br><span class="line">    return null;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里涉及一个概念，叫做 <strong>只读事务</strong> ，其含义描述如下：</p>
<blockquote>
<p>在多条查询语句一起执行的场景里面会涉及到的概念。表示在事务设置的那一刻开始，到整个事务执行结束的过程中，其他事务所提交的写操作数据，对该事务都不可见。</p>
</blockquote>
<p>举个例子：</p>
<blockquote>
<p>现在有一个复合查询操作，包含2条SQL查询操作：先获取用户表count数，再获取用户表中所有数据。 (1) 先执行完获取用户表count数，得到结果10 (2) 在还没开始执行后一条语句的时候，另一个进程操作了DB并往用户表中插入一条新数据 (3) 复合操作的第二条SQL语句，获取用户列表的操作被执行，返回了11条记录</p>
</blockquote>
<p>很明显，复合操作中的两条SQL语句获取的数据结果无法匹配上。原因就是非原子性操作导致，即2条查询操作执行的间隔内，有另一个写操作修改了目标读取的数据，导致了此问题的出现。</p>
<p><img src="https://jbfhxmeaps.feishu.cn/space/api/box/stream/download/asynccode/?code=YzZhNzIwYWNhZWZkY2E1NWViMDE3MWJmYzQyZGY0YTlfV2t0R05OQXV1MmgzYlM4dUJtdnRObWRJckpqOThkQzhfVG9rZW46Ym94Y25zUTA3dkpQdmk5aXRtMXpNRWNVZURoXzE2NjkwMTA2NTM6MTY2OTAxNDI1M19WNA" alt="img"></p>
<p>为了避免此情况的发生，可以给复合查询操作添加上只读事务，这样事务控制范围内，事务外的写操作就不可见，这样就保证了事务内多条查询语句执行结果的一致性。</p>
<p>那为什么要设置为只读事务、而不是常规的事务呢？主要是从执行效率角度的考虑。因为这个里的操作都是一些只读操作，所以设置为只读事务，数据库会为只读事务提供一些优化手段，比如不启动回滚段、不记录回滚log之类的。</p>
<p>回滚条件设定</p>
<p><strong><code>@Transactional</code></strong> 有提供4个不同属性，可以支持传入不同的参数，设定需要回滚的条件：</p>
<table>
<thead>
<tr>
<th><strong>参数</strong></th>
<th><strong>含义说明</strong></th>
</tr>
</thead>
<tbody><tr>
<td>rollbackFor</td>
<td>用于指定需要回滚的特定异常类型，可以指定一个或者多个。当指定 <strong><code>rollbackFor</code></strong> 或者 <strong><code>rollbackForClassName</code></strong> 之后，方法执行逻辑中只有抛出指定的异常类型，才会触发事务回滚</td>
</tr>
<tr>
<td>rollbackForClassName</td>
<td>与 <strong><code>rollbackFor</code></strong> 相同，设置字符串格式的类名</td>
</tr>
<tr>
<td>noRollbackFor</td>
<td>用于指定不需要进行回滚的异常类型，当方法中抛出指定类型的异常时，不进行事务回滚。而其余的类型的异常将会触发事务回滚。</td>
</tr>
<tr>
<td>noRollbackForClassName</td>
<td>与 <strong><code>noRollbackFor</code></strong> 相同，设置字符串格式的类名</td>
</tr>
</tbody></table>
<p>其中，rollbackFor支持指定单个或者多个异常类型，只要抛出指定类型的异常，事务都将被回滚掉：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">// 指定单个异常</span><br><span class="line">@Transactional(rollbackFor = DemoException.class)</span><br><span class="line">public void insertUser() &#123;</span><br><span class="line">    // do something here</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 指定多个异常</span><br><span class="line">@Transactional(rollbackFor = &#123;DemoException.class, DemoException2.class&#125;)</span><br><span class="line">public void insertUser2() &#123;</span><br><span class="line">    // do something here</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong><code>rollbackFor</code></strong> 和 <strong><code>rollbackForClassName</code></strong> 作用相同，只是提供了2个不同的指定方法，允许执行Class类型或者ClassName字符串。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">// 指定异常名称</span><br><span class="line">@Transactional(rollbackForClassName = &#123;&quot;DemoException&quot;&#125;)</span><br><span class="line">public void insertUser() &#123;</span><br><span class="line">    // do something here</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>同理， <strong><code>noRollbackFor</code></strong> 和 <strong><code>noRollbackForClassName</code></strong> 的使用与上面示意的相似，只是其含义功能点是相反的。</p>
<p>事务传播行为</p>
<p><strong><code>propagation</code></strong> 用于指定此事务对应的传播类型。所谓的事务传播类型，即当前已经在一个事务的上下文中时，又需要开始一个事务，这个时候来处理这个将要开启的新事务的处理策略。</p>
<p>主要有7种类型的事务传播类型：</p>
<table>
<thead>
<tr>
<th><strong>传播类型</strong></th>
<th><strong>含义描述</strong></th>
</tr>
</thead>
<tbody><tr>
<td>REQUIRED</td>
<td>如果当前存在事务，则加入该事务；如果当前没有事务，则创建一个新的事务</td>
</tr>
<tr>
<td>SUPPORTS</td>
<td>如果当前存在事务，则加入该事务；如果当前没有事务，则以非事务的方式继续运行</td>
</tr>
<tr>
<td>MANDATORY</td>
<td>如果当前存在事务，则加入该事务；如果当前没有事务，则抛出异常</td>
</tr>
<tr>
<td>REQUIRES_NEW</td>
<td>创建一个新的事务，如果当前存在事务，则把当前事务挂起</td>
</tr>
<tr>
<td>NOT_SUPPORTED</td>
<td>以非事务方式运行，如果当前存在事务，则把当前事务挂起</td>
</tr>
<tr>
<td>NEVER</td>
<td>以非事务方式运行，如果当前存在事务，则抛出异常</td>
</tr>
<tr>
<td>NESTED</td>
<td>如果当前存在事务，则创建一个事务作为当前事务的嵌套事务来运行；如果当前没有事务，则该取值等价于REQUIRED</td>
</tr>
</tbody></table>
<p>事务的传播行为，将会影响到事务控制的结果，比如最终是在同一事务中，一旦遇到异常，所有操作都会被回滚掉，而如果是在多个事务中，则某一个事务的回滚，不影响已提交的其余事务的回滚。</p>
<p><img src="https://jbfhxmeaps.feishu.cn/space/api/box/stream/download/asynccode/?code=NDkyMDQ1OTg4NThmYWYzOGE5YjAxOTM2ODQzMDk0ZTVfRjhQUkNjcWhYUmRwNHlIUEFMNndkb3dxb3BSSnR2Wm1fVG9rZW46Ym94Y25rNTk2YWRHSFRrd2QwMlJJVTV2TlBiXzE2NjkwMTA2NTM6MTY2OTAxNDI1M19WNA" alt="img"></p>
<p>实际编码的时候，可以通过@Transactional注解中的 <strong><code>propagation</code></strong> 参数来指定具体的传播类型，取值由 <strong><code>org.springframework.transaction.annotation.Propagation</code></strong> 枚举类提供。如果不指定，则默认取值为 <strong><code>Propagation.REQUIRED</code></strong> ，也即 <strong>如果当前存在事务，则加入该事务，如果当前没有事务，则创建一个新的事务</strong> 。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * The transaction propagation type.</span><br><span class="line"> * &lt;p&gt;Defaults to &#123;@link Propagation#REQUIRED&#125;.</span><br><span class="line"> * @see org.springframework.transaction.interceptor.TransactionAttribute#getPropagationBehavior()</span><br><span class="line"> */</span><br><span class="line">Propagation propagation() default Propagation.REQUIRED;</span><br></pre></td></tr></table></figure>

<p>事务超时设定</p>
<p>可以使用 <strong><code>timeout</code></strong> 属性来设置事务的超时秒数，默认值为-1，表示永不超时。</p>
<blockquote>
<p><strong>@Transactional失效场景避坑</strong></p>
</blockquote>
<blockquote>
</blockquote>
<blockquote>
</blockquote>
<blockquote>
</blockquote>
<p>同一个类中方法间调用</p>
<p>Spring的事务实现原理是AOP，而AOP的原理是动态代理。</p>
<p><img src="https://jbfhxmeaps.feishu.cn/space/api/box/stream/download/asynccode/?code=NGNhYjZlYjJkOWIyNDFiZTI3ZWFkZjgyZmQ5YzA2NTBfdVRiRDBvQkNlZ00wWGROUmNKNW5jSEFwcldEdmkwNDVfVG9rZW46Ym94Y25HaDd6aUgxVTM2ZE1SWFk4d0F6UUVnXzE2NjkwMTA2NTM6MTY2OTAxNDI1M19WNA" alt="img"></p>
<p>在类内部方法之间相互调用的时候，本质上是类对象自身的调用，而不是使用代理对象去调用，也就不会触发AOP，这样其实Spring也就无法将事务控制的代码逻辑织入到调用代码流程中，所以这里的事务控制就无法生效。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">public void insertUser() &#123;</span><br><span class="line">    writeDataIntoDb();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@Transactional</span><br><span class="line">public void writeDataIntoDb() &#123;</span><br><span class="line">  // ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>所以遇到同一个类中多个方法之间相互调用，且调用的方法需要做事务控制的时候需要特别注意下这个问题。解决方式，可以建2个不同的类，然后将方法放到两个类中，这样跨类调用，Spring事务机制就可以生效。</p>
<p>添加在非public方法上</p>
<p>如果将@Transactional注解添加在protected、private修饰的方法上，虽然代码不会有任何的报错，但是实际上注解是不会生效的。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">@Transactional</span><br><span class="line">private void writeDataIntoDb() &#123;</span><br><span class="line">  // ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>方法内部Try Catch吞掉相关异常</p>
<p>这个其实很容易理解，业务代码中将所有的异常给catch并吞掉了，等同于业务代码认为被捕获的异常不需要去触发回滚。对框架而言，因为异常被捕获了，业务逻辑执行都在正常往下运行，所以也不会触发异常回滚机制。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">// catch了可能的异常，导致DB操作失败的时候事务不会触发回滚</span><br><span class="line">@Transactional</span><br><span class="line">public void insertUser() &#123;</span><br><span class="line">    try &#123;</span><br><span class="line">        UserEntity user = new UserEntity();</span><br><span class="line">        user.setWorkId(&quot;123456&quot;);</span><br><span class="line">        user.setUserName(&quot;王小二&quot;);</span><br><span class="line">        userRepository.save(user);</span><br><span class="line">    &#125; catch (Exception e) &#123;</span><br><span class="line">        log.error(&quot;failed to create user&quot;);</span><br><span class="line"></span><br><span class="line">        // 直接吞掉了异常，这样不会触发事务回滚机制</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在业务处理逻辑中，如果确实需要知晓并捕获相关处理的异常进行一些额外的业务逻辑处理，如果要保证事务回滚机制生效，最后需要往外抛出 <strong><code>RuntimeException</code></strong> 异常，或者是继承RuntimeException实现的 <em>业务自定义异常</em> 。如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">// catch了可能的异常，对外抛出RuntimeException或者其子类,可触发事务回滚</span><br><span class="line">@Transactional</span><br><span class="line">public void insertUser() &#123;</span><br><span class="line">    try &#123;</span><br><span class="line">        UserEntity user = new UserEntity();</span><br><span class="line">        user.setWorkId(&quot;123456&quot;);</span><br><span class="line">        user.setUserName(&quot;王小二&quot;);</span><br><span class="line">        userRepository.save(user);</span><br><span class="line">    &#125; catch (Exception e) &#123;</span><br><span class="line">        log.error(&quot;failed to create user&quot;);</span><br><span class="line"></span><br><span class="line">        // @Transactional没有指定rollbackFor，所以抛出RuntimeException或者其子类，可触发事务回滚机制</span><br><span class="line">        throw new RuntimeException(e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>当然，如果@Transactional注解指定了 <strong><code>rollbackFor</code></strong> 为某个具体的异常类型，则最终需要保证异常时对外抛出相匹配的异常类型，才可以触发事务处理逻辑。如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">// catch了指定异常，对外抛出对应类型的异常,可触发事务回滚</span><br><span class="line">@Transactional(rollbackFor = DemoException.class)</span><br><span class="line">public void insertUser() &#123;</span><br><span class="line">    try &#123;</span><br><span class="line">        UserEntity user = new UserEntity();</span><br><span class="line">        user.setWorkId(&quot;123456&quot;);</span><br><span class="line">        user.setUserName(&quot;王小二&quot;);</span><br><span class="line">        userRepository.save(user);</span><br><span class="line">    &#125; catch (Exception e) &#123;</span><br><span class="line">        log.error(&quot;failed to create user&quot;);</span><br><span class="line">        // @Transactional有指定rollbackFor，抛出异常要与rollbackFor指定异常类型一致</span><br><span class="line">        throw new DemoException();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>对应数据库引擎类型不支持事务</p>
<p>以 <strong>MySQL</strong> 数据库而言，常见的数据库引擎有 <strong><code>InnoDB</code></strong> 和 <strong><code>Myisam</code></strong> 等类型，但是 <strong>MYISAM引擎类型是不支持事务</strong> 的。所以如果建表时设置的引擎类型设置为 <strong><code>MYISAM</code></strong> 的话，即使代码里面添加了@Transactional最终事务也不会生效的。</p>
<blockquote>
<p><strong>@Transactional使用策略</strong></p>
</blockquote>
<blockquote>
</blockquote>
<blockquote>
</blockquote>
<blockquote>
</blockquote>
<p>因为事务处理对性能会有一定的影响，所以事务也不是说任何地方都可以随便添加的。对于一些性能敏感场景，需要注意几点：</p>
<ol>
<li>仅在必要的场合添加事务控制</li>
</ol>
<blockquote>
<p>（1）不含有DB操作相关，无需添加事务控制 （2）单条查询语句，没必要添加事务控制 （3）仅有查询操作的多条SQL执行场景，可以添加只读事务控制 （4）单条 <strong><code>insert/update/delete</code></strong> 语句，其实也不需要添加 <strong><code>@Transactional</code></strong> 事务处理，因为单条语句执行其实数据库有 <strong>隐性事务控制机制</strong> ，如果执行失败，是属于 <strong><code>SQL</code></strong> 报错，数据不会更新成功，自然也无需回滚。</p>
</blockquote>
<ol>
<li>尽可能缩小事务控制的代码段处理范围</li>
</ol>
<blockquote>
<p>主要从性能层面考虑，事务机制，类似于并发场景的加锁处理， <em>范围越大对性能影响越明显</em></p>
</blockquote>
<ol>
<li>事务控制范围内的业务逻辑尽可能简单、避免非事务相关耗时处理逻辑</li>
</ol>
<blockquote>
<p>也是从性能层面考虑，尽量将耗时的逻辑放到事务控制之外执行， <em>事务内仅保留与DB操作切实相关的逻辑</em></p>
</blockquote>
<p><img src="https://jbfhxmeaps.feishu.cn/space/api/box/stream/download/asynccode/?code=NjY0MzY1MzdmZTQzNGEwYTgzN2MyNjk0YWZmZmZiYmJfMHlQbVBNMmdab2VjMUJaU2NNQk51dFZuWjVvbTBqb1ZfVG9rZW46Ym94Y25nT29MU0szV2xLcEhKN28wMEk1S0dmXzE2NjkwMTA2NTM6MTY2OTAxNDI1M19WNA" alt="img"></p>
<p><img src="https://jbfhxmeaps.feishu.cn/space/api/box/stream/download/asynccode/?code=MTM0ZmRmMjFiNmEwYjc1Mzc1M2QzYmI4NjU4NTJiODRfMG1DTFJjZE1YNFJIeHBrZVBacklXcVk5UVVEaEZ0Z0tfVG9rZW46Ym94Y25nc2lqbUNpMDl6Z0tYRURtRFVTMkVkXzE2NjkwMTA2NTM6MTY2OTAxNDI1M19WNA" alt="img"></p>

               -->
        </div>
        
    
    <div class="article-info article-info-index">
      
      

      <!-- 
    <div class="article-tag tagcloud">
        <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/java/" rel="tag">java</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E8%BD%AC%E8%BD%BD/" rel="tag">转载</a></li></ul>
    </div>
 -->


      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-一次单元测试优化的过程总结" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/a6af0ce2.html" class="article-date">
      <time datetime="2022-11-20T09:54:12.000Z" itemprop="datePublished">2022-11-20</time>
</a>


    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/a6af0ce2.html">一次单元测试优化的过程总结(转载)</a>
    </h1>
  

      </header>
      
    
        <div class="article-entry" itemprop="articleBody">
          
                
                            
                                  
                                  
                                  
                                  
                                  
                                  
                                  
                                  
                                  
                                  
                            
                                
                                <p><p>🔗 原文链接： <a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/VdftYMXu">https://mp.weixin.qq.com/s/VdftYMXu</a>…<br>⏰ 剪存时间：2022-11-20 17:54:29 (UTC+8)<br>✂️ 本文档由 飞书剪存 一键生成<br>原创 李一飞（一骞） 大淘宝技术 2022-09-14 16:20 发表于 浙江</p>
<p>[图片]</p>
<p>本文将介绍淘宝用户运营平台团队最近在实践单元测试过程中遇到的一个问题。</p>
<p>
                              
                          
                    
              <!-- 
              
              <p>🔗 原文链接： <a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/VdftYMXu">https://mp.weixin.qq.com/s/VdftYMXu</a>…<br>⏰ 剪存时间：2022-11-20 17:54:29 (UTC+8)<br>✂️ 本文档由 飞书剪存 一键生成<br>原创 李一飞（一骞） 大淘宝技术 2022-09-14 16:20 发表于 浙江</p>
<p>[图片]</p>
<p>本文将介绍淘宝用户运营平台团队最近在实践单元测试过程中遇到的一个问题。</p>
<p>前言</p>
<p>淘宝原用户增长团队（现用户运营平台团队）是比较早践行单测增量覆盖率的团队，坚持了近两年下来，我们积累了数千个test case，在开发新功能、修改原功能的过程中帮助我们发现了许多问题，显著地提升了代码质量、减少线上故障。在这里郑重地向大家推荐，单测是值得认真做的，开头是痛苦的，但是积累一段时间后，量变就会带来质变。</p>
<p>言归正传，接下来谈一谈最近在实践单测过程中遇到的一个问题。在研发协同平台aone（下文简称aone）的发布流水线中，我们针对单元测试设置了增量代码覆盖率85%和test case 100%通过的流程卡点，在每次发布前，要保证test case完全通过才能提交工单。我们遇到了因并发导致的test case失败，调整并发度导致的单测时间过长，但又影响研发效能的问题。最终在并发度和成功率之间找到了一个平衡点，解决了单测流程降低研发效率的问题。</p>
<p>单侧流水线配置</p>
<p> 在单测流程中呢，我们主要用到了JUnit、JaCoCo和Surefire三套工具，通过aone提供的容器自动化运行单元测试，搜集测试报告。下面简单介绍一下这三个工具。</p>
<p>▐ JUnit</p>
<p>java界最大名鼎鼎的单元测试框架，无须多言，会java的应该都知道。</p>
<p>▐ JaCoCo</p>
<p>EclEmma团队开发的开源代码覆盖率统计工具，也是java业内最主流的代码覆盖率统计工具。增量代码覆盖率就是通过该工具进行统计的，全量、增量、按类、包统计都支持，非常灵活。</p>
<p>▐ Maven Surefire Plugin</p>
<p>surefire是maven的一个插件，在maven生命周期的test阶段执行单元测试用例。运行完成后还会生成测试报告，方便用户查看单测情况。</p>
<p>我们利用三种工具，加上aone提供的容器和流水线配置能力，完成了自动化单测的流程和发布卡点校验。</p>
<p>单元实践过程</p>
<p>▐ 两个阶段</p>
<p>积累test case时期</p>
<p>在刚刚开始单测时，大家新增的代码都相对比较独立，随着业务的发展、工作职责的调整，单测会不断变复杂，不同的service之间互相交织、单测的维护、运行成本都会增加。我们在这个阶段遇到了一个比较棘手的问题。日常开发过程中，单测都是以类为粒度在本地跑的，都能通过后再去流水线验证，一旦提交到流水线，就会遇到个别case失败的问题，一开始排查起来完全没有思路，test case的失败可以说是随机的，任何一个类的任何一个用例都有可能失败。</p>
<p>[图片]</p>
<p>经过分析和排查，得出结论是并发导致的，于是我们限制了并发，做了如下配置，确实解决了这个问题。</p>
<ul>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li><plugin>    <groupId>org.apache.maven.plugins</groupId>    <artifactId>maven-surefire-plugin</artifactId>    <version>2.16</version>    <configuration>        <reuseForks>false</reuseForks>        <forkCount>1</forkCount>    </configuration></plugin></li>
</ul>
<p>大家可以留意一下reuseForks和forkCount参数，这时候我们还没有深究两个配置的含义，只是简单的限制了并发，这也为后续的故事埋下了伏笔。</p>
<p>test case达到一定规模时期</p>
<p>在完成了test case的初始积累以后，新的问题又随之而来。因为没有并发，test case又很多，所以每次单测运行时长长达50分钟。也严重影响了大家的研发效率。在分秒必争的发布窗口期，经常会出现大家等着单测跑完提交发布单的情况。</p>
<p>[图片]</p>
<p>▐ 问题</p>
<p>看了上述两个不同阶段反映的问题，本质上就是成功率和实效性的trade off问题，如何能提高并发、提升运行速度的同时保障成功率，这就是我们需要解决的最终命题。</p>
<p>▐ 原理和解决方案 </p>
<p>上文提到了reuseForks和forkCount参数，这些都是maven-surefire-plugin提供的配置项，把surefire插件研究清楚了，应该就能解决如何兼顾速度和实效性的问 题。</p>
<p>Surefire配置详解</p>
<p>parallel<br>jvm内并行执行<br>通 过parallel参数开启，可选为methods，classes，both，suites等<br>其他参数</p>
<ol>
<li><p>useUnlimitedThreads，不限制线程数</p>
</li>
<li><p>threadCount，线程数</p>
</li>
<li><p>perCoreThreadCount，每核（默认true，和threadCount组合使用）</p>
</li>
<li><p>parallelTestsTimeoutInSeconds，timeout时间<br>注</p>
</li>
<li><p>设置了parallel后，useUnlimitedThreads或者threadCount必须设置一个，不然会报错</p>
</li>
<li><p>parallel级别还有suitesAndClasses等更复杂的配置项，本文不多探讨</p>
<p>参数示例如下，代表methods级别并发，10 条线程执行。</p>
</li>
</ol>
<ul>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
<li><plugins>      <plugin>        <groupId>org.apache.maven.plugins</groupId>        <artifactId>maven-surefire-plugin</artifactId>        <version>3.0.0-M7</version>        <configuration>          <parallel>methods</parallel>          <threadCount>10</threadCount>        </configuration>      </plugin></plugins></li>
</ul>
<p>fork<br>多jvm并行执行</p>
<ol>
<li>forkCount 最多同时生成的JVM个数，特殊语法是nC，代表n倍的CPU核数，2.5C在4核机器上就是10的意思。</li>
<li>reuseForks 是否重复使用fork出的JVM，true代表一个测试类运行完后，进程继续处理下一个，false代表一个类运行完了JVM销毁，重新生成新的JVM</li>
<li>默认配置 forkCount=1/reuseFork=true，forkCount设置为0会被自动替换为1</li>
</ol>
<p>parallel和fork<br>parallel和fork组合后，就可以有更好的并发效率，也会带来更大的冲突可能。</p>
<p>并发导致case失败原因</p>
<p>surefire的文档原文如下，</p>
<p>[图片]</p>
<p>简单说来，就是因为JUnit的实现机制，对于JVM内的线程并发，会出现一些race condition或者其他难以复现的问题；对于forkCount大于1且开启复用的情况，因为测试类是在复用的JVM内，也会因为相同的原因产生并发问题导致测试失败。</p>
<p>结果和建议</p>
<p>在彻底搞清楚surefire的配置原理后，我们回到问题来。经过各种排列组合的尝试，我们得出了比较合适的配置，reuseForks=true/ forkCount=2C，最终效果是每次运行时间在10分钟左右，出错概率较低，通过重跑也能解决。</p>
<p>[图片]</p>
<p>小tip<br>mvn默认是按模块串行的，可开启并行提高整体速度（例：mvn -T 1C clean test)，但是在我们的场景下，2000多个test case有1800个都在一个模块里，所以开启并行的效果不大。<br>其实这个问题没有最优组合，只有最合适的组合。 在优化了这个单测耗时最久的应用后，我们又分析了其他几个应用，有的应用test case不多，单测运行时长不长，就没有必要开启并发，优先保证成功率即可； 有的应用test case直接相互干扰较小，并发度可以调整得更高……<br>总的来说，在弄明白了原理之后，还需要具体情况具体分析，“纸上得来终觉浅，绝知此事要躬行”，大家可以分析一下自己应用的情况，结合surefire的并发机制进行实践，相信测过几次以后就能找到最合适的配置组合。</p>
<p>单元实践过程</p>
<p>在整个过程中，笔者还留有两个想法：</p>
<ol>
<li>有没有办法通过提高单测代码质量来避免或者降低因为并发引起的失败？一些思路是通过suite分组，将可能冲突的类分开跑，这样的做法可能会极大的提高单测开发成本，投入产出比不高。</li>
<li>test case通过率可以不用严格卡100%，设定到99.5%都能显著的提升效率，因为每次失败的test case是不固定的，所以偶发的个别问题不影响整体的回归。</li>
</ol>
<p>在实践卓越工程的过程中，笔者深切的感受到纵观整个软件研发的生命周期，有很多值得研究和切入的点，一些微小的改动，都能有效地提升研发效能和交付质量。在当前的环境下，业务竞争日趋激烈，所谓开源节流，“开源”难，重心就会偏向“节流”，降本增效一定会是下一个阶段的重点。而且对于技术人来说，效率一定是永远的追求。其实提升性能、效率往往不是特别高大上的事情，希望大家能在日常繁重的工作之余，有点时间做些有趣的研究，享受技术带来的快乐！</p>
<p>参考资料</p>
<ol>
<li><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/3365628/junit-tests-pass-in-eclipse-but-fail-in-maven-surefire">https://stackoverflow.com/questions/3365628/junit-tests-pass-in-eclipse-but-fail-in-maven-surefire</a></li>
<li><a target="_blank" rel="noopener" href="https://maven.apache.org/surefire/maven-surefire-plugin/examples/fork-options-and-parallel-execution.html">https://maven.apache.org/surefire/maven-surefire-plugin/examples/fork-options-and-parallel-execution.html</a></li>
<li><a target="_blank" rel="noopener" href="https://www.baeldung.com/maven-junit-parallel-tests">https://www.baeldung.com/maven-junit-parallel-tests</a></li>
</ol>
<p>团队介绍</p>
<p>大淘宝技术-用户平台技术团队<br>用户平台技术团队是一支集研发、数据、算法一体的团队，负责淘宝天猫的用户增长，游戏互动，平台会员和私域运营等消费者核心业务。在对用户争夺进入白热化的时期，团队正承担着捍卫电商主板块增长的重要使命，是阿里核心电商战场的参与者，用持续的技术创新来驱动阿里电商引擎的稳步前行。<br>这是一支年轻开放的团队，在这里你将收获超大规模高并发场景的架构设计能力，洞悉用户增长最前沿的实践方法，在数字化时代收获最核心的竞争力。团队技术氛围浓厚，倡导创新和工程师文化，鼓励用数据和代码发现解决问题。团队研发流程规范，代码质量高，学习成长速度快。</p>
<p>✿  拓展阅读</p>
<p>[图片]</p>
<p>[图片]</p>
<p>作者 | 李一飞（一骞）</p>
<p>编辑| 橙子君<br>[图片]</p>

               -->
        </div>
        
    
    <div class="article-info article-info-index">
      
      

      <!-- 
    <div class="article-tag tagcloud">
        <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/java/" rel="tag">java</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E8%BD%AC%E8%BD%BD/" rel="tag">转载</a></li></ul>
    </div>
 -->


      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-自动化测试在美团外卖的实践与落地" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/ead6381e.html" class="article-date">
      <time datetime="2022-11-20T09:50:42.000Z" itemprop="datePublished">2022-11-20</time>
</a>


    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/ead6381e.html">自动化测试在美团外卖的实践与落地(转载)</a>
    </h1>
  

      </header>
      
    
        <div class="article-entry" itemprop="articleBody">
          
                
                            
                                  
                                  
                                  
                                  
                                  
                                  
                                  
                                  
                                  
                                  
                            
                                
                                <p><blockquote>
<p>🔗 原文链接： <a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/vLR1FqGi6TiICEcWzOnHfQ">https://mp.weixin.qq.com/s/vLR1FqGi…</a></p>
</blockquote>
<p>
                              
                          
                    
              <!-- 
              
              <blockquote>
<p>🔗 原文链接： <a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/vLR1FqGi6TiICEcWzOnHfQ">https://mp.weixin.qq.com/s/vLR1FqGi…</a></p>
</blockquote>
<blockquote>
<p>⏰ 剪存时间：2022-11-20 17:50:19 (UTC+8)</p>
</blockquote>
<blockquote>
<p>✂️ 本文档由 <a target="_blank" rel="noopener" href="https://www.feishu.cn/hc/zh-CN/articles/606278856233?from=in_ccm_clip_doc">飞书剪存 </a>一键生成</p>
</blockquote>
<p>原创 少飞 闫旭 文文等 美团技术团队 <em>2022-09-15 19:58 发表于 北京</em></p>
<p>收录于合集</p>
<p>#美团外卖 19 个</p>
<p>#自动化测试 3 个</p>
<p>#前端 22 个</p>
<p>#到家 9 个</p>
<p><img src="https://jbfhxmeaps.feishu.cn/space/api/box/stream/download/asynccode/?code=NzczYjE2NGRkZmQ4ZDQ2N2ZmZTc4NWVmMDlmMGE0ZTFfM2VuV1dBVmxnaGlUc1JhcU9BNFZud3FoZndnM3I4NWdfVG9rZW46Ym94Y25WdWMzdmtFemtYdEtPMGJGZ1NNNjhiXzE2Njg5Mzc4Njk6MTY2ODk0MTQ2OV9WNA" alt="img"></p>
<p><strong>总第535 篇 | 2022年 第052篇</strong></p>
<p><img src="https://jbfhxmeaps.feishu.cn/space/api/box/stream/download/asynccode/?code=MWVjMWI1NDRlOWNhZDJkZjI2ZDU4M2FkN2E0Y2VlMTlfenIxdjNBSFNWcGRxZkhXVDdoTTVtZHcyU0tJQUVwcWdfVG9rZW46Ym94Y25nWlE1WDY0NFo5TGNHZE5UZVQzQlplXzE2Njg5Mzc4Njk6MTY2ODk0MTQ2OV9WNA" alt="img"></p>
<p>随着美团到家业务的发展，系统复杂度也在持续增长。测试用例数量近两年增长约一倍，单端数量超过1万2千条，而研发人员的工作从大部分时间在开发，转变成一半时间在开发、一半时间在模拟环境和自测。因此，引入自动化测试就显得十分有必要，本文介绍了美团外卖在自动化测试方向做的一些探索和实践，希望对从事相关领域工作的同学能够带来一些启发或帮助。</p>
<ul>
<li><p>\1. 项目背景</p>
</li>
<li><p>\2. 项目目标</p>
</li>
<li><p>\3. 方案选型</p>
</li>
<li><p>\4. 实践和探索</p>
<ul>
<li>4.1 问题和挑战</li>
<li>4.2 前置条件准备</li>
<li>4.3 用例录制与回放的数据一致性</li>
<li>4.4 用例录制与回放的操作一致性</li>
<li>4.5 可溯源的自动化测试</li>
<li>4.6 用例的维护</li>
<li>4.7 跨App回放用例</li>
<li>4.8 埋点的录制回放</li>
</ul>
</li>
<li><p>\5. 测试流程</p>
<ul>
<li>5.1 自动化任务触发</li>
<li>5.2 回放集群调度</li>
<li>5.3 断言服务</li>
<li>5.4 消息推送</li>
</ul>
</li>
<li><p>\6. 落地与实践</p>
<ul>
<li>6.1 业务共建</li>
<li>6.2 实践效果</li>
</ul>
</li>
</ul>
<h2 id="1-项目背景"><a href="#1-项目背景" class="headerlink" title="1. 项目背景"></a><strong>1. 项目背景</strong></h2><p>美团外卖的业务场景比较多元化，除了外卖自身的业务，还作为平台承接了闪购、团好货、医药、跑腿等其他业务。除此之外，在全链路动态化的大基调下，外卖各个页面的技术形态也变得越来越复杂，除了Native代码，还包括Mach（ 外卖自研动态化框架 ）、React Native、美团小程序、H5等，不同技术栈的底层技术实现不同，渲染机制不同，进而对测试方式要求也有所不同，这也在无形中增加了测试的难度。下图汇总了美团多业务、多技术、多App的一些典型场景。</p>
<p><img src="https://jbfhxmeaps.feishu.cn/space/api/box/stream/download/asynccode/?code=NDMzZmE0ZjVlMDFhODcxODVhOTMyNWFlMGIyNGM1NjlfU2hsMFZubkF3REppak5qSDEyamZDUk1rRHBOT0NGa0JfVG9rZW46Ym94Y25JVlBodnZaTWhpNGYzdWJWS3VreUZmXzE2Njg5Mzc4Njk6MTY2ODk0MTQ2OV9WNA" alt="img"></p>
<p>图1 多业务、多技术栈、多App</p>
<p>在产品交付上线的过程中，测试的占比也是非常大的，甚至大于总时长的30%。如下图所示，整个测试包括了冒烟测试、新功能测试、二轮回归测试、三轮测试。然而，现在需求测试绝大部分还是采用非自动化的方式，这就使得人力成本变得非常之高。</p>
<p><img src="https://jbfhxmeaps.feishu.cn/space/api/box/stream/download/asynccode/?code=N2MyNTAyNzY1ZTY4ZTllZmJlZDA2YTZhNDkxZTI4N2ZfcURhamVVclZMMUxnc3daQjVDYTRUN3RDZkNKTm11RnlfVG9rZW46Ym94Y254a0pXVXhTVnhORWRBc2VxN2pEYUFlXzE2Njg5Mzc4Njk6MTY2ODk0MTQ2OV9WNA" alt="img"></p>
<p>图2 外卖迭代模型</p>
<p>另一方面，相比于2018年，2022年的测试用例数量增长近3倍，已经超过1万2千条（ 如下图所示 ）。同时，外卖的业务是“三端复用”，除了外卖App，还需要集成到美团App和大众点评App上，这样一来，测试工作量就翻了3倍，业务测试压力之大可想而知。如果按照当前的增长趋势持续下去，要保障外卖业务的稳定，就必须持续不断地投入大量的人力成本，所以引入能够支持外卖“多业务场景”、“多App复用”、“多技术栈” 特点的自动化测试工具来提升人效和质量，势在必行。</p>
<p><img src="https://jbfhxmeaps.feishu.cn/space/api/box/stream/download/asynccode/?code=MzRlNThkMGMxN2I3ZDI0Mjc2ZGJjN2QyNTQ2ZmRkNmVfOW9JNWswYTdWRDhrTW5pSTRoVXBPcW5BSE5kQ1FkQ0JfVG9rZW46Ym94Y25kSjR5ZjhQa0ZtOWh1cUJpdUlWQkJiXzE2Njg5Mzc4Njk6MTY2ODk0MTQ2OV9WNA" alt="img"></p>
<p>图3 近几年用例增长变化</p>
<h2 id="2-项目目标"><a href="#2-项目目标" class="headerlink" title="2. 项目目标"></a><strong>2. 项目目标</strong></h2><p>为了解决外卖面临的测试困境，我们尝试去探索一种零学习成本、低维护、高可用的自动化测试方案，能够支持外卖复杂多变的测试场景，它必须同时满足下面几点要求：</p>
<ul>
<li><p><strong>易用性</strong> ：工具/平台的上手难度，使用复杂度应该尽可能的低，因为自动化测试的目的是提效人力，而不是增加人力负担。</p>
</li>
<li><p><strong>平台支持</strong> ：移动端至少需要覆盖iOS和Android双平台，同时基于外卖的业务特点，不仅需要对Native支持，也需要支持Mach（ 自研局部动态化框架 ）、H5、React Native、美团小程序等技术栈。</p>
</li>
<li><p><strong>稳定性</strong> ：自动化测试用例的执行需要有足够的稳定性和准确性，测试过程中不应因测试工具本身的不稳定而出现稳定性问题。</p>
</li>
<li><p><strong>维护成本</strong> ：维护成本很大程度上决定了测试工作量的大小，因需求产生变动或架构重构等问题时，用例的维护成本应该尽可能的小。</p>
</li>
<li><p><strong>可扩展性</strong> ：当测试方案不能满足测试需求时，工具/平台应具备可扩展的能力。</p>
</li>
</ul>
<h2 id="3-方案选型"><a href="#3-方案选型" class="headerlink" title="3. 方案选型"></a><strong>3. 方案选型</strong></h2><blockquote>
<p>自动化测试工具那么多，自研是重复造轮子吗？</p>
</blockquote>
<p>针对终端的UI自动化测试工具/平台可谓“屡见不鲜”，市面上也有很多相对成熟的方案，相信大家都有用过，或者至少有所耳闻，但这些方案是否能真的满足我们提效的诉求呢？以下我们挑选了三类非常具有代表性的自动化测试工具/平台 - Appium、Airtest Project、SoloPi进行了分析，来帮助大家对自动化测试技术建立一个认知：</p>
<p><img src="https://jbfhxmeaps.feishu.cn/space/api/box/stream/download/asynccode/?code=YzZjYTJiOTZmZGVhNDBjYWVjYWY5ZjUwMjFkYTBlYzVfU1NDa1l5aTNjOVppMkgyM2RNRTdwaTZDZ2JoQTdWUDhfVG9rZW46Ym94Y254ZElSdmthYURKYnhRMlhFV3h3cWRjXzE2Njg5Mzc4Njk6MTY2ODk0MTQ2OV9WNA" alt="img"></p>
<ul>
<li><p>Appium是一个开源工具，用于自动化测试iOS手机、Android手机和Windows桌面平台上的原生、移动 Web和混合应用。它使用了各系统自带的自动化框架，无需SDK集成，Appium把这些系统本身提供的框架包装进一套API——WebDriver API中，可以使用任何语言编写Client脚本向服务器发送适当的HTTP请求。这让不同技术栈的人员都能快速上手编写测试用例，可以选择自己最为熟悉的语言，但是对于没有语言开发基础的人来说，还是有一定学习成本，而且这种方式在多人协作时并没有太大作用，为了保证自动化用例的可维护性，团队内部应该需要统一脚本语言。值得一提的是：Appium在iOS、Android和 Windows 测试套件之间可做的一定程度的复用代码。但是由于不同端界面及元素定位的差异，这往往是不现实的，更无法保证测试的准确性，所以这种所谓的“跨端”就变得毫无意义。</p>
</li>
<li><p>Airtest Project是由网易游戏推出的一款自动化测试平台，除了支持通过系统自带的自动化测试框架，还支持了通过图像识别的方式，对于非基于原生UI系统的一些游戏引擎提供了SDK的支持。其上手难度稍低，可以一定程度上通过IDE进行相关操作来生成简单的脚本指令。Airtest虽然基于图像进行控件识别，为跨端提供了一定的可能性，然而图像识别并不能达到人眼识别的准确度，除此之外移动端页面的构成和游戏页面也存在不小的差别，页面元素的展示规则和样式受屏幕分辨率影响较大，单纯依靠图像识别来进行元素查找成功率不高，无法保证测试的准确性。</p>
</li>
<li><p>SoloPi是一个无线化、非侵入式的自动化测试工具，通过录制回放的方式进行UI自动化测试，SoloPi虽然只支持Android，但是在录制回放的这种方式中，还是极具代表性的。传统的自动化测试工具由于需要编写测试脚本，所以存在着一定的上手难度（ Airtest还是存在代码编辑的 ），便产生了SoloPi这种纯基于录制回放的自动化测试方式，将用例的所有操作事件进行录制，生成一个完整的录制脚本，通过对脚本的回放来还原所有的操作，从而进行自动化测试。但是，这种方式只能记录操作，而不能记录数据，在外卖这种数据驱动展示的场景下无法满足测试要求。并且外卖的业务要复用到美团App和大众点评App中，不同App存在部分视图和逻辑性的差异，SoloPi也无法支持我们“一端录制多端回放”的测试场景。</p>
</li>
</ul>
<p>可以看出，以上这些自动化测试工具/平台对于数据记录，环境模拟、维护成本、跨App复用等方面，都是有所欠缺的。所以无论是哪种方案，在易用性、维护成本、稳定性、可扩展性以及最终的测试效果上，都无法满足我们对自动化测试的需求。我们并不是为了自动化而自动化，而是要解决实际的提效问题。</p>
<p>那么，怎样才能确定一个自动化工具/平台的可用性，并长期落地去使用自动化，带着上述提到的较高门槛的上手成本、操作繁琐的环境模拟、差强人意的测试成功率、定位模糊的测试缺陷、难以维护的用例脚本等几大重要痛点， <strong>本文我们将介绍美团外卖自研的测试平台——AlphaTest</strong> ，都具备哪些能力以及是如何解决这些问题。</p>
<h2 id="4-实践和探索"><a href="#4-实践和探索" class="headerlink" title="4. 实践和探索"></a><strong>4. 实践和探索</strong></h2><p>一个自动化测试工具/平台能不能用起来，取决于他的上手成本和稳定性，即使工具的测试稳定性做的再好，使用的门槛高也会让人望而生却，反之亦然。所以AlphaTest平台为了上手简单，降低使用成本，采用了 <strong>基于录制回放</strong> 的方式进行设计，并且弥补了常规录制回放无法编辑的痛点，同时在手势操作的基础上增加了数据录制。整合美团系App的特性增加了环境模拟、跨App支持、混合技术栈的支持等能力，在使用简单的同时，也保障了用例的可维护性、测试的准确性等。我们先通过视频简单的了解一下：</p>
<p><strong>用例录制：</strong></p>
<p><a target="_blank" rel="noopener" href="https://v.qq.com/txp/iframe/player.html?origin=https://mp.weixin.qq.com&containerId=js_tx_video_container_0.5273447298572995&vid=l3356se7yyc&width=660&height=371.25&autoplay=false&allowFullScreen=true&chid=17&full=true&show1080p=false&isDebugIframe=false">🎦 点击观看视频</a></p>
<p><strong>用例回放：</strong></p>
<p><a target="_blank" rel="noopener" href="https://v.qq.com/txp/iframe/player.html?origin=https://mp.weixin.qq.com&containerId=js_tx_video_container_0.944923673371538&vid=a3356pw74ls&width=660&height=371.25&autoplay=false&allowFullScreen=true&chid=17&full=true&show1080p=false&isDebugIframe=false">🎦 点击观看视频</a></p>
<p><strong>回放报告：</strong></p>
<p><a target="_blank" rel="noopener" href="https://v.qq.com/txp/iframe/player.html?origin=https://mp.weixin.qq.com&containerId=js_tx_video_container_0.6311952878907903&vid=o3356mbeb6a&width=660&height=371.25&autoplay=false&allowFullScreen=true&chid=17&full=true&show1080p=false&isDebugIframe=false">🎦 点击观看视频</a></p>
<h3 id="4-1-问题和挑战"><a href="#4-1-问题和挑战" class="headerlink" title="4.1 问题和挑战"></a><strong>4.1 问题和挑战</strong></h3><blockquote>
<p>注：这里我们将生成的自动化脚本统称为指令，将平台生成的用例统称自动化用例，将录制回放变成可视化的脚本指令，让用例变的易懂、易维护。</p>
</blockquote>
<p>录制回放本身是一连串的操作数据的集合，是连续性的、不可拆分，因此几乎不具备可编辑性，这也就导致了用例维护成本极高。AlphaTest虽然同样基于录制回放的方式生成自动化用例，但是我们将每一步的操作都具化成结构化的指令数据，并提供可视化指令编辑器，以支持查看编辑。</p>
<p>这些可视化的指令，完全通过录制自动生成，也不依赖于任何脚本语言。通过可视化用例指令编辑器，不仅为用例提供了编辑的可能性，同时大大地提高了用例的可阅读性，每一条测试用例在测试过程中每一步都做了什么、当时的界面是什么样的、都有哪些断言校验点，是显而易见的，不会存在像传统图文描述的测试用例那样，出现理解偏差。指令生成演示，手机录制与平台远端录制双模式支持：</p>
<p><img src="https://jbfhxmeaps.feishu.cn/space/api/box/stream/download/asynccode/?code=ZjIzMDRmZjhiNWZhZTdhYWU0OGNmYzc4YjkxNDE4YTlfTmQxM0I0c3ZKbzludmpSUENnTlg5UXNzN3NmOXNFRDBfVG9rZW46Ym94Y250N3BnV1lnVGVQbHp1S2xMVG5kYmJkXzE2Njg5Mzc4Njk6MTY2ODk0MTQ2OV9WNA" alt="img"></p>
<p>图4 指令编辑器</p>
<p><img src="https://jbfhxmeaps.feishu.cn/space/api/box/stream/download/asynccode/?code=ZmE3MWNhODQ3MzIyZTJlNWZhNjY0NTE1MWRkMDdhMThfb3pPZXZWSXlpRVBVYjJHcUx5SGV1cWt1T2hyUE1zYm5fVG9rZW46Ym94Y25OWGNDUDRCRlpWZ25aUUNwMlh6UXdGXzE2Njg5Mzc4Njk6MTY2ODk0MTQ2OV9WNA" alt="img"></p>
<p>图5 手机录制演示</p>
<p><img src="https://jbfhxmeaps.feishu.cn/space/api/box/stream/download/asynccode/?code=NDFjZTA0NGJkMjllNWI1ODA5OWVkMjBkOTZkMzQ2Y2RfRnNndE9JbkZEak1ZUlRIYTZ4YkJXaUdpSUxpdHdEVFVfVG9rZW46Ym94Y25PVjNjZXV4c3NROWN1VWF3ekI1Y2VoXzE2Njg5Mzc4Njk6MTY2ODk0MTQ2OV9WNA" alt="img"></p>
<p>图6 平台远端录制演示</p>
<h3 id="4-2-前置条件准备"><a href="#4-2-前置条件准备" class="headerlink" title="4.2 前置条件准备"></a><strong>4.2 前置条件准备</strong></h3><blockquote>
<p>一键环境模拟，解决操作繁琐的用例执行前的环境准备。</p>
</blockquote>
<p>进行一个用例的测试之前，往往需要做大量的准备工作，比如切换API环境，定位到某个地点，登录指定账户等。这些需要准备的环境条件我们统称为前置条件。我们知道，前置条件的准备操作通常都不是一两个步骤就可以完成的，比如账号登录/切换：我们需要进入登录页，填写手机号+密码/验证码，点击登录等一系列动作来完成这个过程，非常繁琐，并且每次测试我们都需要准备，重复性高。因此，我们给AlphaTest设计了独立的前置条件模块，将用例拆成了两个部分：前置条件 + 操作步骤。</p>
<p><img src="https://jbfhxmeaps.feishu.cn/space/api/box/stream/download/asynccode/?code=Y2Q5MzhmYjAyNTY4MGYwNmJjMzYxZTM1YjJhODkzOGJfcWdHdTJLb1BEWnpZYWk2TWNxSHZZclpyZU80aTZROENfVG9rZW46Ym94Y25ndkp6dW5WbmdhejZLY0xDd1N6TmJnXzE2Njg5Mzc4Njk6MTY2ODk0MTQ2OV9WNA" alt="img"></p>
<p>图7 前置条件</p>
<p>与其它测试框架不同的是，AlphaTest采用了SDK集成，但对业务无侵入的方式，因此可以通过编写白盒代码来实现前置条件的自动配置，只需要在平台添加需要的指令，下发到SDK后，即可根据相关指令完成前置条件的自动配置，不再需要重复进行相关的操作。并且这些前置条件支持复用，也不需要每次进行用例准备时的重复配置。AlphaTest的前置条件，不仅有着基于美团内部服务及底层Hook的默认实现，也提供了API支持业务方自定义实现，比如实现不同的账号体系。</p>
<h3 id="4-3-用例录制与回放的数据一致性"><a href="#4-3-用例录制与回放的数据一致性" class="headerlink" title="4.3 用例录制与回放的数据一致性"></a><strong>4.3 用例录制与回放的数据一致性</strong></h3><blockquote>
<p>影响用例执行的不仅是代码，还有数据。</p>
</blockquote>
<p>很多时候，自动化用例无法正常执行完成，可能是因为App回放时的本地数据及网络数据与录制时的不一致，从而导致用例执行流程的阻塞或App界面展示的不同。这也是大多数自动化测试工具/平台测试通过率不高的主要因素，因此要保证测试成功率，我们需要控制变量，排除由数据产生的影响。</p>
<p><img src="https://jbfhxmeaps.feishu.cn/space/api/box/stream/download/asynccode/?code=N2MyNjdjYzNlZTZiOWYyNzgzODQ0NjY3M2I3MGVhODBfcXpaeG01SkQ5WXN3UDhTb3h4SEhEZW5XWmc1bmdJM1dfVG9rZW46Ym94Y25HRm80OVlIM1VFYlVORDAxeUJtTndlXzE2Njg5Mzc4Njk6MTY2ODk0MTQ2OV9WNA" alt="img"></p>
<p>图8 数据一致性</p>
<p>App运行依赖的数据，有两部分——本地数据和网络数据：</p>
<ul>
<li><p>本地数据是App在运行期间产生的缓存数据或持久化的存储数据。为了让用例在录制回放时都能够保持一致的本地数据环境，我们在录制和回放前都对App的本地数据进行了清理操作，这样用例在录制和回放的过程中，都可以保持一致的App初始化环境。</p>
</li>
<li><p>网络数据是驱动App交互呈现的基石，各种策略和API升级都会影响网络数据的响应，因此我们将用例录制过程中产生的网络数据也进行了录制，并将网络数据和对应的操作指令进行了关联和绑定，确定了数据产生的事件源。排除数据影响后，我们的自动化测试的成功率就取决于自动化操作的准确性了，这就回到了常见自动化框架范畴。</p>
</li>
</ul>
<h3 id="4-4-用例录制与回放的操作一致性"><a href="#4-4-用例录制与回放的操作一致性" class="headerlink" title="4.4 用例录制与回放的操作一致性"></a><strong>4.4 用例录制与回放的操作一致性</strong></h3><blockquote>
<p>目标定位的准确性与手势定位的精准性。</p>
</blockquote>
<p>UI自动化测试的本质就是代替人去自动的做一步步的操作（ 点击、长按、输入、滑动等 ）。录制与回放过程的操作能否一致，是否精准，直接影响测试的成功率，决定了工具/平台的可用性。</p>
<ul>
<li><strong>目标控件定位准确性：</strong></li>
</ul>
<p>操作行为是否一致首先需要确认操作目标是否一致。与一般测试工具/平台不同的是AlphaTest采用了ViewPath + 图像 + 坐标的多重定位方案。得益于SDK集成的方式，我们的ViewPath可以记录更多的元素视图特征和执行不同的匹配策略。定位过程中会优先使用ViewPath进行目标控件检索，当目标控件查找异常时，会结合图像匹配和坐标匹配的方式进行兜底查找，来确保界面变化程度不大时，也能准确的查找到目标控件。</p>
<p><img src="https://jbfhxmeaps.feishu.cn/space/api/box/stream/download/asynccode/?code=MzY4NDMwMzhlOGFmZmYyM2I1MmI3ZmEyMmY5ZTUyNDRfMjdNUjV0Mk9zUXRqcHU4aXFUZGJJd1pwTFczUTJYQnBfVG9rZW46Ym94Y25rMzdDVTJsWDhCVjAzWUJjTXJYUnloXzE2Njg5Mzc4Njk6MTY2ODk0MTQ2OV9WNA" alt="img"></p>
<p>图9 图像识别示意图</p>
<ul>
<li><strong>手势定位的精准性：</strong></li>
</ul>
<p>有了基于控件的目标定位之后，对于一些常用简单操作手势，比如点击、长按、断言、甚至输入都可以做到很好的支持，只需要找到对应的控件，在控件所在位置下发相应的触摸事件即可。我们知道，App真正接收的触摸事件是屏幕上一个个精准的触摸点，在系统处理后，分发给当前App窗口，App在接收事件后再继续分发，直到找到事件的最佳响应者，后续通过响应者链对事件消化处理。那我们要还原一个触摸事件的坐标点要如何确定呢？由于我们确定的只有控件，所以这个点自然而然就成了控件的中心点了。</p>
<p>大多数情况下，这些都可以很好地进行工作，但是对于一些多响应控件重叠的情况，可能会产生预想不到的操作误差。为了解决这样的问题，我们把控件定位与坐标定位进行了结合：基于纯坐标的定位是一种定位精准度非常高的定位方式，但是稳定性非常差，只有在屏幕分辨率完全一致且回放页面控件位置完全一致的情况下，才具备足够的可靠性，但这往往是不现实的，对测试环境机器量要求过高。</p>
<p>基于控件的定位，又存在着精准度不够的问题。使用坐标定位，如果定位区域足够小的话，那么受屏幕尺寸的影响就会越小，只需要确定在小范围内的相对位置即可。而基于控件目标的定位，恰恰可以把目标区域缩小到一个指定区域，我们刚好可以将二者结合起来，同时解决定位精准度和稳定性的问题。</p>
<p>对于复杂手势的支持，我们同样可以采用微分的方式，将一个复杂手势拆成多个简单手势的组成，比如我们可以将一个滑动操作的定位拆成两个部分：起始位置和终止位置，而这两个位置的定位，就变成了两个普通的单点手势操作定位了，可以通过上面提到的一个目标控件+相对坐标的形式进行定位。核心思想都是将基于屏幕坐标点的定位操作，缩小的目标控件的区域范围内，以达到不受设备分辨率的影响，实现操作行为一致的效果。</p>
<p><img src="https://jbfhxmeaps.feishu.cn/space/api/box/stream/download/asynccode/?code=YWQ5ODljMjIzZDAxODUxYzk0YTEwOGI1NzdmMjg3ZTBfTFZqeUJ2TkoxMFdDd3pGeFQ3SnV1ZktUUEc1UzN4R0pfVG9rZW46Ym94Y25XdW1NM2hEVDdDWFdyMUxicVBraGtlXzE2Njg5Mzc4Njk6MTY2ODk0MTQ2OV9WNA" alt="img"></p>
<p>图10 手势识别示意图</p>
<h3 id="4-5-可溯源的自动化测试"><a href="#4-5-可溯源的自动化测试" class="headerlink" title="4.5 可溯源的自动化测试"></a><strong>4.5 可溯源的自动化测试</strong></h3><blockquote>
<p>测试全流程记录，问题溯源一键即达。</p>
</blockquote>
<p>测试的目的是保证App运行的稳定，测试过程中出现Bug导致测试未通过时，需要溯源问题原因，发生的场景，乃至具体的执行步骤。这也是大多自动化测试工具/平台所欠缺的，即使发现了问题，排查工作也很困难；这个问题在手工测试的时候，更为严重，往往因为很多缺陷无法复现而难以定位。</p>
<p>AlphaTest的自动化用例最小执行单元是操作指令，我们将测试过程的每一条指令的执行状况和过程中的界面快照进行了记录，并在指令执行失败时，对异常原因进行了初步分析。然后将整个用例的执行组合成了一份完整的测试报告，可快速溯源问题步骤。除此之外，我们还增加大量的日志上报，并将整个用例测试过程进行了视频录制，来进一步帮助疑难问题的排查。真正做到了用例回放测试可溯源。</p>
<p><img src="https://jbfhxmeaps.feishu.cn/space/api/box/stream/download/asynccode/?code=NTVmYzEyNDFjNjA5OWM5OTU3YzEzNmVmYzFjZDE4MzFfNTBTc1hDenkwcTBZRTJreDJUaTVra3Y1MDU3aEtWVWFfVG9rZW46Ym94Y25XNU14YUpjdW5ESWhYYmNlZnFKckljXzE2Njg5Mzc4Njk6MTY2ODk0MTQ2OV9WNA" alt="img"></p>
<p>图11 回放报告-图文详情</p>
<p><img src="https://jbfhxmeaps.feishu.cn/space/api/box/stream/download/asynccode/?code=YzMwZTNiMDc0NmI5MDczYWI5YmM2ODRmNDAyYWJjZDFfZTNaaUhaQVpneE93WWdaVVk1N2pQd29iV1hVZUFEbzBfVG9rZW46Ym94Y25pR0R6SnFUcXliT3BGUGNnRWdjMzNlXzE2Njg5Mzc4Njk6MTY2ODk0MTQ2OV9WNA" alt="img"></p>
<h3 id="4-6-用例的维护"><a href="#4-6-用例的维护" class="headerlink" title="4.6 用例的维护"></a><strong>4.6 用例的维护</strong></h3><blockquote>
<p>自动化用例需要持续地投入人力来维护么？架构升级，页面重构，用例需要全部重新录制么？</p>
</blockquote>
<p>因自动化工具/平台众多，阻碍长期落地使用的一大问题是用例维护成本高，很多工具/平台让我们即便是使用上了自动化，但还需要持续投入人力维护用例的更新，最终的提效收益微乎其微。对于用例更新维护，我们可以梳理划分成三个场景：</p>
<ul>
<li><p>需求发生重大变更，整体的业务执行流程及相关的校验点都需要进行大量的调整。对于这种情况，无论是何种自动化测试工具/平台，都是需要正常进行用例变更重录以适应新的需求。</p>
</li>
<li><p>需求发生略微变更，业务流程基本一致，需要调整的校验点、操作以及数据或不影响整体流程的步骤。对于此场景，AlphaTest通过指令编辑器与操作录制，支持指令增删改以及数据和场景的还原，帮助用户快速的进行用例调整，而无需重新录制用例。例如：修改网络数据字段、视图变更路径、断言替换目标等。</p>
</li>
</ul>
<p><img src="https://jbfhxmeaps.feishu.cn/space/api/box/stream/download/asynccode/?code=ZjY3YTA2ZGM0YTAwMmFjYWM2Yjk2MTg4MGRkNGQ1NDFfa2Z0bTBtY0Z2Nmp5SUl1S3VkNzVKM2E5QWdDbnZUQlBfVG9rZW46Ym94Y24wbmoxMUZRVVBkZTM5cTRaZDJFY3dkXzE2Njg5Mzc4Njk6MTY2ODk0MTQ2OV9WNA" alt="img"></p>
<p>图14 指令编辑</p>
<ul>
<li>和业务需求不同，我们的技术实现也会发生迭代。随着App技术架构不断的演进，经常会面临着架构升级，页面重构甚至技术栈变迁等这样的技术升级。这些变动需要覆盖大量的测试用例，其中大量的自动化用例又可能会因为变动而导致失效，需要重新录制。为此，AlphaTest设计一套利用相近分辨率机器进行用例自动修正的功能：利用图像 + 坐标进行二次识别定位，元素定位成功并校验通过后，生成新的ViewPath，更新对应的用例指令，对用例进行自动修复，修复后可在任意回放。</li>
</ul>
<p><img src="https://jbfhxmeaps.feishu.cn/space/api/box/stream/download/asynccode/?code=YmE0N2U2NmQ0MzQwZDk3MDE2YmE4ODUwY2E3OWM1NmFfdHNHYW10SWNRNW1qNDhjTmZIM2d3aXd1VDNydmNEZjRfVG9rZW46Ym94Y251UFNHZmNrUHRESkNIcmFWMHk0Q2hlXzE2Njg5Mzc4Njk6MTY2ODk0MTQ2OV9WNA" alt="img"></p>
<p>图15 自修复能力</p>
<h3 id="4-7-跨App回放用例"><a href="#4-7-跨App回放用例" class="headerlink" title="4.7 跨App回放用例"></a><strong>4.7 跨App回放用例</strong></h3><blockquote>
<p>同一份代码运行在不同的App上，是否需要重新编写多份用例？</p>
</blockquote>
<p>美团系的一些业务可能会复用在多个App上。比如外卖有独立App，但同时也要复用到美团和点评App上，这些功能，几乎共用一份代码，而测试人员却不得不对每个App上的业务功能都进行测试，维护多份用例。由于业务本身实现是一致的，那我们可以通过适配不同App之间的差异，来让一个业务Case可以横跨多个App回放，这便可以将成本缩减好几倍，这些差异主要体现在：</p>
<ul>
<li><p><strong>前置条件和初始页面</strong> ：业务的初始页面进入路径不同，例如外卖App打开App就进入到了外卖首页，但是在美团App中就需要从美团首页跳转到外卖频道。同时由于不同App的样式风格、设计规范、业务特性等因素，也会造成首页代码逻辑和视图层级的差异。</p>
</li>
<li><p><strong>AB实验配置</strong> ：不同App所配置的实验可能不同，不同的实验会导致不同的样式和代码逻辑。</p>
</li>
<li><p><strong>网路接口映射</strong> ：不同App中相同业务场景涉及的接口有所不同。</p>
</li>
<li><p><strong>页面Scheme映射</strong> ：不同App中相同页面的跳转Scheme也不相同。</p>
</li>
</ul>
<p>AlphaTest平台支持App维度各项差异数据配置，当SDK检测用例回放环境与录制环境不一致时，会自动进行映射适配，从而让用例运行到了不同App上。</p>
<h3 id="4-8-埋点的录制回放"><a href="#4-8-埋点的录制回放" class="headerlink" title="4.8 埋点的录制回放"></a><strong>4.8 埋点的录制回放</strong></h3><p>除了功能测试，我们在日常开发和测试的工作中，还会面临另外一个比较重要的问题就是埋点测试。因此，我们在自动化的基础上扩展出埋点自动化测试。埋点自动化测试的核心思想是，通过对比录制时期和回放时期的埋点上报时机和上报参数进行判断。为了保证埋点自动化测试的稳定性，我们主要采用以下的障机制：</p>
<p><img src="https://jbfhxmeaps.feishu.cn/space/api/box/stream/download/asynccode/?code=OGY1ZTZjMmQwMDkwODhiMTM1NTNlNDVjZjc0ZGFhYTBfbGVYNzI5M1RqOFFENzVsRWtGTTc2czRQSUtscUFva2tfVG9rZW46Ym94Y24ydUFyelJPZTI5OE9Ub3BFeXRyTzJlXzE2Njg5Mzc4Njk6MTY2ODk0MTQ2OV9WNA" alt="img"></p>
<p>图16 埋点自动化测试示意图</p>
<ul>
<li><strong>字段规则配置</strong> ：埋点自定义参数千姿百态，甚至有些字段每次代码执行都不一致，如果进行完全匹配结果注定是失败的，所以我们在AlphaTest平台提供了埋点字段规则配置功能，通过人为设置的方式来避免埋点自定义参数校验失败。App重启进入录制状态时，用户就可以操作App，平台会记录用户的操作行为，当产生相应的埋点日志的时候会将日志信息打印在日志区域（ 如下图17所示 ），在该过程中也会对埋点日志进行一定的校验。重点将操作时机、埋点日志一并保存到服务端。</li>
</ul>
<p><img src="https://jbfhxmeaps.feishu.cn/space/api/box/stream/download/asynccode/?code=ODlmMDgzZjdhZGM1MGU2ZDE4NzNmM2YwMjE5MWM0OThfZmc4NzhTZmhmYkgyTGh0bTFhRGJrQTU0ZFJnY1oyRExfVG9rZW46Ym94Y25Wb2h1a2dEek04azFVaUlNUVVsNld5XzE2Njg5Mzc4Njk6MTY2ODk0MTQ2OV9WNA" alt="img"></p>
<p>图17 埋点上报数据控制台打印</p>
<ul>
<li><p><strong>埋点时机校验</strong> ：针对时机校验，程序并不支持埋点曝光的”1px曝光”，”下拉刷新曝光”，”页面切换曝光”，”切前后台曝光”这些规则，主要的原因是每一个业务方在对埋点曝光的规则都是不一致的，而且该规则的实现会极大耦合业务代码。在针对时机校验我们目前只支持：</p>
</li>
<li><p>[1] 点击埋点上报时机校验，程序通过事件监听和埋点类型信息来判断点击埋点上报的时机是否是在点击的操作下产生的，如果不是则报错。</p>
</li>
<li><p>[2] 埋点重复上报校验，针对一般情况下用户一次操作不会产生两个相同的埋点上报，所以程序会校验某个事件下发生的所有埋点日志进行一一校验，检测是否具有2个或多个埋点日志完全一致，如有发生则会上报错误。</p>
</li>
<li><p><strong>结果校验</strong> ：回放完成后，我们会对比录制和回放时的埋点数据，根据配置好的字段规则校验埋点上报是否符合预期。</p>
</li>
</ul>
<p><img src="https://jbfhxmeaps.feishu.cn/space/api/box/stream/download/asynccode/?code=NmMxNDY2MzBhODRmOTNjMjM1OTAxZTM2YzdkYmM5NDVfNks1eHJYcGJMdkpPSWs1Q2F2Z2FFbzlSWXRpR0lHM2xfVG9rZW46Ym94Y24xcll2QnY0anBCQkh2Q3JLV0w2aGFnXzE2Njg5Mzc4Njk6MTY2ODk0MTQ2OV9WNA" alt="img"></p>
<p>图18 埋点校验流程图</p>
<h2 id="5-测试流程"><a href="#5-测试流程" class="headerlink" title="5. 测试流程"></a><strong>5. 测试流程</strong></h2><blockquote>
<p>AlphaTest的核心测试流程始终聚焦在用例的录制与回放环节，整个流程涉及到自动化任务触发、回放集群调度、断言服务、消息推送等核心模块。</p>
</blockquote>
<p>以UI自动化和埋点自动化的流程为例，AlphaTest以业务团队为基本单元，可以和各团队的测试用例进行关联，定时同步状态。同时利用需求评审线上化做为基础，将自动化用例和研发流程中的PR、集成打包、二轮回归等节点相结合，定时触发自动化用例并将结果报告推送给相关负责人。</p>
<p><img src="https://jbfhxmeaps.feishu.cn/space/api/box/stream/download/asynccode/?code=ZTgyYmM3NDQ1MWIzZjhmYjQ1YzJjYjMwZjQyMzNmMTVfWHFzQzVIazF2U29OOEF4OG05ZHlReHZPNFBRb1dlcU1fVG9rZW46Ym94Y24xbmhDa0pETWtraHpwS09aUHp1emZkXzE2Njg5Mzc4Njk6MTY2ODk0MTQ2OV9WNA" alt="img"></p>
<p>图19 建设自动化测试流程闭环</p>
<ul>
<li><p><strong>录制用例：</strong></p>
</li>
<li><p>[1] 首先在AlphaTest平台选择要录制的测试用例，打开待测试App进行扫码即可进入用例待录制状态，此时可以设置用例需要的前置条件（ 账号信息、Mock数据、定位信息等 ），之后点击开始按钮后，手机便会自动重启，开始录制。</p>
</li>
<li><p>[2] 用户按照测试用例步骤，正常操作手机，AlphaTest会将用户的操作行为全部记录下来，并自动生成语义化的描述语言显示在AlphaTest平台上，与此同时产生的网络数据、埋点数据等校验信息也会一并存储下来。</p>
</li>
<li><p>[3] 在录制的过程中可以快捷的打开断言模式，将页面上想要校验的元素进行文本提取/截图等操作记录下来，用于后续回放过程中对相同元素进行校验。</p>
</li>
<li><p>[4] 测试步骤全都执行完毕后，点击保存按钮即可生成本条自动化用例。</p>
</li>
<li><p><strong>用例回放：</strong></p>
</li>
<li><p>[1] 扫描对应自动化用例的二维码即可进行回放，回放过程中会将用户录制的行为、网络数据进行一比一还原，并且辅助有全过程视频录像，用于后续问题排查和溯源。</p>
</li>
<li><p>[2] 回放过程中碰到断言事件时，会将断言的元素进行文本提取/截图，上传至AlphaTest平台。回放完成后，会将回放时候的断言截图和录制时的断言截图进行图像对比，作为整个测试结果的一项。</p>
</li>
<li><p>[3] 回放过程中的埋点数据也会一并记录下来，并和录制时候的埋点数据和上报时机进行对比，自动提取出其中的差异项。</p>
</li>
<li><p>[4] 回放完成后，会生成完整的测试报告并将结果通过OA推送至相关人员。</p>
</li>
<li><p><strong>回放计划</strong> ：二轮回归测试中，回放用例数量多达几百条，为了做到全流程的自动化，我们提供了回放计划的概念，可以将多个自动化用例进行编组管理，每一组就是一个回放计划。触发一个计划的回放即可自动触发计划内的所有自动化用例。整个计划都执行完成后，会通知到指定的计划负责人或群组。</p>
</li>
</ul>
<h3 id="5-1-自动化任务触发"><a href="#5-1-自动化任务触发" class="headerlink" title="5.1 自动化任务触发"></a><strong>5.1 自动化任务触发</strong></h3><p>在整个外卖C端敏捷迭代的流程中，打包平台主要承接了业务需求发起到需求交付的流程，作为AlphaTest的上游平台，可以提供打包信息并触发自动化用例回放任务。以下简单展示AlphaTest与敏捷协同平台的交互流程：</p>
<p><img src="https://jbfhxmeaps.feishu.cn/space/api/box/stream/download/asynccode/?code=MWVjMGI2M2JhNDAyZDI1Y2VkMmE3MTRiMzA2NTllYjNfN1lRUGZ0dGhleDVDUVBZUm1uTmNTRlN6OFZPQzZqR2tfVG9rZW46Ym94Y24wUmhyR0R2dkl1cU8yclRjRlR6ckl5XzE2Njg5Mzc4Njk6MTY2ODk0MTQ2OV9WNA" alt="img"></p>
<p>图20 AlphaTest与敏捷协同平台交互流程图</p>
<h3 id="5-2-回放集群调度"><a href="#5-2-回放集群调度" class="headerlink" title="5.2 回放集群调度"></a><strong>5.2 回放集群调度</strong></h3><p>整个测试过程真正的解放双手，才能算的上是自动化。因此，我们着手搭建了自己的自动化机器集群，可以 24小时不间断的执行测试任务。为了保证任务回放能够顺利完成，我们在不同阶段增加了相应的保活策略。在极大程度上提高了任务执行完毕的成功率。</p>
<ul>
<li><p><strong>执行流程</strong> ：回放任务通过用户在平台手动触发或者二轮自动触发。新增的回放任务经过任务拆分系统拆分成n个子任务，加入到不同设备的回放任务队列中。每个子任务经过占用设备-&gt;安装待测App-&gt;应用授权-&gt;打开scheme-&gt;上报结果等步骤完成回放操作。</p>
</li>
<li><p><strong>节点保活机制</strong> ：针对回放流程中每一个节点，失败后进行N（ 默认为3 ）次重试操作。减少因网络波动，接口偶现异常导致的回放失败数量。</p>
</li>
<li><p><strong>子任务保活机制</strong> ：每个回放流程，失败后进行N（ 默认为3 ）次断点重试。减少因设备异常，SDK心跳上报异常导致的回放失败数量。</p>
</li>
<li><p><strong>父任务保活机制</strong> ：一个父任务会被拆分成N个子任务，当其中的一个子任务S1在节点保活机制和子任务保活机制下仍然执行失败之后，父任务保活机制会尝试将子任务S1中未执行完毕的用例转移到其他活跃状态的子任务中。减少因设备异常，设备掉线等问题导致的回放失败数量。</p>
</li>
</ul>
<p><img src="https://jbfhxmeaps.feishu.cn/space/api/box/stream/download/asynccode/?code=ZjNmOGU1MzM0ZDVlZjZkNDdjMDIxMjQ2Njg1YTZhMjFfZEhlV1Y2enFTY2lQQ0FTS3A4RXNpOEk1U05qeWRENjZfVG9rZW46Ym94Y25DRVo5RjBLbUVlRG9Sb3RQbmlKRzRmXzE2Njg5Mzc4Njk6MTY2ODk0MTQ2OV9WNA" alt="img"></p>
<p>图21 机器集群</p>
<h3 id="5-3-断言服务"><a href="#5-3-断言服务" class="headerlink" title="5.3 断言服务"></a><strong>5.3 断言服务</strong></h3><p>用例断言是整个自动化用例验证的核心步骤，我们的断言服务依据用例的实际情形可以分别进行文字与图像的断言。其中图像断言服务依托于自建的图像对比算法服务，可以高效进行录制回放断言图像的对比，图像对比准确率可以达到99%以上。</p>
<ul>
<li><p><strong>录制阶段：</strong></p>
</li>
<li><p>[1] 录制时增加断言决策信息的自动采集。</p>
</li>
<li><p>[2] 和正常流程一样，提取区域的截图信息。</p>
</li>
<li><p>[3] 如果是文本组件，则提取文本内容，如果是图片组件，则提取图片二进制编码或图片URL，同时提取区域内的布局信息。</p>
</li>
<li><p><strong>回放阶段：</strong></p>
</li>
<li><p>[1] 回放时，提取和录制时一致的内容（ 文本信息、图片编码、区域截图、布局信息 ）。</p>
</li>
<li><p>[2] 将回放时的断言信息上传至AlphaTest平台。</p>
</li>
<li><p>[3] AlphaTest平台对断言结果进行校验，首先是基于模型的图像对比，如果判定为一致，则直接标记结果。</p>
</li>
<li><p>[4] 如果判定为不一致、则匹配“断言失败数据集”，如果能够匹配上，则标记结果。如果匹配不上，则需要人工选择匹配类型。</p>
</li>
<li><p>[5] 匹配类型为“文本校验”、“根据图片信息校验”、“人工校验”。如果前两项判定为一致，则直接标记结果。如果“人工校验”的结果为确实两张图不一致，则直接标记结果，结束。</p>
</li>
<li><p>[6] 如果“人工校验”结果为一致，既上述所有判定都不准确，则需要人工对两张图中判定错误的原因进行分类（ 具体类型待定 ），同时将断言存储到失败数据集。</p>
</li>
<li><p>[7] 模型自动训练，当数据集超过一定的阈值、通过定时触发、或者手动触发的方式，触发模型自动训练，训练完成后自动部署到AlphaTest平台，不断迭代。</p>
</li>
<li><p><strong>图像服务</strong> ：图像对比模型采用基于度量学习的对比算法，将图像对的一致性判别转换为图像语义的相似度量问题。度量学习（ Metric Learning ），也称距离度量学习（ Distance Metric Learning，DML ）属于机器学习的一种。其本质就是相似度的学习，也可以认为距离学习。因为在一定条件下，相似度和距离可以相互转换。比如在空间坐标的两条向量，既可以用余弦相似度的大小，也可以使用欧式距离的远近来衡量相似程度。度量学习的网络采用经典的Siamese结构，使用基于resnext50的主干网络提取图像的高级语义特征，后接spplayer完成多尺度特征融合，融合后的特征输出作为表达图像语义的特征向量，使用ContrastiveLoss进行度量学习。</p>
</li>
</ul>
<p><img src="https://jbfhxmeaps.feishu.cn/space/api/box/stream/download/asynccode/?code=ODE0YjMyYzA5ZTUwZjA4MDkyMmM3MzJmYzBjYTJmMWVfbmRKOGQ2dnp2QzFsVHdRMVRHUGFqWFdSejNta0xJTkNfVG9rZW46Ym94Y24wMThrMDRUWTJyMTlXVFhQbkEwcVlSXzE2Njg5Mzc4Njk6MTY2ODk0MTQ2OV9WNA" alt="img"></p>
<p>图22 训练过程</p>
<p>[1] <strong>预训练过程</strong> ：resnext50网络是使用ImageNet的预训练模型。</p>
<p>[2] <strong>数据增强</strong> ：为增加数据的丰富性、提高网络的泛化性能，数据增强的方式主要包括：图像右下部分的随机剪切和添加黑色蒙层（ 相应改变图像对的标签 ）。这种数据增强符合控键截图实际情况，不会造成数据分布的改变。</p>
<p>[3] <strong>对比损失</strong> ：对比损失函数采用ContrastiveLoss，它是一种在欧式空间的pair based loss，其作用是减少一致图像对距离，保证不一致图像对的距离大于margin，其中margin=2。</p>
<p><img src="https://jbfhxmeaps.feishu.cn/space/api/box/stream/download/asynccode/?code=YmYxOGVkZTgzYTk3MDM4MTcyNTc4NTYzYTYyYTE5MDZfMWZRZDZ3U2lEYzhzcXU0eE93cWdYak1ReTNaR2FZWmJfVG9rZW46Ym94Y24xbkFha3dOVkdmTmpnUGJHMWhySThmXzE2Njg5Mzc4Njk6MTY2ODk0MTQ2OV9WNA" alt="img"></p>
<p>图23 训练过程</p>
<p>[4] <strong>相似度量</strong> ：相似度量也是采用计算图像对特征向量的欧式距离的方法，并归一化到区间[0, 1]，作为输出的图像对相似度。</p>
<h3 id="5-4-消息推送"><a href="#5-4-消息推送" class="headerlink" title="5.4 消息推送"></a><strong>5.4 消息推送</strong></h3><p>消息推送作为回放流程的最终环节，我们依赖于美团内部自建的消息队列服务与OA SDK消息推送能力，可以进行测试报告的实时推送。在此之上，还可以针对不同团队的推送诉求，做消息模板的定制化。</p>
<ul>
<li><p><strong>消息定制</strong> ：消息推送与触达的核心，是满足业务诉求；不同业务对自动化测试报告中各项指标的关注点不同，这就需要AlphaTest具备消息推送定制的能力；将消息推送的模板以配置文件的形式提供出来，不同的业务使用不同的业务消息配置文件；再利用OA提供的图文、多媒体等消息推送能力，可以将自动化测试报告的各项指标自定义拆分；除此之外，消息还需要减少冗余，在这个信息泛滥的时代，我们愿意为无孔不入的消息、通知做减法，只将最重要、最核心的消息推送给最需要的人，既可以推动自动化测试流程的高效流转，又可以让各相关业务人员享受到自动化测试能力的便捷性。</p>
</li>
<li><p><strong>一键触达</strong> ：以往的研发人员冒烟测试，主要依赖于测试人员在用例管理平台建立测试计划，研发人员根据用例进行手工用例测试结果标记，之后去提测完成后续流程。这中间缺失的主要环节是，难以对研发人员冒烟测试的质量进行把控。而AlphaTest正可以解决此问题，流程转换为，研发人员在敏捷协同平台触发一键提测流程，调用AlphaTest的自动化测试能力对冒烟用例进行自动化测试回归，完成之后将测试生成的测试报告同步提测平台，作为研发人员冒烟的结论依据，同时在冒烟过程中发生的问题，也可以及时通知到对应的研发人员与测试人员进行改正。既保证了质量，又避免了人力空耗。</p>
</li>
</ul>
<h2 id="6-落地与实践"><a href="#6-落地与实践" class="headerlink" title="6. 落地与实践"></a><strong>6. 落地与实践</strong></h2><blockquote>
<p>外卖C端主要承担了用户在App端点餐、下单、配送的所有核心流程，场景繁多、业务复杂，这也给测试人员的版本测试带来了诸多挑战，其中最核心也最耗费人力的便是二轮回归测试环节。目前，C端采用的双周敏捷迭代的开发方式，每个迭代周期给测试人员用来进行二轮核心流程回归的时间为三天，为此C端测试团队投入了许多人力资源，但即便如此，仍难以覆盖全部流程；而AlphaTest的设计初衷也正是为解决此问题——UI测试流程全覆盖及自动化验证。</p>
</blockquote>
<h3 id="6-1-业务共建"><a href="#6-1-业务共建" class="headerlink" title="6.1 业务共建"></a><strong>6.1 业务共建</strong></h3><p><strong>用例的转化与维护</strong></p>
<p>AlphaTest 在外卖C端测试团队的落地初期，我们采用了共建的模式，也就是业务研发人员与对应测试人员共同来进行用例录制与维护的工作；推荐这种工作模式的核心原因是，在C端功能迭代流程中的二轮周期的原有工作模式为，研发人员进行二轮冒烟测试，完成测试之后提交二轮包交由测试人员进行二轮回归测试，所以这本来就是一个双方都需要参与的环节；而二轮测试作为版本上线前的最重要一个测试流程，保证核心流程的正常也是测试人员与研发人员所关心重点。</p>
<p>经过多轮的使用与磨合之后，这种模式被证明是行之有效的，在整个C端二轮用例的转化过程中，测试人员主要负责了用例的录制与迭代流程，研发人员则主要负责版本回放数据的统计及问题用例的发现与解决。</p>
<p><strong>外卖二轮落地情况</strong></p>
<p>目前，AlphaTest已经在外卖多个业务落地，支持了大于15个版本的二轮回归测试，用例覆盖率达到70%。现已 覆盖了Native、Mach、React Native、美团小程序、H5 技术栈的测试工作，能力上可进行支持： UI自动化测试、埋点自动化测试、动态化加载成功率自动化测试、无障碍适配率自动化测试。</p>
<p>未来，我们会朝着“智能化”和“精准化”两个方向探索，覆盖更多测试场景的同时，更进一步提升测试人效。</p>
<h3 id="6-2-实践效果"><a href="#6-2-实践效果" class="headerlink" title="6.2 实践效果"></a><strong>6.2 实践效果</strong></h3><p><img src="https://jbfhxmeaps.feishu.cn/space/api/box/stream/download/asynccode/?code=YmY2ODRkNzhjODcxYjgwYzZjZTRmZDkxOTcxYzJkZWFfUTBUbTZzcTFId1A3T2VGMnRpeW1uZTNVQ3dDbWpKUE1fVG9rZW46Ym94Y25nU1NmbmNKV3Zkb1dhOEhEUnhxOTI1XzE2Njg5Mzc4Njk6MTY2ODk0MTQ2OV9WNA" alt="img"></p>
<h1 id="7-参考资料"><a href="#7-参考资料" class="headerlink" title="7. 参考资料"></a><strong>7. 参考资料</strong></h1><p>[1] <strong><a target="_blank" rel="noopener" href="https://appium.io/">https://appium.io</a></strong></p>
<p>[2] <strong><a target="_blank" rel="noopener" href="http://docs.seleniumhq.org/projects/webdriver">http://docs.seleniumhq.org/projects/webdriver</a></strong></p>
<p>[3] <strong><a target="_blank" rel="noopener" href="http://airtest.netease.com/index.html">http://airtest.netease.com/index.html</a></strong></p>
<p>[4] <strong><a target="_blank" rel="noopener" href="https://github.com/alipay/SoloPi">https://github.com/alipay/SoloPi </a></strong></p>
<p>———- END ———-</p>
<p><strong>也许你还想看</strong></p>
<p><strong>|</strong>  <a target="_blank" rel="noopener" href="http://mp.weixin.qq.com/s?__biz=MjM5NjQ5MTI5OA==&mid=2651764420&idx=1&sn=392b2a0b187521aad5742cbfe7ca9452&chksm=bd126f898a65e69f6f56368c8dfd2e16dd0a987c3b0136d61205ae0e166a14fb0f3e21b70917&scene=21#wechat_redirect">Spock单元测试框架以及在美团优选的实践</a></p>
<p><strong>|</strong> <a target="_blank" rel="noopener" href="http://mp.weixin.qq.com/s?__biz=MjM5NjQ5MTI5OA==&mid=2651749742&idx=2&sn=52e37feddb076a2421993b9b4ad99739&chksm=bd12a4238a652d352ebacadf0d6aaf30e2291abe55dace7c04e48c1d824fda75a1dfef689b15&scene=21#wechat_redirect">美团智能支付稳定性测试实战</a></p>
<p><strong>|</strong> <a target="_blank" rel="noopener" href="http://mp.weixin.qq.com/s?__biz=MjM5NjQ5MTI5OA==&mid=2651747335&idx=1&sn=6ca3a91ecc31878b0249f8ae98594ab6&chksm=bd12ad4a8a65245cf74ee314aa8bfb8768ccb065910313a37f796abf202c18aa05240504d385&scene=21#wechat_redirect">Lego：美团接口自动化测试实践</a></p>
<p><strong>阅读更多</strong></p>
<p><a target="_blank" rel="noopener" href="http://mp.weixin.qq.com/s?__biz=MjM5NjQ5MTI5OA==&mid=2651765958&idx=1&sn=8201546812e5a95a2bee9dffc6d12f00&chksm=bd12658b8a65ec9de2f5be1e96796dfb3c8f1a374d4b7bd91266072f557caf8118d4ddb72b07&scene=21#wechat_redirect">前端 </a><strong>|</strong> <a target="_blank" rel="noopener" href="https://t.1yb.co/jo7v"> </a><a target="_blank" rel="noopener" href="http://mp.weixin.qq.com/s?__biz=MjM5NjQ5MTI5OA==&mid=2651765981&idx=1&sn=c2dd86f15dee2cbbc89e27677d985060&chksm=bd1265908a65ec86d4d08f7600d1518b61c90f6453074f9b308c96861c045712280a73751c73&scene=21#wechat_redirect">算法 </a><strong>|</strong> <a target="_blank" rel="noopener" href="http://mp.weixin.qq.com/s?__biz=MjM5NjQ5MTI5OA==&mid=2651765982&idx=1&sn=231b41f653ac7959f3e3b8213dcec2b0&chksm=bd1265938a65ec85630c546169444d56377bc2f11401d251da7ca50e5d07e353aa01580c7216&scene=21#wechat_redirect">后端 </a><strong>|</strong> <a target="_blank" rel="noopener" href="http://mp.weixin.qq.com/s?__biz=MjM5NjQ5MTI5OA==&mid=2651765964&idx=1&sn=ab6d8db147234fe57f27dd46eec40fef&chksm=bd1265818a65ec9749246dd1a2eb3bf7798772cc4d5b4283b15eae2f80bc6db63a1471a9e61e&scene=21#wechat_redirect">数据</a></p>
<p><a target="_blank" rel="noopener" href="http://mp.weixin.qq.com/s?__biz=MjM5NjQ5MTI5OA==&mid=2651765965&idx=1&sn=37e0c56c8b080146ce5249243bfd84d8&chksm=bd1265808a65ec96d3a2b2c87c6e27c910d49cb6b149970fb2db8bf88045a0a85fed2e6a0b84&scene=21#wechat_redirect">安全 </a><strong>|</strong> <a target="_blank" rel="noopener" href="http://mp.weixin.qq.com/s?__biz=MjM5NjQ5MTI5OA==&mid=2651765972&idx=1&sn=afe02ec92762c1ce18740d03324c4ac3&chksm=bd1265998a65ec8f10d5f58d0f3681ddfc5325137218e568e1cda3a50e427749edb5c6a7dcf5&scene=21#wechat_redirect">Android </a><strong>|</strong> <a target="_blank" rel="noopener" href="http://mp.weixin.qq.com/s?__biz=MjM5NjQ5MTI5OA==&mid=2651765973&idx=1&sn=32a23bf1d278dda0398f993ab60a697e&chksm=bd1265988a65ec8e630ef4d24b4946ab6bd7e66702c1d712481cf3c471468a059c470a14c30d&scene=21#wechat_redirect">iOS </a><strong>|</strong> <a target="_blank" rel="noopener" href="http://mp.weixin.qq.com/s?__biz=MjM5NjQ5MTI5OA==&mid=2651765963&idx=1&sn=a3de9ef267d07d94118c1611776a4b28&chksm=bd1265868a65ec906592d25ad65f2a8516338d07ec3217059e6975fc131fc0107d66a8cd2612&scene=21#wechat_redirect">运维 </a><strong>|</strong> <a target="_blank" rel="noopener" href="http://mp.weixin.qq.com/s?__biz=MjM5NjQ5MTI5OA==&mid=2651765974&idx=1&sn=763c1e37d04acffd0142a2852ecfb000&chksm=bd12659b8a65ec8dfcfeb2028ef287fae7c38f134a665375ba420556ce5d2e4cf398147bd12e&scene=21#wechat_redirect">测试</a></p>

               -->
        </div>
        
    
    <div class="article-info article-info-index">
      
      

      <!-- 
    <div class="article-tag tagcloud">
        <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/java/" rel="tag">java</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E8%BD%AC%E8%BD%BD/" rel="tag">转载</a></li></ul>
    </div>
 -->


      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-Lombok注解-Data和-Builder冲突" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/75bc1ba6.html" class="article-date">
      <time datetime="2022-11-20T09:29:17.000Z" itemprop="datePublished">2022-11-20</time>
</a>


    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/75bc1ba6.html">Lombok注解@Data和@Builder冲突(转载)</a>
    </h1>
  

      </header>
      
    
        <div class="article-entry" itemprop="articleBody">
          
                
                            
                                  
                                  
                                  
                                  
                                  
                                  
                                  
                                  
                                  
                                  
                            
                                
                                <p><blockquote>
<p>🔗 原文链接： <a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/wRkQVpZzIX0EhlYZ6_sEAg">https://mp.weixin.qq.com/s/wRkQVpZz…</a></p>
</blockquote>
<p>
                              
                          
                    
              <!-- 
              
              <blockquote>
<p>🔗 原文链接： <a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/wRkQVpZzIX0EhlYZ6_sEAg">https://mp.weixin.qq.com/s/wRkQVpZz…</a></p>
</blockquote>
<blockquote>
<p>⏰ 剪存时间：2022-11-20 17:29:28 (UTC+8)</p>
</blockquote>
<blockquote>
<p>✂️ 本文档由 <a target="_blank" rel="noopener" href="https://www.feishu.cn/hc/zh-CN/articles/606278856233?from=in_ccm_clip_doc">飞书剪存 </a>一键生成</p>
</blockquote>
<p>方志朋 <em>2022-11-18 16:00 发表于 广东</em></p>
<p><strong>点击关注公众号，Java干货</strong> <strong>及时送达 👇</strong></p>
<p><img src="https://jbfhxmeaps.feishu.cn/space/api/box/stream/download/asynccode/?code=ZWQxZGU0MGY3MzQxNGQxMTQyZjNjNmVjZTI5NDE1MmZfNTlpcm43YWVOTmpkajlEdjE3M21FQUJ5SlFRRlNadm9fVG9rZW46Ym94Y25sbVJ4cVBNUEh5MTIyQmZaZ3JmOTdmXzE2Njg5MzY1OTA6MTY2ODk0MDE5MF9WNA" alt="img"></p>
<p>来源： juejin.cn/post/7103011031672176677</p>
<ul>
<li><p>问题背景</p>
</li>
<li><p>Lombok @Data和@Builder分别单独分析用法</p>
</li>
<li><p>解决方法</p>
<ul>
<li>方法一</li>
<li>方法二</li>
</ul>
</li>
<li><p>Lombok原理</p>
</li>
<li><p>总结 </p>
</li>
</ul>
<h2 id="问题背景"><a href="#问题背景" class="headerlink" title="问题背景"></a><strong>问题背景</strong></h2><p>Lombok使⽤ 同时使⽤@Data和@Builder ，构建无参构造器报错！编译不通过。如下图：</p>
<p><img src="https://jbfhxmeaps.feishu.cn/space/api/box/stream/download/asynccode/?code=YmZmYjg3NGYzY2M0ODBiNWEzNjdhOTZiNWNhYjBhODNfb3loTjRXRld1VTZhVmZYcVIxdU9VQ05qVTFwYVJNaFNfVG9rZW46Ym94Y245UnBlRnZNNUdsOElEdGhSSUF2OHRlXzE2Njg5MzY1OTA6MTY2ODk0MDE5MF9WNA" alt="img"></p>
<p>图片</p>
<h2 id="Lombok-Data和-Builder分别单独分析用法"><a href="#Lombok-Data和-Builder分别单独分析用法" class="headerlink" title="Lombok @Data和@Builder分别单独分析用法"></a><strong>Lombok @Data和@Builder分别单独分析用法</strong></h2><p>Lombok使⽤@Data可以⽣成⽆参构造和类⾥⾯所有属性的getter/setter⽅法。可以简化我们代码的开发。（需要安装Lombok插件和引⼊Lombok依赖）。</p>
<p>例如下⾯的⼀个实体类,引⼊Lombok后，可以⾃动⽣成GET/SET⽅法和⽆参构造函数。</p>
<p><img src="https://jbfhxmeaps.feishu.cn/space/api/box/stream/download/asynccode/?code=ZDYxNTk3MWM4NjNiMGIzMjMwOTdjMjZlMzIzMDliNGNfaFhlNTJmeUtvTnc5eGE4Z0JzTDVLWFpEU3VBYjJLa0ZfVG9rZW46Ym94Y256enJOWnJjQll4OWthV29pZHA5YXBnXzE2Njg5MzY1OTA6MTY2ODk0MDE5MF9WNA" alt="img"></p>
<p> 编译后的class为:可以看到不仅帮我们生成了get和set ，同时也有默认的无参构造器</p>
<p><img src="https://jbfhxmeaps.feishu.cn/space/api/box/stream/download/asynccode/?code=MTY3YmIwZjI2YmRmNzAyZTBmNDhlZDRjNTYxMWMwNGRfMUJCSHRYakFhZGE3SWs5ZDZaYUtXenJrQzlNZnhnMUJfVG9rZW46Ym94Y25NTFdRejU2eUR3WURXVzFtM0RRNmZoXzE2Njg5MzY1OTA6MTY2ODk0MDE5MF9WNA" alt="img"></p>
<p>图片</p>
<p>那么怎么自动生成有参构造器呢？使用@Builder注解，将会帮助我们⽣成全属性的构造⽅法。</p>
<p><img src="https://jbfhxmeaps.feishu.cn/space/api/box/stream/download/asynccode/?code=NjM2NWEzZjliYWQwYzI2NjA1OGNiZTY2MGUzZGQxOGZfRldlMzh5WHJMbTBWVHlRR1ZsclUxVzJoZHE3T1Z4TUVfVG9rZW46Ym94Y25NRTMxN0hYbzhDY0tLNFdDQktPNXpLXzE2Njg5MzY1OTA6MTY2ODk0MDE5MF9WNA" alt="img"></p>
<p>图片</p>
<p>编译后的class为：可以看到 已经帮我们构建好了全属性的构造方法，但是如果值只引用@Builder注解是无法生成get和set的。</p>
<p><img src="https://jbfhxmeaps.feishu.cn/space/api/box/stream/download/asynccode/?code=YjQ5OGQzZmQxODU4MGU1MmFjNDhjMDdkNDI3MGZiNWNfTjhoTjJoS0pFdk9PdjBtcUkwd0RIdVhjTnZKTmNJY2NfVG9rZW46Ym94Y25EOHp6ZXY4TXhIZUQ4cFZtczRJSFFoXzE2Njg5MzY1OTA6MTY2ODk0MDE5MF9WNA" alt="img"></p>
<p>图片</p>
<p>但是如果同时使⽤@Data和@Builder的话，可以看出尽管⽣成了GET/SET⽅法，但是⽆参构造⽅法没有了，这显然是不能接受的，因为很多框架都会调⽤⽆参构造去创建对象。</p>
<p><img src="https://jbfhxmeaps.feishu.cn/space/api/box/stream/download/asynccode/?code=MTQ4NTI4Y2IwMzVjNzE4NDdjYzQxYjNlNzA1NzBlMTNfRlQ1VDZmSEJPOTY2NUlhMlp6Q1NrbTkwTnJFYnhaZ2xfVG9rZW46Ym94Y25SZ21KUXoydllhRHdobjVwWFM5MTFkXzE2Njg5MzY1OTA6MTY2ODk0MDE5MF9WNA" alt="img"></p>
<p>图片</p>
<p>编译后的class：</p>
<p><img src="https://jbfhxmeaps.feishu.cn/space/api/box/stream/download/asynccode/?code=ZTY5YTlkZTQwM2JjYTBlMzQwNzhmMzYzYWQ3YjU0ZTNfWFJqMGlzYzJjamUxQ21PNTRpaUtFQkZlZDI0UDBNbGZfVG9rZW46Ym94Y25WcGNDZFBTcVRVQkJMS1RLczZxVWliXzE2Njg5MzY1OTA6MTY2ODk0MDE5MF9WNA" alt="img"></p>
<p>我们尝试在Tet1类，⼿动添加⽆参构造⽅法。编译发现报错不通过：</p>
<p><img src="https://jbfhxmeaps.feishu.cn/space/api/box/stream/download/asynccode/?code=YWQ0ZThlMjRiNjlkZjcxODQ4ODFjZjA1YzE3YzIwNGRfSE1YTWxJWmFSOVQ2SkYzenp2QmdkSUNPOUtCMmRTU29fVG9rZW46Ym94Y25PYnZLaGg3WGYzQWJzUHRFRTJlM3diXzE2Njg5MzY1OTA6MTY2ODk0MDE5MF9WNA" alt="img"></p>
<p>图片</p>
<h2 id="解决方法"><a href="#解决方法" class="headerlink" title="解决方法"></a><strong>解决方法</strong></h2><h3 id="方法一"><a href="#方法一" class="headerlink" title="方法一"></a><strong>方法一</strong></h3><p>Lombok同时使⽤@Data和@Builder的时候，如果要⽣成⽆参构造，需要在代码⾥⾯⼿动引⼊注解@Tolerate，让Lombok在⽣成类的时候，对指定的构造函数不感知。</p>
<p><img src="https://jbfhxmeaps.feishu.cn/space/api/box/stream/download/asynccode/?code=MjIwZTg1YWI3NWNhMzFjMjI4OWVmZmVkYTc5OGY0MWZfMWRMcHZGcFloeDEycGdqbDVIMDBvbzlGWGRDZm5JQTZfVG9rZW46Ym94Y25rTkxRRTFXVkZvQjcycVl1cmNMR2djXzE2Njg5MzY1OTA6MTY2ODk0MDE5MF9WNA" alt="img"></p>
<p>图片</p>
<h3 id="方法二"><a href="#方法二" class="headerlink" title="方法二"></a><strong>方法二</strong></h3><p>直接使用无参构造器+有参构造器的方式，@RequiredArgsConstructor 来构建有参，@NoArgsConstructor来构建无参构造器，如图所示：</p>
<p><img src="https://jbfhxmeaps.feishu.cn/space/api/box/stream/download/asynccode/?code=YmJjZmQ4YWJlNjc5NjZiYWUwNzllNWFiNDg2MmJhZmFfT2lubWJtbnZnWnpMYmpFcXRMcE1jZkIyUm13MGtya1dfVG9rZW46Ym94Y25QZjVXclRjMTEyUm0yS2RjMVM5bERjXzE2Njg5MzY1OTA6MTY2ODk0MDE5MF9WNA" alt="img"></p>
<p>编 译后效果：</p>
<p><img src="https://jbfhxmeaps.feishu.cn/space/api/box/stream/download/asynccode/?code=MTYwNDUwNmVmODg3NTUyMjZmZjAzODk3MjM2MDBmZDhfb2hLTlgxWHB0eGNqRGZDT2M4NWlNN3NNeHNHSlpKdFNfVG9rZW46Ym94Y25QV28xT1p4YUUxRGdEUjlyaThad3ZEXzE2Njg5MzY1OTA6MTY2ODk0MDE5MF9WNA" alt="img"></p>
<p>图片</p>
<h2 id="Lombok原理"><a href="#Lombok原理" class="headerlink" title="Lombok原理"></a><strong>Lombok原理</strong></h2><p>Java的编译分为以下⼏个阶段：</p>
<p>解析与填充符号表-&gt;注解处理-&gt;分析与字节码⽣成-&gt;⽣成⼆进制class⽂件。</p>
<ul>
<li><p>Lombok 使⽤的是 JDK 6 实现的 JSR 269: Pluggable Annotation Processing API (编译期的注解处理器)，它是在编译期时把 Lombok 的注解代码，转换为常规的 Java ⽅法⽽实现注⼊。</p>
</li>
<li><p>在编译期阶段，当 Java 源码被抽象成语法树 (AST) 之后，Lombok 会根据⾃⼰的注解处理器动态的修改AST，增加新的代码 (节点)，在这⼀切执⾏之后，再通过分析⽣成了最终的字节码 (.class) ⽂件，这就是Lombok 的执⾏原理。</p>
</li>
</ul>
<p>可以借助注解处理器实现⼀个简单的 Setter，我们的实现步骤是:</p>
<ul>
<li><p>⾃定义⼀个注解标签接⼝，并实现⼀个⾃定义的注解处理器；</p>
</li>
<li><p>利⽤ tools.jar 的 javac api 处理 AST (抽象语法树)3. 使⽤⾃定义的注解处理器编译代码。</p>
</li>
</ul>
<p>1.定义⾃定义注解和注解处理器</p>
<p>⾸先创建⼀个 MySetter.java ⾃定义⼀个注解，代码如下：</p>
<p><img src="https://jbfhxmeaps.feishu.cn/space/api/box/stream/download/asynccode/?code=ZWQ2Mjg2NzlhYjQyMWQyNGJjYjY3ODNkMzFiMDAwYzZfOFBFU2ZGdGVxak0zWXBROUp2eE5PNUhxTU5mMk1aY1pfVG9rZW46Ym94Y256Yklxb0xuNXQ4RFpPNmpXN2VQY0NiXzE2Njg5MzY1OTA6MTY2ODk0MDE5MF9WNA" alt="img"></p>
<p>图片</p>
<p>再实现⼀个⾃定义的注解处理器，代码如下：</p>
<p><img src="https://jbfhxmeaps.feishu.cn/space/api/box/stream/download/asynccode/?code=MGQwYzdlYTFmZDcwYmFjOWYwOGFiMTkzMzg3NGRiZDhfa3F1YzdCbTVoaHo0Q2RVMnRteWNvYkRoSXAzWUUwcEJfVG9rZW46Ym94Y256Mk1wSEhOd2JWdUU1aXVsclRWT2dkXzE2Njg5MzY1OTA6MTY2ODk0MDE5MF9WNA" alt="img"></p>
<p>图片</p>
<p><img src="https://jbfhxmeaps.feishu.cn/space/api/box/stream/download/asynccode/?code=NjRjNzI4NTFiZTUyYWFlMDU1YjdkZDlkZWEzZWIyYjJfSUhDQURTZzZ1RHBGZjlMQnAyZ01mZUNJRTluTFBHS0dfVG9rZW46Ym94Y254Z3NqeUdjV3JmZno2a3JmcVlFMkhkXzE2Njg5MzY1OTA6MTY2ODk0MDE5MF9WNA" alt="img"></p>
<p>图片</p>
<p><img src="https://jbfhxmeaps.feishu.cn/space/api/box/stream/download/asynccode/?code=NTUzNTUzNzlkNjUwMjI5YTNjZGYxOGQ4MzIxMDdiMTVfazFKZ3ZQUlNzVjRnZnFZMzhYdnpjelc0eWZFaGh0VlVfVG9rZW46Ym94Y25IeHo1V1ppUHV3SlltVzA1RUp5VnZkXzE2Njg5MzY1OTA6MTY2ODk0MDE5MF9WNA" alt="img"></p>
<p>图片</p>
<p>测试类如下:</p>
<p><img src="https://jbfhxmeaps.feishu.cn/space/api/box/stream/download/asynccode/?code=OTI5NDE5N2QzNDE5YjU2OWVjY2RhNjU1ZWJlZmE2ZmFfMXR3bEl6QzRnMk95QWxvV3ZHUVJuR2pLeW9uNTVwQkxfVG9rZW46Ym94Y252bXpXR3RwQUhTaTBaOG9RaEZTYVZkXzE2Njg5MzY1OTA6MTY2ODk0MDE5MF9WNA" alt="img"></p>
<p>图片</p>
<p>2.对注解处理器进⾏编译，随后使⽤注解处理器对类进⾏编译</p>
<p>⾸先需要先对注解处理器进⾏编译（javac -cp ⽤于引⼊第三⽅jar包进⾏编译）</p>
<p><img src="https://jbfhxmeaps.feishu.cn/space/api/box/stream/download/asynccode/?code=MGFjYzJiZDcwMTU0MjUwODhiOGJjYTRhODk3NzFjMDFfWnBxQ3E3TFgySTFDZTkyZTJrRWpva1RPVnozVG1IZExfVG9rZW46Ym94Y254TEJzQ0tUOU1lVmh5enVTY3BISGJnXzE2Njg5MzY1OTA6MTY2ODk0MDE5MF9WNA" alt="img"></p>
<p>图片</p>
<p>然后使⽤注解处理器对这个Person测试类进⾏编译:</p>
<p>这时候再看⽣成的Person.class，可以发现Setter⽅法已经⽣成了:</p>
<p><img src="https://jbfhxmeaps.feishu.cn/space/api/box/stream/download/asynccode/?code=ODQ2NzMxZTAyZWUwMmI2OTdkMGQ5ZTIyOGJhMmMxYmRfSUJGbUtuaFZZa1RHZGg3c2lSc0t1V3RCcDA2UXBtOFpfVG9rZW46Ym94Y25BQUk1c1VrMTlhSzV1NTdmZ2ZpUHhjXzE2Njg5MzY1OTA6MTY2ODk0MDE5MF9WNA" alt="img"></p>
<p>图片</p>
<p><img src="https://jbfhxmeaps.feishu.cn/space/api/box/stream/download/asynccode/?code=MjI3MGY4YzNkNmVlMmRhYzAyOTVmZDY3ZDFiMDc1ODZfWEtaNnFBcWt0b1RHUGpaa1pYVnRkM2M5bFhrS2R2R1ZfVG9rZW46Ym94Y250ck10TWdtMllhelpqTGZKZ0xsc1ViXzE2Njg5MzY1OTA6MTY2ODk0MDE5MF9WNA" alt="img"></p>
<p>图片</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a><strong>总结</strong></h2><p>当然尽管测试类已经⽣成Setter⽅法，但是因为是在编译时期⽣成的，因此我们在开发的时候是没法直接调⽤Setter⽅法的，因此Lombok提供了插件机制，⽅便我们在开发的时候可以直接去调⽤Lombok的特性。</p>
<p>热门内容：</p>
<ul>
<li><p><a target="_blank" rel="noopener" href="http://mp.weixin.qq.com/s?__biz=MzAxNjk4ODE4OQ==&mid=2247534179&idx=1&sn=819e79794b5796daacc74ed2d15ebf41&chksm=9bee6711ac99ee072e48d6d23b2f9af81527bf5e005afaef7e8cd575b65a95d2aea8fa07401e&scene=21#wechat_redirect">业务开发时，接口不能对外暴露怎么办？</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="http://mp.weixin.qq.com/s?__biz=MzAxNjk4ODE4OQ==&mid=2247534166&idx=1&sn=14a69bf61866ffc02c4eef6e91b4b257&chksm=9bee6724ac99ee327e825fc7df6fa5826e648dfe92a90730b7695a2f92f03ea91701bc0d8cf0&scene=21#wechat_redirect">我，40岁码农，还在荷兰写低级代码，不敢回国…</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="http://mp.weixin.qq.com/s?__biz=MzAxNjk4ODE4OQ==&mid=2247534160&idx=1&sn=2d4fcb36152cff3758839c5888c02112&chksm=9bee6722ac99ee34fdb054d330d39ed60511afa9c21c82b260bbe5117268248d8f014b84dd7e&scene=21#wechat_redirect">面试官问：select……for update会锁表还是锁行？</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="http://mp.weixin.qq.com/s?__biz=MzAxNjk4ODE4OQ==&mid=2247534154&idx=1&sn=05480a5a789a99dec01d5c0bfbf77669&chksm=9bee6738ac99ee2e43d1647eca233b4e86616e8526a36e5397436b179c8bc333ce708c2938d2&scene=21#wechat_redirect">就加了一行log日志，结果引发了 P1 线上事故…</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="http://mp.weixin.qq.com/s?__biz=MzAxNjk4ODE4OQ==&mid=2247534148&idx=1&sn=a081b14bf90d5c7ac0bf85d541407073&chksm=9bee6736ac99ee20c4a9a27ff634a3902ba5a77ddb10a63330cc01718430f0bb2bb2726d654a&scene=21#wechat_redirect">别用XShell了，这款SSH工具绝对惊艳，还支持网页版…..</a></p>
</li>
<li></li>
</ul>
<p>最近面试BAT，整理一份面试资料《<strong>Java面试BAT通关手册</strong>》，覆盖了Java核心技术、JVM、Java并发、SSM、微服务、数据库、数据结构等等。</p>
<p>获取方式：点“在看”，关注公众号并回复 666 领取，更多内容陆续奉上。</p>
<p><strong>明天见(｡･ω･｡)</strong></p>

               -->
        </div>
        
    
    <div class="article-info article-info-index">
      
      

      <!-- 
    <div class="article-tag tagcloud">
        <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/java/" rel="tag">java</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E8%BD%AC%E8%BD%BD/" rel="tag">转载</a></li></ul>
    </div>
 -->


      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-integrate-saml" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/ae50aff9.html" class="article-date">
      <time datetime="2022-11-14T09:56:50.000Z" itemprop="datePublished">2022-11-14</time>
</a>


    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/ae50aff9.html">integrate_saml</a>
    </h1>
  

      </header>
      
    
        <div class="article-entry" itemprop="articleBody">
          
                
                            
                                  
                                  
                                  
                                  
                                  
                                  
                                  
                                  
                                  
                                  
                            
                                
                                <p><p><a target="_blank" rel="noopener" href="https://medium.com/digital-software-architecture/spring-boot-spring-security-with-saml-2-83d87df5b470">Spring Boot + Spring Security with SAML 2.0 | Digital Software Architecture</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/okta/okta-sdk-java/tree/master/integration-tests">okta-sdk-java/integration-tests at master · okta/okta-sdk-java</a></p>
<p><a target="_blank" rel="noopener" href="https://developer.okta.com/docs/concepts/redirect-vs-embedded/#:~:text=Okta%20deployment%20models%20%E2%80%94%20redirect%20vs.%20embedded">Okta deployment models — redirect vs. embedded</a></p>
<p>
                              
                          
                    
              <!-- 
              
              <p><a target="_blank" rel="noopener" href="https://medium.com/digital-software-architecture/spring-boot-spring-security-with-saml-2-83d87df5b470">Spring Boot + Spring Security with SAML 2.0 | Digital Software Architecture</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/okta/okta-sdk-java/tree/master/integration-tests">okta-sdk-java/integration-tests at master · okta/okta-sdk-java</a></p>
<p><a target="_blank" rel="noopener" href="https://developer.okta.com/docs/concepts/redirect-vs-embedded/#:~:text=Okta%20deployment%20models%20%E2%80%94%20redirect%20vs.%20embedded">Okta deployment models — redirect vs. embedded</a></p>
<p><img src="../img/image-20221114175806875.png" alt="image-20221114175806875"></p>
<p><img src="../img/image-20221114175729566.png" alt="image-20221114175729566"></p>
<p><img src="../img/image-20221114205002949.png" alt="image-20221114205002949"></p>
<p><a target="_blank" rel="noopener" href="https://www.securew2.com/blog/oauth-vs-openid-which-is-better#:~:text=OpenID%20vs.,accounts%20that%20you%20already%20have.">OAuth Vs. OpenID? Which is better?</a></p>

               -->
        </div>
        
    
    <div class="article-info article-info-index">
      
      

      <!--  -->


      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-2022个人博客网站搭建" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/df34252.html" class="article-date">
      <time datetime="2022-11-09T13:21:04.000Z" itemprop="datePublished">2022-11-09</time>
</a>


    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/df34252.html">2022个人博客网站搭建</a>
    </h1>
  

      </header>
      
    
        <div class="article-entry" itemprop="articleBody">
          
                
                            
                                  
                                  
                                  
                                  
                                  
                                  
                                  
                                  
                                  
                                  
                            
                                
                                <p><p><a target="_blank" rel="noopener" href="https://www.reaktor.com/blog/how-to-deal-with-life-after-heroku/">Life after Heroku: What’s a dev to do? - Reaktor</a></p>
<ul>
<li><p>Fly.io 让您可以部署 Docker 映像，还支持免费设置 PostgreSQL 数据库。他们的免费套餐包括 256MB RAM 和 3GB 持久存储，没有休眠的测功机——这比 Heroku 的要好。虽然你很可能需要一个 Dockerfile，但这并不难，而且学习 Docker 是你未来项目的一项很好的可转移技能。此外，作为一个巨大的奖励，每个组织都定义了免费层级，因此您可以为每个项目拥有单独的免费层级配额！他们基于 Web 的工具以及 CLI 都很好用。</p>
<p>
                              
                          
                    
              <!-- 
              
              <p><a target="_blank" rel="noopener" href="https://www.reaktor.com/blog/how-to-deal-with-life-after-heroku/">Life after Heroku: What’s a dev to do? - Reaktor</a></p>
<ul>
<li><p>Fly.io 让您可以部署 Docker 映像，还支持免费设置 PostgreSQL 数据库。他们的免费套餐包括 256MB RAM 和 3GB 持久存储，没有休眠的测功机——这比 Heroku 的要好。虽然你很可能需要一个 Dockerfile，但这并不难，而且学习 Docker 是你未来项目的一项很好的可转移技能。此外，作为一个巨大的奖励，每个组织都定义了免费层级，因此您可以为每个项目拥有单独的免费层级配额！他们基于 Web 的工具以及 CLI 都很好用。</p>
</li>
<li><p>Vercel 和 Netlify 都允许您部署静态站点和 lambda 函数，其中 Vercel 专门为部署 Next.js 应用程序（来自同一家公司的 React 框架）量身定制。除了慷慨的免费套餐外，Vercel 还拥有非常好的用户体验。作为顶部的樱桃，两者都自动为 Github 上的每个 Pull Request 构建一个预览站点。</p>
</li>
<li><p>Render 有一个类似于 Heroku 历史上的免费层：512MB RAM；服务在 15 分钟不活动后停止，这意味着冷启动延迟；您帐户中所有免费 Web 服务的每月最长运行时间为 750 小时（一个月大约有这么多小时）；静态网站是免费的。</p>
</li>
<li><p>GitHub Pages 和 Actions 也是静态站点的流行选项。</p>
</li>
<li><p>Heroku 可能仍然是您的首选。爱好 dynos 每月 7 美元，您可以升级并保持您的项目在原处并不间断地运行（除了您的钱包）。当然也可以使用更高的等级。</p>
</li>
</ul>
<p>我之前用过Github Pages,Coding的相关博客搭建现在要么不提供服务,要么被墙,看到现在还支持的服务就上述几个,我目前使用的是vervel还算稳定.</p>

               -->
        </div>
        
    
    <div class="article-info article-info-index">
      
      

      <!--  -->


      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-jackson-redis-集成" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/ef9a1729.html" class="article-date">
      <time datetime="2022-11-08T13:50:38.000Z" itemprop="datePublished">2022-11-08</time>
</a>


    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/ef9a1729.html">jackson-redis-集成</a>
    </h1>
  

      </header>
      
    
        <div class="article-entry" itemprop="articleBody">
          
                
                            
                                  
                                  
                                  
                                  
                                  
                                  
                                  
                                  
                                  
                                  
                            
                                
                                <p><p><a target="_blank" rel="noopener" href="https://reflectoring.io/jackson/">All You Need To Know About JSON Parsing With Jackson</a></p>
<p>对应spring 集成redis来实现,需要主要在序列化 对象过程中,如果使用Jackson来序列化需要注意Jackson相关的配置.目前就先补充这么多</p>
<p>下面是摘录官网的文章来大概展示然后集成最后会补充注意事项 <a target="_blank" rel="noopener" href="https://juejin.cn/post/6844904094545477640">Introduction to Spring Data Redis | Baeldung , Spring Data Redis 最佳实践！ - 掘金</a></p>
<p>
                              
                          
                    
              <!-- 
              
              <p><a target="_blank" rel="noopener" href="https://reflectoring.io/jackson/">All You Need To Know About JSON Parsing With Jackson</a></p>
<p>对应spring 集成redis来实现,需要主要在序列化 对象过程中,如果使用Jackson来序列化需要注意Jackson相关的配置.目前就先补充这么多</p>
<p>下面是摘录官网的文章来大概展示然后集成最后会补充注意事项 <a target="_blank" rel="noopener" href="https://juejin.cn/post/6844904094545477640">Introduction to Spring Data Redis | Baeldung , Spring Data Redis 最佳实践！ - 掘金</a></p>
<h3 id="Spring-Cache-简介"><a href="#Spring-Cache-简介" class="headerlink" title="Spring Cache 简介"></a>Spring Cache 简介</h3><blockquote>
<p>当Spring Boot 结合Redis来作为缓存使用时，最简单的方式就是使用Spring Cache了，使用它我们无需知道Spring中对Redis的各种操作，仅仅通过它提供的@Cacheable 、@CachePut 、@CacheEvict 、@EnableCaching等注解就可以实现缓存功能。</p>
</blockquote>
<h3 id="常用注解"><a href="#常用注解" class="headerlink" title="常用注解"></a>常用注解</h3><h4 id="EnableCaching"><a href="#EnableCaching" class="headerlink" title="@EnableCaching"></a>@EnableCaching</h4><p>开启缓存功能，一般放在启动类上。</p>
<h4 id="Cacheable"><a href="#Cacheable" class="headerlink" title="@Cacheable"></a>@Cacheable</h4><p>使用该注解的方法当缓存存在时，会从缓存中获取数据而不执行方法，当缓存不存在时，会执行方法并把返回结果存入缓存中。<code>一般使用在查询方法上</code>，可以设置如下属性：</p>
<ul>
<li>value：缓存名称（必填），指定缓存的命名空间；</li>
<li>key：用于设置在命名空间中的缓存key值，可以使用SpEL表达式定义；</li>
<li>unless：条件符合则不缓存；</li>
<li>condition：条件符合则缓存。</li>
</ul>
<h4 id="CachePut"><a href="#CachePut" class="headerlink" title="@CachePut"></a>@CachePut</h4><p>使用该注解的方法每次执行时都会把返回结果存入缓存中。<code>一般使用在新增方法上</code>，可以设置如下属性：</p>
<ul>
<li>value：缓存名称（必填），指定缓存的命名空间；</li>
<li>key：用于设置在命名空间中的缓存key值，可以使用SpEL表达式定义；</li>
<li>unless：条件符合则不缓存；</li>
<li>condition：条件符合则缓存。</li>
</ul>
<h4 id="CacheEvict"><a href="#CacheEvict" class="headerlink" title="@CacheEvict"></a>@CacheEvict</h4><p>使用该注解的方法执行时会清空指定的缓存。<code>一般使用在更新或删除方法上</code>，可以设置如下属性：</p>
<ul>
<li>value：缓存名称（必填），指定缓存的命名空间；</li>
<li>key：用于设置在命名空间中的缓存key值，可以使用SpEL表达式定义；</li>
<li>condition：条件符合则缓存。</li>
</ul>
<h3 id="使用步骤"><a href="#使用步骤" class="headerlink" title="使用步骤"></a>使用步骤</h3><ul>
<li>在pom.xml中添加项目依赖：</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--redis依赖配置--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>

<ul>
<li>修改配置文件application.yml，添加Redis的连接配置；</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">redis:</span></span><br><span class="line">    <span class="attr">host:</span> <span class="number">192.168</span><span class="number">.6</span><span class="number">.139</span> <span class="comment"># Redis服务器地址</span></span><br><span class="line">    <span class="attr">database:</span> <span class="number">0</span> <span class="comment"># Redis数据库索引（默认为0）</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">6379</span> <span class="comment"># Redis服务器连接端口</span></span><br><span class="line">    <span class="attr">password:</span> <span class="comment"># Redis服务器连接密码（默认为空）</span></span><br><span class="line">    <span class="attr">timeout:</span> <span class="string">1000ms</span> <span class="comment"># 连接超时时间</span></span><br><span class="line"><span class="string">复制代码</span></span><br></pre></td></tr></table></figure>

<ul>
<li>在启动类上添加@EnableCaching注解启动缓存功能；</li>
</ul>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">@EnableCaching</span></span><br><span class="line"><span class="variable">@SpringBootApplication</span></span><br><span class="line">public class MallTinyApplication &#123;</span><br><span class="line"></span><br><span class="line">    <span class="selector-tag">public</span> <span class="selector-tag">static</span> <span class="selector-tag">void</span> <span class="selector-tag">main</span>(String[] args) &#123;</span><br><span class="line">        <span class="selector-tag">SpringApplication</span><span class="selector-class">.run</span>(MallTinyApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>

<ul>
<li>接下来在PmsBrandServiceImpl类中使用相关注解来实现缓存功能，可以发现我们获取品牌详情的方法中使用了@Cacheable注解，在修改和删除品牌的方法上使用了@CacheEvict注解；</li>
</ul>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * PmsBrandService实现类</span></span><br><span class="line"><span class="comment"> * Created by macro on 2019/4/19.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PmsBrandServiceImpl</span> <span class="title">implements</span> <span class="title">PmsBrandService</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> PmsBrandMapper brandMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@CacheEvict(value = RedisConfig.REDIS_KEY_DATABASE, key = <span class="meta-string">&quot;&#x27;pms:brand:&#x27;+#id&quot;</span>)</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> int update(<span class="built_in">Long</span> id, PmsBrand brand) &#123;</span><br><span class="line">        brand.setId(id);</span><br><span class="line">        <span class="keyword">return</span> brandMapper.updateByPrimaryKeySelective(brand);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@CacheEvict(value = RedisConfig.REDIS_KEY_DATABASE, key = <span class="meta-string">&quot;&#x27;pms:brand:&#x27;+#id&quot;</span>)</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> int delete(<span class="built_in">Long</span> id) &#123;</span><br><span class="line">        <span class="keyword">return</span> brandMapper.deleteByPrimaryKey(id);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Cacheable(value = RedisConfig.REDIS_KEY_DATABASE, key = <span class="meta-string">&quot;&#x27;pms:brand:&#x27;+#id&quot;</span>, unless = <span class="meta-string">&quot;#result==null&quot;</span>)</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> PmsBrand getItem(<span class="built_in">Long</span> id) &#123;</span><br><span class="line">        <span class="keyword">return</span> brandMapper.selectByPrimaryKey(id);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>配置Redisconfig类 </p>
<ul>
<li>我们可以通过给RedisTemplate设置JSON格式的序列化器，并通过配置RedisCacheConfiguration设置超时时间来实现以上需求，此时别忘了去除启动类上的@EnableCaching注解，具体配置类RedisConfig代码如下；</li>
</ul>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Redis配置类</span></span><br><span class="line"><span class="comment"> * Created by macro on 2020/3/2.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@EnableCaching</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RedisConfig</span> <span class="keyword">extends</span> <span class="title">CachingConfigurerSupport</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * redis数据库自定义key</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span>  <span class="keyword">static</span> final <span class="built_in">String</span> REDIS_KEY_DATABASE=<span class="string">&quot;mall&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> RedisTemplate&lt;<span class="built_in">String</span>, <span class="built_in">Object</span>&gt; <span class="function"><span class="title">redisTemplate</span>(<span class="params">RedisConnectionFactory redisConnectionFactory</span>)</span> &#123;</span><br><span class="line">        RedisSerializer&lt;<span class="built_in">Object</span>&gt; serializer = redisSerializer();</span><br><span class="line">        RedisTemplate&lt;<span class="built_in">String</span>, <span class="built_in">Object</span>&gt; redisTemplate = <span class="keyword">new</span> RedisTemplate&lt;&gt;();</span><br><span class="line">        redisTemplate.setConnectionFactory(redisConnectionFactory);</span><br><span class="line">        redisTemplate.setKeySerializer(<span class="keyword">new</span> StringRedisSerializer());</span><br><span class="line">        redisTemplate.setValueSerializer(serializer);</span><br><span class="line">        redisTemplate.setHashKeySerializer(<span class="keyword">new</span> StringRedisSerializer());</span><br><span class="line">        redisTemplate.setHashValueSerializer(serializer);</span><br><span class="line">        redisTemplate.afterPropertiesSet();</span><br><span class="line">        <span class="keyword">return</span> redisTemplate;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> RedisSerializer&lt;<span class="built_in">Object</span>&gt; <span class="function"><span class="title">redisSerializer</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="comment">//创建JSON序列化器</span></span><br><span class="line">        Jackson2JsonRedisSerializer&lt;<span class="built_in">Object</span>&gt; serializer = <span class="keyword">new</span> Jackson2JsonRedisSerializer&lt;&gt;(<span class="built_in">Object</span>.class);</span><br><span class="line">        ObjectMapper objectMapper = <span class="keyword">new</span> ObjectMapper();</span><br><span class="line">        objectMapper.setVisibility(PropertyAccessor.ALL, JsonAutoDetect.Visibility.ANY);</span><br><span class="line">        objectMapper.enableDefaultTyping(ObjectMapper.DefaultTyping.NON_FINAL);</span><br><span class="line">        serializer.setObjectMapper(objectMapper);</span><br><span class="line">        <span class="keyword">return</span> serializer;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> RedisCacheManager <span class="function"><span class="title">redisCacheManager</span>(<span class="params">RedisConnectionFactory redisConnectionFactory</span>)</span> &#123;</span><br><span class="line">        RedisCacheWriter redisCacheWriter = RedisCacheWriter.nonLockingRedisCacheWriter(redisConnectionFactory);</span><br><span class="line">        <span class="comment">//设置Redis缓存有效期为1天</span></span><br><span class="line">        RedisCacheConfiguration redisCacheConfiguration = RedisCacheConfiguration.defaultCacheConfig()</span><br><span class="line">                .serializeValuesWith(RedisSerializationContext.SerializationPair.fromSerializer(redisSerializer())).entryTtl(Duration.ofDays(<span class="number">1</span>));</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> RedisCacheManager(redisCacheWriter, redisCacheConfiguration);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>

<ul>
<li>此时我们再次调用获取商品详情的接口进行测试，会发现Redis中已经缓存了标准的JSON格式数据，并且超时时间被设置为了1天。</li>
</ul>
<h3 id="Finaly重中之重就是-序列化要注意"><a href="#Finaly重中之重就是-序列化要注意" class="headerlink" title="Finaly重中之重就是 序列化要注意"></a>Finaly重中之重就是 序列化要注意</h3><p><img src="../img/image-20221109221426931.png" alt="image-20221109221426931"></p>
<p>作者：MacroZheng<br>链接：<a target="_blank" rel="noopener" href="https://juejin.cn/post/6844904094545477640">https://juejin.cn/post/6844904094545477640</a><br>来源：稀土掘金<br>著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。</p>

               -->
        </div>
        
    
    <div class="article-info article-info-index">
      
      

      <!-- 
    <div class="article-tag tagcloud">
        <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/java/" rel="tag">java</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E8%BD%AC%E8%BD%BD/" rel="tag">转载</a></li></ul>
    </div>
 -->


      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-mysql相关内容" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/f0e475b6.html" class="article-date">
      <time datetime="2022-11-01T09:19:36.000Z" itemprop="datePublished">2022-11-01</time>
</a>


    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/f0e475b6.html">mysql相关内容</a>
    </h1>
  

      </header>
      
    
        <div class="article-entry" itemprop="articleBody">
          
                
                            
                                  
                                  
                                  
                                  
                                  
                                  
                                  
                                  
                                  
                                  
                            
                                
                                <p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">SHOW DATABASES                                &#x2F;&#x2F;列出 MySQL Server 数据库。</span><br><span class="line">SHOW TABLES [FROM db_name]                    &#x2F;&#x2F;列出数据库数据表。</span><br><span class="line">SHOW CREATE TABLES tbl_name                    &#x2F;&#x2F;导出数据表结构。</span><br><span class="line">SHOW TABLE STATUS [FROM db_name]              &#x2F;&#x2F;列出数据表及表状态信息。</span><br><span class="line">SHOW COLUMNS FROM tbl_name [FROM db_name]     &#x2F;&#x2F;列出资料表字段</span><br><span class="line">SHOW FIELDS FROM tbl_name [FROM db_name]，DESCRIBE tbl_name [col_name]。</span><br><span class="line">SHOW FULL COLUMNS FROM tbl_name [FROM db_name]&#x2F;&#x2F;列出字段及详情</span><br><span class="line">SHOW FULL FIELDS FROM tbl_name [FROM db_name] &#x2F;&#x2F;列出字段完整属性</span><br><span class="line">SHOW INDEX FROM tbl_name [FROM db_name]       &#x2F;&#x2F;列出表索引。</span><br><span class="line">SHOW STATUS                                  &#x2F;&#x2F;列出 DB Server 状态。</span><br><span class="line">SHOW VARIABLES                               &#x2F;&#x2F;列出 MySQL 系统环境变量。</span><br><span class="line">SHOW PROCESSLIST                             &#x2F;&#x2F;列出执行命令。</span><br><span class="line">SHOW GRANTS FOR user                         &#x2F;&#x2F;列出某用户权限</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>
                              
                          
                    
              <!-- 
              
              <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">SHOW DATABASES                                &#x2F;&#x2F;列出 MySQL Server 数据库。</span><br><span class="line">SHOW TABLES [FROM db_name]                    &#x2F;&#x2F;列出数据库数据表。</span><br><span class="line">SHOW CREATE TABLES tbl_name                    &#x2F;&#x2F;导出数据表结构。</span><br><span class="line">SHOW TABLE STATUS [FROM db_name]              &#x2F;&#x2F;列出数据表及表状态信息。</span><br><span class="line">SHOW COLUMNS FROM tbl_name [FROM db_name]     &#x2F;&#x2F;列出资料表字段</span><br><span class="line">SHOW FIELDS FROM tbl_name [FROM db_name]，DESCRIBE tbl_name [col_name]。</span><br><span class="line">SHOW FULL COLUMNS FROM tbl_name [FROM db_name]&#x2F;&#x2F;列出字段及详情</span><br><span class="line">SHOW FULL FIELDS FROM tbl_name [FROM db_name] &#x2F;&#x2F;列出字段完整属性</span><br><span class="line">SHOW INDEX FROM tbl_name [FROM db_name]       &#x2F;&#x2F;列出表索引。</span><br><span class="line">SHOW STATUS                                  &#x2F;&#x2F;列出 DB Server 状态。</span><br><span class="line">SHOW VARIABLES                               &#x2F;&#x2F;列出 MySQL 系统环境变量。</span><br><span class="line">SHOW PROCESSLIST                             &#x2F;&#x2F;列出执行命令。</span><br><span class="line">SHOW GRANTS FOR user                         &#x2F;&#x2F;列出某用户权限</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">SHOW DATABASES </span><br><span class="line">SHOW TABLES FROM DB_NAME</span><br><span class="line"></span><br><span class="line">SHOW COLUMNS FROM </span><br><span class="line">select * from information_schema.columns where table_schema&#x3D;&#39;DB_NAME&#39;</span><br><span class="line"></span><br><span class="line">select table_name,column_name,collation_name,character_set_name from information_schema.columns where table_schema&#x3D;&#39;DB_NAME&#39; </span><br><span class="line">select table_name,column_name,column_name,collation_name,character_set_name from information_schema.columns where table_schema&#x3D;&#39;DB_NAME&#39; and column_name like &#39;%description&#39;</span><br><span class="line">select * from information_schema.columns where table_schema&#x3D;&#39;DB_NAME&#39; and column_name like &#39;%description&#39;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">select table_name,column_name,collation_name,character_set_name from information_schema.columns where table_schema&#x3D;&#39;DB_NAME&#39; and COLUMN_NAME like &#39;%a%&#39;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>查询逻辑和相关</p>
<h2 id="编码集"><a href="#编码集" class="headerlink" title="编码集"></a>编码集</h2>
               -->
        </div>
        
    
    <div class="article-info article-info-index">
      
      

      <!--  -->


      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-mysql索引和锁相关的整理" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2fd84806.html" class="article-date">
      <time datetime="2022-09-25T08:34:34.000Z" itemprop="datePublished">2022-09-25</time>
</a>


    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2fd84806.html">mysql索引和锁相关的整理</a>
    </h1>
  

      </header>
      
    
        <div class="article-entry" itemprop="articleBody">
          
                
                            
                                  
                                  
                                  
                                  
                                  
                                  
                                  
                                  
                                  
                                  
                            
                                
                                <p><p>ToDo</p>
<p><a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/5.7/en/innodb-transaction-isolation-levels.html">MySQL :: MySQL 5.7 Reference Manual :: 14.7.2.1 Transaction Isolation Levels</a></p>
<p>针对MySQL5,.7</p>
<p>
                              
                          
                    
              <!-- 
              
              <p>ToDo</p>
<p><a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/5.7/en/innodb-transaction-isolation-levels.html">MySQL :: MySQL 5.7 Reference Manual :: 14.7.2.1 Transaction Isolation Levels</a></p>
<p>针对MySQL5,.7</p>

               -->
        </div>
        
    
    <div class="article-info article-info-index">
      
      

      <!--  -->


      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-spring-data-jap入门和测试用例以及介绍" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/db9f3902.html" class="article-date">
      <time datetime="2022-09-25T02:46:15.000Z" itemprop="datePublished">2022-09-25</time>
</a>


    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/db9f3902.html">spring-data-jap入门和测试用例以及介绍</a>
    </h1>
  

      </header>
      
    
        <div class="article-entry" itemprop="articleBody">
          
                
                            
                                  
                                  
                                  
                                  
                                  
                                  
                                  
                                  
                                  
                                  
                            
                                
                                <p><h2 id="springJpa介绍"><a href="#springJpa介绍" class="headerlink" title="springJpa介绍"></a>springJpa介绍</h2><p>springjpa 是springdata下面的框架用来对接数据 是门面框架定义 数据交互到数据库,很多的接口规范使用的是 JPA规范 *<em>javax.persistence.**</em> ,我们选择内部实现为habernate ,具体的实现可以选择xxxx等,</p>
<p>下面是关于spring -orm的介绍<a target="_blank" rel="noopener" href="https://www.geeksforgeeks.org/spring-orm-framework/">Spring - ORM Framework - GeeksforGeeks</a></p>
<p><strong>Spring-ORM</strong> is a technique or a Design Pattern used to access a relational database from an object-oriented language. ORM (Object Relation Mapping) covers many persistence technologies. They are as follows:</p>
<p>
                              
                          
                    
              <!-- 
              
              <h2 id="springJpa介绍"><a href="#springJpa介绍" class="headerlink" title="springJpa介绍"></a>springJpa介绍</h2><p>springjpa 是springdata下面的框架用来对接数据 是门面框架定义 数据交互到数据库,很多的接口规范使用的是 JPA规范 *<em>javax.persistence.**</em> ,我们选择内部实现为habernate ,具体的实现可以选择xxxx等,</p>
<p>下面是关于spring -orm的介绍<a target="_blank" rel="noopener" href="https://www.geeksforgeeks.org/spring-orm-framework/">Spring - ORM Framework - GeeksforGeeks</a></p>
<p><strong>Spring-ORM</strong> is a technique or a Design Pattern used to access a relational database from an object-oriented language. ORM (Object Relation Mapping) covers many persistence technologies. They are as follows:</p>
<ul>
<li><strong>JPA(Java Persistence API):</strong> It is mainly used to persist data between Java objects and relational databases. It acts as a bridge between object-oriented domain models and relational database systems.</li>
<li><strong>JDO(Java Data Objects):</strong> It is one of the standard ways to access persistent data in databases, by using plain old Java objects (POJO) to represent persistent data.</li>
<li><strong>Hibernate –</strong> It is a Java framework that simplifies the development of Java applications to interact with the database.</li>
<li><strong>Oracle Toplink, and iBATIS:</strong> Oracle TopLink is a mapping and persistence framework for Java development.</li>
</ul>
<p>需要了解常用的注解</p>
<ul>
<li>支持基于 Spring 和 JPA 构建存储库</li>
<li>支持<a target="_blank" rel="noopener" href="http://www.querydsl.com/">Querydsl</a>谓词，因此支持类型安全的 JPA 查询</li>
<li>透明审计</li>
<li>分页支持、动态查询执行、集成自定义数据访问代码的能力</li>
<li><code>@Query</code>在引导时验证带注释的查询</li>
<li>支持基于 XML 的实体映射</li>
<li>通过引入基于 JavaConfig 的存储库配置<code>@EnableJpaRepositories</code></li>
</ul>
<h2 id="字段映射"><a href="#字段映射" class="headerlink" title="字段映射"></a>字段映射</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">@Table(name &#x3D; &quot;malfunction_report&quot;) &#x2F;&#x2F;标记表的名称</span><br><span class="line">@Entity：标识这是一个JPA的实体，当项目启动时会更具这个实体创建相应的表</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">@Id &#x2F;&#x2F;标记表的自增的ID</span><br><span class="line">@GeneratedValue</span><br><span class="line"></span><br><span class="line">@Column(name &#x3D; &quot;items&quot;)&#x2F;&#x2F;标记字段的对应的映射</span><br><span class="line">@Convert(converter &#x3D; JpaConverterListJson.class)&#x2F;&#x2F; 保存和查询时能解析为对应的变量</span><br><span class="line">@Enumerated(EnumType.STRING)&#x2F;&#x2F;对应枚举这种最后在数据库需要保存为你字符串</span><br></pre></td></tr></table></figure>



<h3 id="查询继承JpaRepository"><a href="#查询继承JpaRepository" class="headerlink" title="查询继承JpaRepository"></a>查询继承JpaRepository</h3><p>直接可以字段拼接一个简单的查询,在继承了JpaRepository后可以发现,</p>
<h3 id="注解query"><a href="#注解query" class="headerlink" title="注解query"></a>注解query</h3><p>使用注解可以使用jpa定义的hql来查询利用对象的映射关系,而且比较存在的ORM(<em>Object-Relational Mapping</em>)逻辑,同时如果部分字段需要调用特殊的函数也支持直接写SQL,需要在SQL后用逗号分割讲native设置为true</p>
<h3 id="查询继承JpaSpecificationExecutor的灵活查询"><a href="#查询继承JpaSpecificationExecutor的灵活查询" class="headerlink" title="查询继承JpaSpecificationExecutor的灵活查询"></a>查询继承JpaSpecificationExecutor的灵活查询</h3><p>org.springframework.data.jpa.domain.Specification 需要实现<strong>toPredicate</strong>这里需要多个学习多个对象</p>
<ul>
<li><p>Root<T> root</p>
<p>主要要使用</p>
</li>
<li><p>CriteriaQuery&lt;?&gt; query</p>
<p>criterialQuery ToDo</p>
</li>
<li><p>CriteriaBuilder criteriaBuilder</p>
<p>CriteriaBuilder todo</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">javax.persistence.criteria.Predicate</span><br><span class="line"></span><br><span class="line">javax.persistence.criteria.Expression</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>上述对象能最大程度实现灵活的查询,加上 org.springframework.data.domain.Page可以最大程度的满足查询的需要</p>
<h2 id="编辑和新增数据"><a href="#编辑和新增数据" class="headerlink" title="编辑和新增数据"></a>编辑和新增数据</h2><p>在自己实现的方法需要 @modify才会生效</p>
<p><a target="_blank" rel="noopener" href="https://github.com/pkainulainen/spring-data-jpa-examples/blob/master/tutorial-part-seven/src/test/java/net/petrikainulainen/spring/datajpa/repository/PersonSpecificationsTest.java">spring-data-jpa-examples/PersonSpecificationsTest.java at master · pkainulainen/spring-data-jpa-examples</a></p>
<p><a target="_blank" rel="noopener" href="https://www.petrikainulainen.net/programming/spring-framework/spring-data-jpa-tutorial-part-seven-pagination/">Spring Data JPA Tutorial: Pagination</a></p>
<p><a target="_blank" rel="noopener" href="https://www.baeldung.com/mockito-java-8">Mockito’s Java 8 Features | Baeldung</a></p>

               -->
        </div>
        
    
    <div class="article-info article-info-index">
      
      

      <!--  -->


      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
  
    <nav id="page-nav">
      <a class="extend prev" rel="prev" href="/page/7/"> 上一页</a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/6/">6</a><a class="page-number" href="/page/7/">7</a><span class="page-number current">8</span><a class="page-number" href="/page/9/">9</a><a class="page-number" href="/page/10/">10</a><span class="space">&hellip;</span><a class="page-number" href="/page/24/">24</a><a class="extend next" rel="next" href="/page/9/">下一页 </a>
    </nav>
  
</div>
      <footer id="footer">
    <div class="outer">
        <div id="footer-info">
            <div class="footer-left">
                <i class="fa fa-copyright"></i> 
                2016-2025 leek
            </div>
            <div class="footer-right">
                <a href="http://hexo.io/" target="_blank" title="快速、简洁且高效的博客框架">Hexo</a>  Theme <a href="https://github.com/MOxFIVE/hexo-theme-yelee" target="_blank" title="简而不减 Hexo 双栏博客主题  v3.5">Yelee</a> by leek <i class="fa fa-heart animated infinite pulse"></i>
            </div>
        </div>
        
            <div class="visit">
                
                    <span id="busuanzi_container_site_pv" style='display:none'>
                        <span id="site-visit" title="本站到访数"><i class="fa fa-user" aria-hidden="true"></i><span id="busuanzi_value_site_uv"></span>
                        </span>
                    </span>
                
                
                    <span>| </span>
                
                
                    <span id="busuanzi_container_page_pv" style='display:none'>
                        <span id="page-visit"  title="本页阅读量"><i class="fa fa-eye animated infinite pulse" aria-hidden="true"></i><span id="busuanzi_value_page_pv"></span>
                        </span>
                    </span>
                
            </div>
        
    </div>
</footer>
    </div>
    
<script data-main="/js/main.js" src="//lf6-cdn-tos.bytecdntp.com/cdn/require.js/2.2.0/require.min.js"></script>

    <script>
        $(document).ready(function() {
            var iPad = window.navigator.userAgent.indexOf('iPad');
            if (iPad > -1 || $(".left-col").css("display") === "none") {
                var bgColorList = ["#9db3f4", "#414141", "#e5a859", "#f5dfc6", "#c084a0", "#847e72", "#cd8390", "#996731"];
                var bgColor = Math.ceil(Math.random() * (bgColorList.length - 1));
                $("body").css({"background-color": bgColorList[bgColor], "background-size": "cover"});
            }
            else {
                var backgroundnum = 5;
                var backgroundimg = "url(/background/bg-x.jpg)".replace(/x/gi, Math.ceil(Math.random() * backgroundnum));
                $("body").css({"background": backgroundimg, "background-attachment": "fixed", "background-size": "cover"});
            }
        })
    </script>



<!-- Google Analytics -->
<script type="text/javascript">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-144246563-1', 'auto');
ga('send', 'pageview');

</script>
<!-- End Google Analytics -->



<div class="scroll" id="scroll">
    <a href="#" title="返回顶部"><i class="fa fa-arrow-up"></i></a>
    <a href="#comments" onclick="load$hide();" title="查看评论"><i class="fa fa-comments-o"></i></a>
    <a href="#footer" title="转到底部"><i class="fa fa-arrow-down"></i></a>
</div>
<script>
    // Open in New Window
    
        var oOpenInNew = {
            
            
            
             tags: ".article-tag a", 
             categories: ".article-category a, a.tag-list-link", 
            
            
            
            
             friends: "#js-friends a", 
             socail: ".social a" 
        }
        for (var x in oOpenInNew) {
            $(oOpenInNew[x]).attr("target", "_blank");
        }
    
</script>

    <script>
        var originTitle = document.title;
        var titleTime;
        document.addEventListener("visibilitychange", function() {
            if (document.hidden) {
                document.title = "(つェ⊂) 我藏好了哦~ " + originTitle;
                clearTimeout(titleTime);
            }
            else {
                document.title = "(*´∇｀*) 被你发现啦~ " + originTitle;
                titleTime = setTimeout(function() {
                    document.title = originTitle;
                }, 2000);
            }
        })
    </script>

<script async src="https://cdn.jsdelivr.net/gh/xaoxuu/cdn-busuanzi@2.3/js/busuanzi.pure.mini.js">
</script>
  </div>
</body>
</html>